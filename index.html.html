<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit OS | v19.5 Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style id="dynamic-styles">
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap');
        body { font-family: 'JetBrains Mono', monospace; transition: background 0.3s; margin: 0; direction: ltr; }
        .panel { border: 1px solid; padding: 20px; transition: 0.3s; background: rgba(0,0,0,0.2); }
        .habit-tag { padding: 4px 8px; margin: 2px; font-weight: 800; display: inline-flex; align-items: center; border-radius: 4px; }
        .tag-done { background: #064e3b; color: #34d399; }
        .tag-fail { background: #450a0a; color: #f87171; }
        .metric-cell { font-weight: 900; padding: 4px 10px; text-align: center; display: inline-block; border-radius: 4px; }
        input, textarea, select { background: rgba(255,255,255,0.05); border: 1px solid #444; color: inherit; padding: 10px; outline: none; }
        #settings-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
        .config-label { font-size: 10px; opacity: 0.6; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: block; color: #fff; }
        .log-s-val { color: #fb923c; font-size: 1.1em; margin-left: 6px; font-weight: 900; border-left: 1px solid rgba(251,146,60,0.3); padding-left: 6px; }
    </style>
</head>
<body id="main-body" class="bg-black text-white">

    <div id="settings-modal">
        <div class="panel w-full max-w-4xl bg-zinc-950 border-white p-6 lg:p-10 shadow-2xl">
            <h2 class="font-black mb-8 border-b border-zinc-800 pb-4 tracking-tighter text-2xl uppercase">System_Core_Calibration</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="space-y-4">
                    <p class="text-[10px] font-black text-blue-500 border-b border-blue-900 pb-1">CLOUD_SYNC</p>
                    <div><span class="config-label">Your Unique ID (Name)</span><input type="text" id="cfg-user-id" placeholder="e.g. Ali_01" class="w-full"></div>
                    <div><span class="config-label">Friend to Watch</span><input type="text" id="cfg-friend-id" placeholder="e.g. Omar_02" class="w-full"></div>
                </div>
                <div class="space-y-4">
                    <p class="text-[10px] font-black text-green-500 border-b border-green-900 pb-1">LOGIC_PARAMS</p>
                    <div><span class="config-label">Study Goal (Hrs)</span><input type="number" id="cfg-study"></div>
                    <div><span class="config-label">Phone Limit (Hrs)</span><input type="number" id="cfg-phone"></div>
                </div>
                <div class="space-y-4">
                    <p class="text-[10px] font-black text-purple-500 border-b border-purple-900 pb-1">VISUALS</p>
                    <div><span class="config-label">Accent Color</span><input type="color" id="cfg-accent-c"></div>
                    <div><span class="config-label">UI Radius</span><input type="number" id="cfg-radius"></div>
                </div>
            </div>
            <div class="flex gap-4 mt-10">
                <button onclick="saveSettings()" class="flex-grow bg-white text-black py-4 font-black uppercase tracking-widest hover:bg-zinc-200">Save & Sync</button>
                <button onclick="toggleSettings()" class="px-8 border border-zinc-700 font-black uppercase text-sm">Close</button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-4 lg:p-8">
        <div class="flex justify-between items-center mb-4 opacity-50 text-[10px] font-bold">
            <div id="user-display">LOCAL_MODE</div>
            <div id="friend-display">NO_WATCH_TARGET</div>
        </div>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8 text-center dash-area">
            <div class="panel"><p class="text-[9px] opacity-40 uppercase font-bold">Average</p><p id="m-score" class="val">0%</p></div>
            <div class="panel"><p class="text-[9px] opacity-40 uppercase font-bold">Streak</p><p id="c-streak" class="val">0</p></div>
            <div class="panel"><p class="text-[9px] opacity-40 uppercase font-bold">Record</p><p id="b-streak" class="val">0</p></div>
            <div class="panel"><p class="text-[9px] opacity-40 uppercase font-bold">Today</p><p id="t-score" class="val">0%</p></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="panel input-area space-y-6">
                <h3 class="text-center font-black tracking-widest opacity-50 text-xs border-b border-zinc-800 pb-2 uppercase">Input_Terminal</h3>
                <input type="hidden" id="edit-id" value="">
                <div id="habit-list" class="max-h-60 overflow-y-auto pr-2 space-y-2"></div>
                <div class="flex gap-2">
                    <input type="text" id="new-habit-name" placeholder="NEW_HABIT..." class="flex-grow text-xs">
                    <button onclick="addHabit()" class="bg-white text-black px-4 font-black">+</button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="config-label">Phone</label><input type="number" id="p-h" step="0.5" class="w-full text-center"></div>
                    <div><label class="config-label">Study</label><input type="number" id="s-h" step="0.5" class="w-full text-center"></div>
                </div>
                <textarea id="note" placeholder="NOTES..." class="w-full h-16 text-xs"></textarea>
                <button id="save-btn" onclick="saveData()" class="w-full py-4 bg-white text-black font-black uppercase tracking-tighter">Commit_to_Cloud</button>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="toggleSettings()" class="text-[9px] font-black border border-white/20 py-2">CORE_SETTINGS</button>
                    <button onclick="watchFriendSync()" class="text-[9px] font-black bg-blue-900/30 py-2">FETCH_FRIEND</button>
                </div>
            </div>

            <div class="panel lg:col-span-2 min-h-[400px]">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="panel mt-8 table-area overflow-x-auto border-zinc-800">
            <table class="w-full text-left border-collapse">
                <thead class="text-[10px] opacity-30 uppercase font-black border-b border-zinc-800">
                    <tr>
                        <th class="p-4">Date</th>
                        <th class="p-4 text-center">Score</th>
                        <th class="p-4 text-center">Study</th>
                        <th class="p-4 text-center">Phone</th>
                        <th class="p-4">Habits_Log</th>
                        <th class="p-4 text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="logs-body" class="divide-y divide-zinc-900"></tbody>
            </table>
        </div>
    </div>

<script>
    // --- 1. FIREBASE CONFIG (بياناتك اللي بعتها) ---
    const firebaseConfig = {
        apiKey: "AIzaSyASLT_wouo9BTjd-dH18x8CLbqBZSMbz04",
        authDomain: "ultra-core.firebaseapp.com",
        projectId: "ultra-core",
        storageBucket: "ultra-core.firebasestorage.app",
        messagingSenderId: "351766462712",
        appId: "1:351766462712:web:e683d8aa0d213b6e59fb0d",
        measurementId: "G-8RVTD75KCP"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. CORE STATE ---
    const STORAGE_KEY = 'HABIT_OS_STREAK_ORANGE_FINAL';
    const defaultConfig = {
        studyGoal: 6, maxPhone: 3, greenTh: 80, yellowTh: 55, wHabit: 70, wStudy: 15, wParam: 15,
        bgColor: '#000000', accentColor: '#ffffff', chartColor: '#ffffff',
        fDash: 24, fTable: 12, fHabit: 11, fInHabit: 11, fNote: 10, radius: 4, 
        userId: "", friendId: ""
    };

    let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
        habits: ["الفجر", "الظهر", "العصر", "المغرب", "العشاء", "العفة"],
        logs: [],
        config: defaultConfig
    };

    // --- 3. UI ENGINE ---
    function applyUI() {
        const c = state.config;
        document.getElementById('main-body').style.backgroundColor = c.bgColor;
        document.getElementById('main-body').style.color = c.accentColor;
        document.getElementById('user-display').innerText = c.userId ? `USER: ${c.userId}` : "MODE: LOCAL_ONLY";
        document.getElementById('friend-display').innerText = c.friendId ? `WATCHING: ${c.friendId}` : "WATCH: NONE";
        
        const style = document.getElementById('dynamic-styles');
        style.innerHTML += `
            .panel { border-radius: ${c.radius}px; border-color: ${c.accentColor}22; }
            .habit-tag { border-radius: ${c.radius}px; }
            input, textarea, select { border-radius: ${c.radius}px; }
        `;
    }

    const ctx = document.getElementById('mainChart').getContext('2d');
    let chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ data: [], borderColor: '#fff', borderWidth: 2, fill: false }] },
        options: { maintainAspectRatio: false, plugins: { legend: false }, scales: { y: { beginAtZero: true, max: 100 } } }
    });

    // --- 4. CLOUD SYNC LOGIC ---
    async function syncToCloud() {
        if (!state.config.userId) return;
        try {
            await db.collection("users").doc(state.config.userId).set({
                logs: state.logs,
                habits: state.habits,
                lastUpdate: Date.now()
            });
            console.log("Cloud Synced!");
        } catch (e) { console.error("Sync Failed", e); }
    }

    async function watchFriendSync() {
        const fId = state.config.friendId;
        if (!fId) return alert("حدد اسم الصديق في الإعدادات أولاً!");
        
        const doc = await db.collection("users").doc(fId).get();
        if (doc.exists) {
            const fData = doc.data();
            renderLogs(fData.logs, fData.habits); // نعرض بياناته هو
            alert(`تراقب الآن: ${fId}`);
        } else {
            alert("الصديق غير موجود أو لم يقم برفع بياناته.");
        }
    }

    // --- 5. APP FUNCTIONS ---
    function toggleSettings() {
        const m = document.getElementById('settings-modal');
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        if(m.style.display === 'flex') {
            document.getElementById('cfg-user-id').value = state.config.userId;
            document.getElementById('cfg-friend-id').value = state.config.friendId;
            document.getElementById('cfg-study').value = state.config.studyGoal;
            document.getElementById('cfg-phone').value = state.config.maxPhone;
            document.getElementById('cfg-accent-c').value = state.config.accentColor;
            document.getElementById('cfg-radius').value = state.config.radius;
        }
    }

    function saveSettings() {
        state.config.userId = document.getElementById('cfg-user-id').value.trim();
        state.config.friendId = document.getElementById('cfg-friend-id').value.trim();
        state.config.studyGoal = parseFloat(document.getElementById('cfg-study').value);
        state.config.maxPhone = parseFloat(document.getElementById('cfg-phone').value);
        state.config.accentColor = document.getElementById('cfg-accent-c').value;
        state.config.radius = parseInt(document.getElementById('cfg-radius').value);
        saveState();
        syncToCloud();
        location.reload();
    }

    function renderHabitInputs() {
        document.getElementById('habit-list').innerHTML = state.habits.map(h => `
            <div class="flex items-center justify-between bg-white/5 p-2 rounded">
                <label class="flex-grow flex justify-between items-center pr-2 cursor-pointer">
                    <span class="font-bold opacity-70 text-[11px]">${h}</span>
                    <input type="checkbox" class="h-task w-4 h-4 accent-white" data-n="${h}">
                </label>
                <button onclick="removeHabit('${h}')" class="text-red-900 ml-2">×</button>
            </div>`).join('');
    }

    function addHabit() {
        const n = document.getElementById('new-habit-name').value.trim();
        if(n && !state.habits.includes(n)) { state.habits.push(n); saveState(); renderHabitInputs(); }
    }

    function removeHabit(n) { if(confirm("حذف؟")) { state.habits = state.habits.filter(x => x !== n); saveState(); renderHabitInputs(); } }

    async function saveData() {
        const done = [];
        document.querySelectorAll('.h-task').forEach(t => { if(t.checked) done.push(t.dataset.n); });
        const study = parseFloat(document.getElementById('s-h').value) || 0;
        const phone = parseFloat(document.getElementById('p-h').value) || 0;
        const note = document.getElementById('note').value;
        const c = state.config;
        
        const score = Math.round(((done.length/state.habits.length)*c.wHabit) + Math.min((study/c.studyGoal)*c.wStudy, c.wStudy) + (phone<=c.maxPhone ? c.wParam : 0));

        state.logs.push({ 
            id: Date.now(), 
            dt: new Date().toLocaleDateString('en-GB',{day:'2-digit', month:'2-digit'}), 
            sc: score, dn: done, st: study, ph: phone, nt: note || "-" 
        });

        saveState();
        await syncToCloud(); // الرفع السحابي
        location.reload();
    }

    function renderLogs(logsToRender, habitsContext) {
        const container = document.getElementById('logs-body');
        container.innerHTML = [...logsToRender].reverse().map(l => `
            <tr>
                <td class="p-4 opacity-40">${l.dt}</td>
                <td class="p-4 text-center font-black" style="color:${l.sc > 70 ? '#22c55e' : '#ef4444'}">${l.sc}%</td>
                <td class="p-4 text-center"><span class="metric-cell">${l.st}h</span></td>
                <td class="p-4 text-center"><span class="metric-cell">${l.ph}h</span></td>
                <td class="p-4"><div class="flex flex-wrap">${l.dn.map(d => `<span class="habit-tag tag-done">${d}</span>`).join('')}</div></td>
                <td class="p-4 text-center opacity-20">---</td>
            </tr>`).join('');
            
        chart.data.labels = logsToRender.map(l => l.dt);
        chart.data.datasets[0].data = logsToRender.map(l => l.sc);
        chart.update();
    }

    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // Initial Run
    applyUI();
    renderHabitInputs();
    renderLogs(state.logs, state.habits);

</script>
</body>
</html>