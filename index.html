<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯Ø§ÙŠÙ…Ø§ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ù†Ø³Ù†Ø¯ ÙˆØ§Ù‡ÙŠ Ù…ÙˆØ§Ù‚ÙÙ†Ø§ Ø¨ØªØ«Ø¨Øª ğŸ“š</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc, onSnapshot, serverTimestamp, query, orderBy, addDoc, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyASLT_wouo9BTjd-dH18x8CLbqBZSMbz04",
    authDomain: "ultra-core.firebaseapp.com",
    projectId: "ultra-core",
    storageBucket: "ultra-core.firebasestorage.app",
    messagingSenderId: "351766462712",
    appId: "1:351766462712:web:e683d8aa0d213b6e59fb0d",
    measurementId: "G-8RVTD75KCP"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  let studyTimer = null;
  let studyStartTime = null;
  let studySeconds = 0;
  let isStudying = false;
  let todayData = {};
  let allUsersUnsub = null;
  let chatUnsub = null;
  let editingDate = null;

  const TODAY = () => new Date().toISOString().split('T')[0];

  // ===== AUTH =====
  window.googleSignIn = async () => {
    try {
      showLoading(true);
      await signInWithPopup(auth, provider);
    } catch(e) {
      showLoading(false);
      showToast('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø­Ø§ÙˆÙ„ ØªØ§Ù†ÙŠ ÙŠØ³Ø·Ø§!', 'error');
    }
  };

  window.googleSignOut = async () => {
    if (isStudying) await stopStudy();
    await updateUserStatus('offline');
    await signOut(auth);
  };

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await initUser(user);
      showApp();
      await loadTodayData();
      startRealtimeLeaderboard();
      startChat();
      await updateUserStatus('online');
      setInterval(() => {
        if (document.visibilityState !== 'hidden')
          updateUserStatus(isStudying ? 'studying' : 'online');
      }, 20000);
    } else {
      currentUser = null;
      showLogin();
      if (allUsersUnsub) allUsersUnsub();
    }
  });

  document.addEventListener('visibilitychange', () => {
    if (!currentUser) return;
    document.visibilityState === 'hidden'
      ? updateUserStatus('offline')
      : updateUserStatus(isStudying ? 'studying' : 'online');
  });
  window.addEventListener('pagehide',     () => updateUserStatus('offline'));
  window.addEventListener('beforeunload', () => updateUserStatus('offline'));

  async function initUser(user) {
    const ref = doc(db, 'users', user.uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, { uid: user.uid, name: user.displayName, photo: user.photoURL, status: 'online', lastSeen: serverTimestamp(), createdAt: serverTimestamp() });
    } else {
      await updateDoc(ref, { name: user.displayName, photo: user.photoURL });
    }
    document.getElementById('userAvatar').src = user.photoURL || '';
    document.getElementById('userName').textContent = user.displayName;
  }

  async function updateUserStatus(status) {
    if (!currentUser) return;
    try { await updateDoc(doc(db, 'users', currentUser.uid), { status, lastSeen: serverTimestamp() }); } catch(e) {}
  }

  // ===== TODAY DATA =====
  async function loadTodayData() {
    if (!currentUser) return;
    const snap = await getDoc(doc(db, 'logs', currentUser.uid, 'days', TODAY()));
    todayData = snap.exists() ? snap.data() : { prayers:[], quranPages:0, studySeconds:0, date:TODAY() };
    renderTodayUI();
    studySeconds = todayData.studySeconds || 0;
    updateTimerDisplay();
    updateMyStats();
  }

  async function saveTodayData() {
    if (!currentUser) return;
    await setDoc(doc(db, 'logs', currentUser.uid, 'days', TODAY()),
      { ...todayData, uid: currentUser.uid, name: currentUser.displayName, photo: currentUser.photoURL, updatedAt: serverTimestamp() });
    await updateDoc(doc(db, 'users', currentUser.uid), {
      todayStudySeconds: todayData.studySeconds || 0,
      todayPrayers:      todayData.prayers      || [],
      todayQuranPages:   todayData.quranPages    || 0,
      todayDate: TODAY()
    });
  }

  function renderTodayUI() {
    const prayers = todayData.prayers || [];
    document.querySelectorAll('.prayer-btn').forEach(btn =>
      btn.classList.toggle('active', prayers.includes(btn.dataset.prayer)));
    document.getElementById('quranInput').value = todayData.quranPages || 0;
  }

  // ===== PRAYERS =====
  window.togglePrayer = async (prayer) => {
    let prayers = todayData.prayers || [];
    if (prayers.includes(prayer)) { prayers = prayers.filter(p => p !== prayer); }
    else { prayers.push(prayer); spawnParticles(event.currentTarget); }
    todayData.prayers = prayers;
    await saveTodayData();
    renderTodayUI();
    updateMyStats();
  };

  // ===== QURAN =====
  window.saveQuran = async () => {
    const val = parseInt(document.getElementById('quranInput').value) || 0;
    todayData.quranPages = Math.max(0, val);
    await saveTodayData();
    showToast(`âœ… ØªÙ…Ø§Ù…! Ø§ØªÙ‚Ø±Ø£Øª ${val} ØµÙØ­Ø©`, 'success');
    updateMyStats();
  };

  // ===== TIMER =====
  window.toggleStudy = async () => { isStudying ? await stopStudy() : await startStudy(); };

  async function startStudy() {
    isStudying = true;
    studyStartTime = Date.now() - (studySeconds * 1000);
    await updateUserStatus('studying');
    document.getElementById('timerBtn').textContent = 'â¸ Ø§Ø³ØªÙ†Ù‘Ù‰ Ø´ÙˆÙŠØ©';
    document.getElementById('timerBtn').classList.add('studying');
    document.getElementById('timerStatus').textContent = 'Ø´ØºÙ‘Ø§Ù„ Ø¨ÙŠØ°Ø§ÙƒØ±...';
    document.getElementById('timerStatus').classList.add('active');
    studyTimer = setInterval(async () => {
      studySeconds = Math.floor((Date.now() - studyStartTime) / 1000);
      updateTimerDisplay();
      if (studySeconds % 30 === 0) { todayData.studySeconds = studySeconds; await saveTodayData(); }
    }, 1000);
  }

  async function stopStudy() {
    isStudying = false;
    clearInterval(studyTimer);
    todayData.studySeconds = studySeconds;
    await saveTodayData();
    await updateUserStatus('online');
    document.getElementById('timerBtn').textContent = 'â–¶ ÙŠÙ„Ø§ Ù†Ø°Ø§ÙƒØ±';
    document.getElementById('timerBtn').classList.remove('studying');
    document.getElementById('timerStatus').textContent = 'ÙˆØ§Ù‚Ù';
    document.getElementById('timerStatus').classList.remove('active');
    updateMyStats();
    showToast('âœ… ØªÙ… Ø­ÙØ¸ ÙˆÙ‚Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© ÙŠØ³Ø·Ø§!', 'success');
  }

  function updateTimerDisplay() {
    const h = Math.floor(studySeconds / 3600);
    const m = Math.floor((studySeconds % 3600) / 60);
    const s = studySeconds % 60;
    document.getElementById('timerHours').textContent = String(h).padStart(2,'0');
    document.getElementById('timerMins').textContent  = String(m).padStart(2,'0');
    document.getElementById('timerSecs').textContent  = String(s).padStart(2,'0');
    document.getElementById('timerCircle').style.strokeDashoffset =
      2 * Math.PI * 90 * (1 - Math.min(studySeconds / (8*3600), 1));
  }

  function updateMyStats() {
    const h = Math.floor(studySeconds / 3600);
    const m = Math.floor((studySeconds % 3600) / 60);
    document.getElementById('myStudyHours').textContent   = `${h}h ${m}m`;
    document.getElementById('myPrayersCount').textContent = (todayData.prayers||[]).length + '/6';
    document.getElementById('myQuranPages').textContent   = todayData.quranPages || 0;
  }

  // ===== LEADERBOARD =====
  function startRealtimeLeaderboard() {
    allUsersUnsub = onSnapshot(collection(db, 'users'), snap => {
      const users = [];
      snap.forEach(d => users.push({ id:d.id, ...d.data() }));
      renderLeaderboards(users);
    });
  }

  function renderLeaderboards(users) {
    const today = TODAY();
    const withToday = users.map(u => ({
      ...u,
      studySecs:  u.todayDate === today ? (u.todayStudySeconds||0) : 0,
      prayers:    u.todayDate === today ? (u.todayPrayers||[])     : [],
      quranPages: u.todayDate === today ? (u.todayQuranPages||0)   : 0,
    }));
    const byStudy   = [...withToday].sort((a,b) => b.studySecs - a.studySecs);
    const byPrayers = [...withToday].sort((a,b) => b.prayers.length - a.prayers.length);
    const byQuran   = [...withToday].sort((a,b) => b.quranPages - a.quranPages);
    renderBoard('studyBoard',   byStudy,   u => { const h=Math.floor(u.studySecs/3600),m=Math.floor((u.studySecs%3600)/60); return `${h}h ${m}m`; }, u=>u.studySecs);
    renderBoard('prayersBoard', byPrayers, u => `${u.prayers.length}/6`, u => u.prayers.length/6);
    renderBoard('quranBoard',   byQuran,   u => `${u.quranPages} Øµ`,     u => u.quranPages);
    renderFriendsStatus(withToday);
  }

  function renderBoard(id, users, valFn, pctFn) {
    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    const maxVal = Math.max(...users.map(pctFn), 1);
    document.getElementById(id).innerHTML = users.slice(0,10).map((u,i) => {
      const isMe = u.id === currentUser?.uid;
      const pct  = Math.round((pctFn(u)/maxVal)*100);
      const avatar = u.photo
        ? `<img class="board-avatar" src="${u.photo}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 36 36%22><rect fill=%22%23333%22 width=%2236%22 height=%2236%22 rx=%2218%22/><text x=%2250%25%22 y=%2255%25%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22 font-size=%2216%22>${(u.name||'?')[0]}</text></svg>'">`
        : `<div class="board-avatar" style="background:#333;display:flex;align-items:center;justify-content:center;font-size:1rem">${(u.name||'?')[0]}</div>`;
      return `<div class="board-row ${isMe?'me':''}" style="animation-delay:${i*0.04}s" onclick="openUserLog('${u.id}','${(u.name||'').replace(/'/g,"\\'")}')">
        <div class="board-rank">${medals[i]||'#'+(i+1)}</div>
        ${avatar}
        <div class="board-info">
          <div class="board-name">${u.name||'Ù…Ø¬Ù‡ÙˆÙ„'} ${isMe?'(Ø£Ù†Ø§ ğŸ˜)':''}</div>
          <div class="board-progress-bar"><div class="board-progress-fill" style="width:${pct}%"></div></div>
        </div>
        <div class="board-value">${valFn(u)}</div>
      </div>`;
    }).join('') || '<div class="empty-board">Ù…ÙÙŠØ´ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ù‡ Ù„Ø³Ù‡ ğŸ˜…</div>';
  }

  function renderFriendsStatus(users) {
    const now = Date.now();
    const getStatus = u => {
      const lastSeen = u.lastSeen?.toDate ? u.lastSeen.toDate().getTime() : 0;
      return (now-lastSeen)/1000 > 60 ? 'offline' : (u.status||'offline');
    };
    const map = {
      studying: { icon:'ğŸ“š', label:'Ø¨ÙŠØ°Ø§ÙƒØ± Ø¯Ù„ÙˆÙ‚ØªÙŠ', color:'#00e676' },
      online:   { icon:'ğŸŸ¢', label:'Ù…ØªØµÙ„',           color:'#4fc3f7' },
      offline:  { icon:'â­•', label:'Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯',       color:'#555' }
    };
    document.getElementById('friendsStatus').innerHTML = users.map(u => {
      const st = map[getStatus(u)] || map.offline;
      const isMe = u.id === currentUser?.uid;
      return `<div class="friend-status-card ${isMe?'me':''}">
        <img src="${u.photo||''}" class="friend-photo" onerror="this.style.background='#333';this.src=''">
        <div class="friend-status-dot" style="background:${st.color};${getStatus(u)==='studying'?'animation:statusPulse 1.5s infinite;':''}"></div>
        <div class="friend-name-text">${u.name?.split(' ')[0]||'ØŸ'} ${isMe?'(Ø£Ù†Ø§)':''}</div>
        <div class="friend-status-label" style="color:${st.color}">${st.icon} ${st.label}</div>
      </div>`;
    }).join('');
  }

  // ===== USER LOG =====
  window.openUserLog = async (uid, name) => {
    const modal = document.getElementById('logModal');
    modal.style.display = 'flex';
    requestAnimationFrame(() => modal.classList.add('open'));
    document.getElementById('logModalTitle').textContent = `ğŸ“‹ Ø³Ø¬Ù„ ${name}`;
    document.getElementById('logContent').innerHTML = '<div class="log-loading">â³ Ø§Ø³ØªÙ†Ù‘Ù‰ Ø¨Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>';
    try {
      const q = query(collection(db,'logs',uid,'days'), orderBy('date','desc'));
      const snap = await getDocs(q);
      const days = [];
      snap.forEach(d => days.push(d.data()));
      if (!days.length) { document.getElementById('logContent').innerHTML = '<div class="log-empty">Ù…ÙÙŠØ´ Ø³Ø¬Ù„Ø§Øª Ù„Ø³Ù‡ ğŸ“­</div>'; return; }
      const isMe = uid === currentUser?.uid;
      document.getElementById('logContent').innerHTML = days.map(day => {
        const h = Math.floor((day.studySeconds||0)/3600);
        const m = Math.floor(((day.studySeconds||0)%3600)/60);
        const prayers = day.prayers||[];
        const isToday = day.date === TODAY();
        return `<div class="log-day-card ${isToday?'today':''}">
          <div class="log-day-header">
            <span class="log-date">${formatDate(day.date)} ${isToday?'ğŸ”µ Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ù‡':''}</span>
            ${isMe ? `<button class="edit-log-btn" onclick="openEditLog('${day.date}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>` : ''}
          </div>
          <div class="log-stats-row">
            <div class="log-stat">ğŸ“š ${h}h ${m}m</div>
            <div class="log-stat">ğŸ•Œ ${prayers.length}/6</div>
            <div class="log-stat">ğŸ“– ${day.quranPages||0} Øµ</div>
          </div>
          <div class="log-prayers-row">${['Ø§Ù„ÙØ¬Ø±','Ø§Ù„Ø¸Ù‡Ø±','Ø§Ù„Ø¹ØµØ±','Ø§Ù„Ù…ØºØ±Ø¨','Ø§Ù„Ø¹Ø´Ø§Ø¡','Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­'].map(p=>`<span class="log-prayer-badge ${prayers.includes(p)?'done':''}">${p}</span>`).join('')}</div>
        </div>`;
      }).join('');
    } catch(e) { document.getElementById('logContent').innerHTML = '<div class="log-empty">ÙÙŠÙ‡ Ù…Ø´ÙƒÙ„Ø©ØŒ Ø­Ø§ÙˆÙ„ ØªØ§Ù†ÙŠ ğŸ˜•</div>'; }
  };

  window.closeLogModal = () => {
    const m = document.getElementById('logModal');
    m.classList.remove('open');
    setTimeout(() => m.style.display = 'none', 300);
  };

  // ===== EDIT ALL DAYS =====
  window.openEditLog = async (date) => {
    editingDate = date;
    const isToday = date === TODAY();
    const modal = document.getElementById('editModal');
    modal.style.display = 'flex';
    requestAnimationFrame(() => modal.classList.add('open'));
    document.getElementById('editModalTitle').textContent = `âœï¸ ØªØ¹Ø¯ÙŠÙ„ ${formatDate(date)}`;

    let dayData;
    if (isToday) {
      dayData = todayData;
    } else {
      const snap = await getDoc(doc(db,'logs',currentUser.uid,'days',date));
      dayData = snap.exists() ? snap.data() : { prayers:[], quranPages:0, studySeconds:0, date };
    }
    const prayers = dayData.prayers||[];
    ['Ø§Ù„ÙØ¬Ø±','Ø§Ù„Ø¸Ù‡Ø±','Ø§Ù„Ø¹ØµØ±','Ø§Ù„Ù…ØºØ±Ø¨','Ø§Ù„Ø¹Ø´Ø§Ø¡','Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­'].forEach(p => {
      const el = document.getElementById('edit_'+p);
      if (el) el.checked = prayers.includes(p);
    });
    document.getElementById('editQuran').value = dayData.quranPages || 0;
    document.getElementById('editStudy').value = Math.round((dayData.studySeconds||0)/36)/100;
  };

  window.saveEditLog = async () => {
    const prayers = ['Ø§Ù„ÙØ¬Ø±','Ø§Ù„Ø¸Ù‡Ø±','Ø§Ù„Ø¹ØµØ±','Ø§Ù„Ù…ØºØ±Ø¨','Ø§Ù„Ø¹Ø´Ø§Ø¡','Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­'].filter(p => document.getElementById('edit_'+p)?.checked);
    const pages   = parseInt(document.getElementById('editQuran').value)  || 0;
    const hours   = parseFloat(document.getElementById('editStudy').value) || 0;
    const newSecs = Math.round(hours * 3600);
    const isToday = editingDate === TODAY();

    await setDoc(doc(db,'logs',currentUser.uid,'days',editingDate),
      { prayers, quranPages:pages, studySeconds:newSecs, date:editingDate,
        uid:currentUser.uid, name:currentUser.displayName, photo:currentUser.photoURL, updatedAt:serverTimestamp() });

    if (isToday) {
      todayData = { ...todayData, prayers, quranPages:pages, studySeconds:newSecs };
      studySeconds = newSecs;
      if (isStudying) studyStartTime = Date.now() - (studySeconds * 1000);
      await updateDoc(doc(db,'users',currentUser.uid), {
        todayStudySeconds:newSecs, todayPrayers:prayers, todayQuranPages:pages, todayDate:TODAY()
      });
      renderTodayUI();
      updateTimerDisplay();
      updateMyStats();
    }

    closeEditModal();
    showToast('âœ… ØªÙ…Ø§Ù… ÙŠØ³Ø·Ø§! Ø§Ù„Ø³Ø¬Ù„ Ø§ØªØ¹Ø¯Ù‘Ù„', 'success');
    setTimeout(() => closeLogModal(), 100);
  };

  window.closeEditModal = () => {
    const m = document.getElementById('editModal');
    m.classList.remove('open');
    setTimeout(() => m.style.display = 'none', 300);
  };

  // ===== STATS CHARTS =====
  window.loadStats = async (period) => {
    if (!currentUser) return;
    document.querySelectorAll('.stats-period-btn').forEach(b => b.classList.toggle('active', b.dataset.period === period));
    document.getElementById('statsLoading').style.display = 'block';
    document.getElementById('chartsArea').style.display   = 'none';
    try {
      const q = query(collection(db,'logs',currentUser.uid,'days'), orderBy('date','desc'), limit(period==='week'?7:30));
      const snap = await getDocs(q);
      const days = [];
      snap.forEach(d => days.push(d.data()));
      days.reverse();

      if (!days.length) {
        document.getElementById('statsLoading').innerHTML = '<div style="text-align:center;padding:2rem;color:#78909c">Ù…ÙÙŠØ´ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ø³Ù‡ ğŸ˜…<br>Ø§Ø¨Ø¯Ø£ ØªØ³Ø¬Ù‘Ù„ Ù†Ø´Ø§Ø·Ùƒ!</div>';
        return;
      }

      document.getElementById('statsLoading').style.display = 'none';
      document.getElementById('chartsArea').style.display   = 'block';

      const labels      = days.map(d => new Date(d.date).toLocaleDateString('ar-EG',{weekday:'short',day:'numeric'}));
      const studyHours  = days.map(d => +((d.studySeconds||0)/3600).toFixed(2));
      const prayerCount = days.map(d => (d.prayers||[]).length);
      const quranPages  = days.map(d => d.quranPages||0);

      const totalStudy   = days.reduce((s,d) => s+(d.studySeconds||0), 0);
      const totalPrayers = days.reduce((s,d) => s+(d.prayers||[]).length, 0);
      const totalQuran   = days.reduce((s,d) => s+(d.quranPages||0), 0);
      const sh = Math.floor(totalStudy/3600), sm = Math.floor((totalStudy%3600)/60);
      document.getElementById('statsTotalStudy').textContent   = `${sh}h ${sm}m`;
      document.getElementById('statsAvgStudy').textContent     = days.length ? ((totalStudy/days.length)/3600).toFixed(1)+'h' : '0h';
      document.getElementById('statsTotalPrayers').textContent = totalPrayers;
      document.getElementById('statsTotalQuran').textContent   = totalQuran + ' Øµ';

      drawChart('studyChart',   labels, studyHours,  'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©', '#4fc3f7', 'rgba(79,195,247,0.12)');
      drawChart('prayersChart', labels, prayerCount, 'Ø¹Ø¯Ø¯ Ø§Ù„ØµÙ„ÙˆØ§Øª',    '#69f0ae', 'rgba(105,240,174,0.12)');
      drawChart('quranChart',   labels, quranPages,  'ØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†',   '#ce93d8', 'rgba(206,147,216,0.12)');
    } catch(e) {
      document.getElementById('statsLoading').innerHTML = '<div style="text-align:center;padding:2rem;color:#78909c">Ù…ÙÙŠØ´ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ø³Ù‡ ğŸ˜…</div>';
    }
  };

  function drawChart(canvasId, labels, data, label, color, bgColor) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const existing = Chart.getChart(canvas);
    if (existing) existing.destroy();
    new Chart(canvas, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label, data,
          borderColor: color, backgroundColor: bgColor,
          borderWidth: 2.5, pointBackgroundColor: color,
          pointRadius: 4, pointHoverRadius: 7,
          fill: true, tension: 0.4
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor:'rgba(8,8,22,0.95)',
            borderColor: color, borderWidth: 1,
            titleColor: color, bodyColor:'#e8eaf6',
            padding: 10,
            titleFont:{ family:'Cairo', size:12 },
            bodyFont:{ family:'Cairo', size:11 }
          }
        },
        scales: {
          x: { ticks:{ color:'#78909c', font:{family:'Cairo',size:10}, maxRotation:40 }, grid:{ color:'rgba(255,255,255,0.04)' } },
          y: { beginAtZero:true, ticks:{ color:'#78909c', font:{family:'Cairo',size:10} }, grid:{ color:'rgba(255,255,255,0.06)' } }
        },
        animation: { duration:900, easing:'easeInOutQuart' }
      }
    });
  }

  // ===== CHAT =====
  function startChat() {
    if (chatUnsub) return;
    const q = query(collection(db,'chat'), orderBy('createdAt','asc'), limit(100));
    chatUnsub = onSnapshot(q, snap => {
      const msgs = [];
      snap.forEach(d => msgs.push({ id:d.id, ...d.data() }));
      renderChat(msgs);
    }, () => {
      const c = document.getElementById('chatMessages');
      if (c) c.innerHTML = '<div class="chat-loading">ÙÙŠÙ‡ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª ğŸ˜•</div>';
    });
  }

  function renderChat(msgs) {
    const container = document.getElementById('chatMessages');
    if (!container) return;
    if (!msgs.length) { container.innerHTML = '<div class="chat-loading">Ù…ÙÙŠØ´ Ø±Ø³Ø§ÙŠÙ„ Ù„Ø³Ù‡ØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙƒÙ„Ø§Ù…! ğŸ˜„</div>'; return; }
    const scrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 60;
    container.innerHTML = msgs.map(msg => {
      const isMe = msg.uid === currentUser?.uid;
      const time = msg.createdAt?.toDate ? msg.createdAt.toDate().toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'}) : '';
      return `<div class="chat-bubble-wrap ${isMe?'me':''}">
        <img class="chat-bubble-avatar" src="${msg.photo||''}" onerror="this.style.background='#333';this.removeAttribute('src')">
        <div>
          <div class="chat-bubble">${escapeHtml(msg.text)}</div>
          <div class="chat-bubble-meta">
            ${!isMe?`<span class="chat-bubble-name">${msg.name?.split(' ')[0]||'ØŸ'}</span> â€¢`:''}
            <span>${time}</span>
          </div>
        </div>
      </div>`;
    }).join('');
    if (scrolledToBottom) container.scrollTop = container.scrollHeight;
  }

  function escapeHtml(t) { return (t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  window.sendChat = async () => {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text || !currentUser) return;
    input.value = '';
    const container = document.getElementById('chatMessages');
    if (container) container.scrollTop = container.scrollHeight;
    try {
      await addDoc(collection(db,'chat'), { uid:currentUser.uid, name:currentUser.displayName, photo:currentUser.photoURL, text, createdAt:serverTimestamp() });
    } catch(e) { showToast('Ù…Ø´ Ù‚Ø§Ø¯Ø± ÙŠØ¨Ø¹ØªØŒ Ø­Ø§ÙˆÙ„ ØªØ§Ù†ÙŠ!', 'error'); }
  };

  // ===== HELPERS =====
  function formatDate(dateStr) {
    if (!dateStr) return '';
    return new Date(dateStr).toLocaleDateString('ar-EG',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  }
  window.showLoading = show => document.getElementById('loginLoading').style.display = show ? 'block' : 'none';
  window.showToast = (msg, type='info') => {
    const t = document.getElementById('toast');
    t.textContent = msg; t.className = 'toast show ' + type;
    setTimeout(() => t.className = 'toast', 3000);
  };
  function showLogin() {
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('appPage').style.display   = 'none';
    showLoading(false);
  }
  function showApp() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('appPage').style.display   = 'block';
    showLoading(false);
  }
  function spawnParticles(el) {
    if (!el) return;
    const rect = el.getBoundingClientRect();
    const colors = ['#4fc3f7','#69f0ae','#ce93d8','#ffd54f'];
    for (let i=0; i<10; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.cssText = `left:${rect.left+rect.width/2}px;top:${rect.top+rect.height/2}px;background:${colors[i%4]}`;
      const angle = (i/10)*360, dist = 50+Math.random()*40;
      p.style.setProperty('--dx', Math.cos(angle*Math.PI/180)*dist+'px');
      p.style.setProperty('--dy', Math.sin(angle*Math.PI/180)*dist+'px');
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 800);
    }
  }
</script>

<style>
:root {
  --bg:#050510;--glass:rgba(255,255,255,0.04);--glass-border:rgba(255,255,255,0.09);
  --accent:#4fc3f7;--accent2:#ce93d8;--gold:#ffd54f;--green:#69f0ae;
  --text:#e8eaf6;--sub:#78909c;--radius:20px;--nav-h:60px;--tab-h:52px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;-webkit-tap-highlight-color:transparent;}

/* BG */
.bg-orbs{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden;}
.orb{position:absolute;border-radius:50%;filter:blur(100px);opacity:0.12;animation:orbFloat linear infinite;}
.orb1{width:700px;height:700px;background:#4fc3f7;top:-250px;right:-250px;animation-duration:22s;}
.orb2{width:600px;height:600px;background:#ce93d8;bottom:-200px;left:-200px;animation-duration:28s;animation-delay:-12s;}
.orb3{width:500px;height:500px;background:#69f0ae;top:40%;left:40%;animation-duration:20s;animation-delay:-7s;}
@keyframes orbFloat{0%,100%{transform:translate(0,0) scale(1);}33%{transform:translate(40px,-40px) scale(1.08);}66%{transform:translate(-30px,30px) scale(0.93);}}
.grid-bg{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(79,195,247,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(79,195,247,0.025) 1px,transparent 1px);background-size:60px 60px;}

/* ANIMATIONS */
@keyframes fadeInUp{from{opacity:0;transform:translateY(22px);}to{opacity:1;transform:translateY(0);}}
@keyframes fadeInScale{from{opacity:0;transform:scale(0.94);}to{opacity:1;transform:scale(1);}}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
@keyframes studyGlow{0%,100%{box-shadow:0 0 10px rgba(105,240,174,0.2)}50%{box-shadow:0 0 30px rgba(105,240,174,0.6)}}
@keyframes statusPulse{0%,100%{box-shadow:0 0 0 0 rgba(105,240,174,0.7)}50%{box-shadow:0 0 0 6px rgba(105,240,174,0)}}
@keyframes particleFly{0%{opacity:1;transform:translate(0,0) scale(1);}100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(0);}}
@keyframes boardRowIn{from{opacity:0;transform:translateX(16px);}to{opacity:1;transform:translateX(0);}}

/* LOGIN */
#loginPage{display:flex;align-items:center;justify-content:center;min-height:100vh;position:relative;z-index:10;flex-direction:column;gap:2rem;padding:1.5rem;}
.login-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);backdrop-filter:blur(50px);border-radius:28px;padding:2.5rem 2rem;text-align:center;max-width:420px;width:100%;box-shadow:0 0 80px rgba(79,195,247,0.1),inset 0 1px 0 rgba(255,255,255,0.1);animation:fadeInScale 0.7s cubic-bezier(.16,1,.3,1) both;}
.login-logo{font-size:4rem;margin-bottom:1rem;animation:float 3s ease-in-out infinite;display:block;}
.login-title{font-size:clamp(1.15rem,3.5vw,1.6rem);font-weight:900;line-height:1.45;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:0.6rem;}
.login-sub{color:var(--sub);font-size:0.88rem;margin-bottom:2rem;line-height:1.8;}
.google-btn{display:flex;align-items:center;justify-content:center;gap:0.7rem;width:100%;padding:0.9rem 1.5rem;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.18);border-radius:14px;color:var(--text);font-family:'Cairo',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden;}
.google-btn::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.06),transparent);background-size:200% 100%;animation:shimmer 2s infinite;}
.google-btn:hover{background:rgba(255,255,255,0.13);transform:translateY(-2px);box-shadow:0 8px 30px rgba(79,195,247,0.25);}
.google-btn img{width:22px;}
#loginLoading{display:none;margin-top:1rem;color:var(--sub);font-size:0.88rem;}

/* APP */
#appPage{display:none;position:relative;z-index:5;min-height:100vh;}

/* NAV */
nav{position:sticky;top:0;z-index:100;height:var(--nav-h);background:rgba(5,5,16,0.88);backdrop-filter:blur(24px);border-bottom:1px solid rgba(255,255,255,0.07);padding:0 1rem;display:flex;align-items:center;justify-content:space-between;gap:0.5rem;}
.nav-logo{font-size:clamp(0.65rem,2.2vw,0.95rem);font-weight:900;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.nav-user{display:flex;align-items:center;gap:0.5rem;flex-shrink:0;}
.nav-avatar{width:32px;height:32px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;}
#userName{font-size:0.8rem;color:var(--sub);display:none;}
@media(min-width:500px){#userName{display:block;}}
.sign-out-btn{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:0.32rem 0.7rem;color:var(--sub);font-family:'Cairo',sans-serif;font-size:0.76rem;cursor:pointer;transition:all 0.2s;white-space:nowrap;}
.sign-out-btn:hover{background:rgba(255,80,80,0.15);color:#ff6b6b;border-color:rgba(255,80,80,0.3);}

/* TABS */
.tab-bar{display:flex;gap:0.35rem;padding:0.65rem 0.75rem;overflow-x:auto;scrollbar-width:none;background:rgba(5,5,16,0.7);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.05);position:sticky;top:var(--nav-h);z-index:99;}
.tab-bar::-webkit-scrollbar{display:none;}
.tab-btn{padding:0.45rem 1rem;border-radius:30px;border:1px solid rgba(255,255,255,0.09);background:transparent;color:var(--sub);font-family:'Cairo',sans-serif;font-size:0.8rem;cursor:pointer;transition:all 0.25s;white-space:nowrap;flex-shrink:0;}
.tab-btn.active{background:linear-gradient(135deg,rgba(79,195,247,0.18),rgba(206,147,216,0.18));border-color:var(--accent);color:var(--accent);box-shadow:0 0 12px rgba(79,195,247,0.15);}
.tab-btn:active{transform:scale(0.95);}

/* CONTENT */
.main-content{padding:0.9rem;max-width:1100px;margin:0 auto;}
.tab-section{display:none;}
.tab-section.active{display:block;animation:fadeInUp 0.4s cubic-bezier(.16,1,.3,1) both;}

/* GLASS CARD */
.glass-card{background:var(--glass);border:1px solid var(--glass-border);backdrop-filter:blur(30px);border-radius:var(--radius);padding:1.1rem;box-shadow:0 4px 40px rgba(0,0,0,0.25),inset 0 1px 0 rgba(255,255,255,0.05);transition:box-shadow 0.3s;}
.glass-card:hover{box-shadow:0 4px 40px rgba(79,195,247,0.07),inset 0 1px 0 rgba(255,255,255,0.06);}

/* SECTION TITLE */
.section-title{font-size:1rem;font-weight:700;margin-bottom:0.9rem;color:var(--text);display:flex;align-items:center;gap:0.5rem;}
.section-title .dot{width:7px;height:7px;border-radius:50%;background:var(--accent);flex-shrink:0;}

/* STATS MINI */
.my-stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;margin-bottom:0.9rem;}
.my-stat-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:0.75rem 0.4rem;text-align:center;transition:transform 0.2s;}
.my-stat-card:hover{transform:translateY(-2px);}
.my-stat-num{font-size:clamp(0.9rem,3.5vw,1.25rem);font-weight:900;color:var(--accent);}
.my-stat-label{font-size:0.65rem;color:var(--sub);margin-top:2px;}

/* TIMER */
.timer-section{display:flex;flex-direction:column;align-items:center;gap:1.1rem;}
.timer-circle-wrap{position:relative;width:190px;height:190px;}
@media(max-width:360px){.timer-circle-wrap{width:160px;height:160px;}}
.timer-svg{transform:rotate(-90deg);}
.timer-track{fill:none;stroke:rgba(255,255,255,0.06);stroke-width:8;}
#timerCircle{fill:none;stroke:url(#timerGrad);stroke-width:8;stroke-linecap:round;stroke-dasharray:565.5;stroke-dashoffset:565.5;transition:stroke-dashoffset 1s linear;filter:drop-shadow(0 0 6px rgba(79,195,247,0.5));}
.timer-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;}
.timer-digits{font-size:clamp(1.5rem,5.5vw,1.9rem);font-weight:900;font-variant-numeric:tabular-nums;letter-spacing:-1px;}
#timerStatus{font-size:0.7rem;color:var(--sub);}
#timerStatus.active{color:var(--green);animation:pulse 2s infinite;}
.timer-btn{padding:0.65rem 1.8rem;border-radius:14px;background:linear-gradient(135deg,rgba(79,195,247,0.18),rgba(206,147,216,0.18));border:1px solid var(--accent);color:var(--accent);font-family:'Cairo',sans-serif;font-size:0.9rem;font-weight:700;cursor:pointer;transition:all 0.3s;}
.timer-btn:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(79,195,247,0.3);}
.timer-btn:active{transform:scale(0.96);}
.timer-btn.studying{border-color:var(--green);color:var(--green);animation:studyGlow 2s infinite;}

/* PRAYERS */
.prayers-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;}
.prayer-btn{padding:0.75rem 0.25rem;border-radius:13px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:var(--sub);font-family:'Cairo',sans-serif;font-size:0.78rem;font-weight:600;cursor:pointer;transition:all 0.3s;text-align:center;position:relative;overflow:hidden;}
.prayer-btn.active{background:rgba(105,240,174,0.1);border-color:var(--green);color:var(--green);box-shadow:0 0 16px rgba(105,240,174,0.1);}
.prayer-btn:hover{transform:translateY(-2px);}
.prayer-btn:active{transform:scale(0.94);}

/* QURAN */
.quran-input-wrap{display:flex;gap:0.5rem;}
.quran-input{flex:1;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:0.6rem 0.85rem;color:var(--text);font-family:'Cairo',sans-serif;font-size:0.9rem;outline:none;transition:border-color 0.3s;}
.quran-input:focus{border-color:var(--accent2);box-shadow:0 0 0 2px rgba(206,147,216,0.12);}
.save-btn{padding:0.6rem 1rem;border-radius:12px;background:linear-gradient(135deg,rgba(206,147,216,0.22),rgba(79,195,247,0.14));border:1px solid var(--accent2);color:var(--accent2);font-family:'Cairo',sans-serif;font-size:0.82rem;font-weight:700;cursor:pointer;transition:all 0.3s;white-space:nowrap;}
.save-btn:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(206,147,216,0.3);}

/* GRID */
.input-grid{display:grid;grid-template-columns:1fr;gap:0.9rem;}
@media(min-width:600px){.input-grid{grid-template-columns:1fr 1fr;}}
.gap-md{display:flex;flex-direction:column;gap:0.9rem;}

/* BOARDS */
.boards-grid{display:grid;grid-template-columns:1fr;gap:0.9rem;}
@media(min-width:680px){.boards-grid{grid-template-columns:1fr 1fr;}}
.board-title{font-size:0.9rem;font-weight:700;margin-bottom:0.8rem;display:flex;align-items:center;gap:0.4rem;}
.board-row{display:flex;align-items:center;gap:0.6rem;padding:0.55rem 0.35rem;border-radius:11px;transition:background 0.2s;cursor:pointer;animation:boardRowIn 0.4s ease both;}
.board-row:hover{background:rgba(255,255,255,0.04);}
.board-row:active{transform:scale(0.98);}
.board-row.me{background:rgba(79,195,247,0.05);border:1px solid rgba(79,195,247,0.15);}
.board-rank{font-size:1.05rem;width:26px;text-align:center;flex-shrink:0;}
.board-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0;}
.board-info{flex:1;min-width:0;}
.board-name{font-size:0.78rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.board-progress-bar{height:3px;background:rgba(255,255,255,0.06);border-radius:99px;margin-top:3px;overflow:hidden;}
.board-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:99px;transition:width 0.8s ease;}
.board-value{font-size:0.74rem;color:var(--gold);font-weight:700;flex-shrink:0;white-space:nowrap;}
.empty-board{text-align:center;color:var(--sub);padding:1.5rem;font-size:0.85rem;}

/* FRIENDS */
.friends-grid{display:flex;flex-wrap:wrap;gap:0.65rem;}
.friend-status-card{display:flex;flex-direction:column;align-items:center;gap:0.32rem;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:15px;padding:0.85rem 0.9rem;min-width:85px;transition:all 0.3s;position:relative;}
.friend-status-card.me{border-color:rgba(79,195,247,0.25);}
.friend-status-card:hover{transform:translateY(-3px);box-shadow:0 6px 24px rgba(0,0,0,0.2);}
.friend-photo{width:46px;height:46px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.1);}
.friend-status-dot{width:11px;height:11px;border-radius:50%;position:absolute;bottom:33px;right:10px;border:2px solid var(--bg);}
.friend-name-text{font-size:0.74rem;font-weight:700;text-align:center;}
.friend-status-label{font-size:0.64rem;text-align:center;}

/* STATS TAB */
.stats-period-btns{display:flex;gap:0.5rem;margin-bottom:1rem;}
.stats-period-btn{padding:0.42rem 1.1rem;border-radius:30px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:var(--sub);font-family:'Cairo',sans-serif;font-size:0.82rem;cursor:pointer;transition:all 0.2s;}
.stats-period-btn.active{background:rgba(79,195,247,0.14);border-color:var(--accent);color:var(--accent);}
.stats-summary-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:0.5rem;margin-bottom:1rem;}
@media(min-width:480px){.stats-summary-grid{grid-template-columns:repeat(4,1fr);}}
.stats-summary-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:13px;padding:0.75rem 0.5rem;text-align:center;}
.stats-summary-num{font-size:1.1rem;font-weight:900;color:var(--accent);}
.stats-summary-label{font-size:0.65rem;color:var(--sub);margin-top:2px;}
.chart-card{margin-bottom:0.9rem;}
.chart-label{font-size:0.84rem;font-weight:700;margin-bottom:0.65rem;color:var(--sub);}
.chart-wrap{height:170px;position:relative;}
@media(min-width:600px){.chart-wrap{height:210px;}}
#statsLoading{text-align:center;color:var(--sub);padding:2.5rem;font-size:0.88rem;}
#chartsArea{display:none;}

/* MODAL */
.modal{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.65);backdrop-filter:blur(12px);align-items:center;justify-content:center;padding:0.9rem;opacity:0;transition:opacity 0.3s;}
.modal.open{opacity:1;}
.modal-box{background:#0b0b1d;border:1px solid rgba(255,255,255,0.1);border-radius:22px;padding:1.2rem;max-width:530px;width:100%;max-height:88vh;display:flex;flex-direction:column;box-shadow:0 0 60px rgba(79,195,247,0.1);transform:translateY(18px);transition:transform 0.35s cubic-bezier(.16,1,.3,1);}
.modal.open .modal-box{transform:translateY(0);}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.9rem;flex-shrink:0;}
.modal-header h3{font-size:0.95rem;font-weight:700;}
.modal-close{background:none;border:none;color:var(--sub);font-size:1.3rem;cursor:pointer;padding:0.2rem;line-height:1;}
.modal-close:hover{color:var(--text);}
.modal-body{overflow-y:auto;flex:1;scrollbar-width:thin;}

/* LOG */
.log-day-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:13px;padding:0.85rem;margin-bottom:0.55rem;}
.log-day-card.today{border-color:rgba(79,195,247,0.25);}
.log-day-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.55rem;gap:0.5rem;}
.log-date{font-size:0.76rem;font-weight:700;color:var(--accent);flex:1;min-width:0;}
.log-stats-row{display:flex;gap:0.8rem;flex-wrap:wrap;margin-bottom:0.45rem;font-size:0.76rem;color:var(--sub);}
.log-prayers-row{display:flex;flex-wrap:wrap;gap:0.3rem;}
.log-prayer-badge{padding:0.13rem 0.45rem;border-radius:20px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);font-size:0.64rem;color:var(--sub);}
.log-prayer-badge.done{background:rgba(105,240,174,0.1);border-color:rgba(105,240,174,0.3);color:var(--green);}
.edit-log-btn{background:rgba(79,195,247,0.1);border:1px solid rgba(79,195,247,0.2);border-radius:8px;padding:0.18rem 0.55rem;color:var(--accent);font-family:'Cairo',sans-serif;font-size:0.7rem;cursor:pointer;transition:all 0.2s;white-space:nowrap;flex-shrink:0;}
.edit-log-btn:hover{background:rgba(79,195,247,0.2);}
.log-loading,.log-empty{text-align:center;color:var(--sub);padding:2rem;font-size:0.88rem;}

/* EDIT */
.edit-checks{display:grid;grid-template-columns:1fr 1fr;gap:0.45rem;margin-bottom:0.85rem;}
.edit-check-item{display:flex;align-items:center;gap:0.45rem;background:rgba(255,255,255,0.04);border-radius:10px;padding:0.5rem 0.65rem;cursor:pointer;font-size:0.82rem;transition:background 0.2s;}
.edit-check-item:hover{background:rgba(255,255,255,0.07);}
.edit-check-item input{width:14px;height:14px;cursor:pointer;accent-color:var(--green);}
.edit-field{margin-bottom:0.7rem;}
.edit-label{font-size:0.75rem;color:var(--sub);margin-bottom:0.32rem;display:block;}
.edit-input{width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:0.55rem 0.8rem;color:var(--text);font-family:'Cairo',sans-serif;font-size:0.88rem;outline:none;transition:border-color 0.3s;}
.edit-input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(79,195,247,0.1);}
.save-edit-btn{width:100%;padding:0.75rem;border-radius:12px;background:linear-gradient(135deg,rgba(79,195,247,0.2),rgba(206,147,216,0.2));border:1px solid var(--accent);color:var(--accent);font-family:'Cairo',sans-serif;font-size:0.92rem;font-weight:700;cursor:pointer;transition:all 0.3s;}
.save-edit-btn:hover{box-shadow:0 4px 20px rgba(79,195,247,0.3);transform:translateY(-1px);}

/* CHAT */
.chat-container{display:flex;flex-direction:column;height:calc(100dvh - var(--nav-h) - var(--tab-h) - 1.8rem);min-height:380px;}
.chat-messages{flex:1;overflow-y:auto;padding:0.4rem 0;display:flex;flex-direction:column;gap:0.6rem;scrollbar-width:thin;}
.chat-loading{text-align:center;color:var(--sub);padding:2rem;font-size:0.85rem;}
.chat-bubble-wrap{display:flex;align-items:flex-end;gap:0.45rem;animation:fadeInUp 0.3s ease both;}
.chat-bubble-wrap.me{flex-direction:row-reverse;}
.chat-bubble-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0;border:1px solid rgba(255,255,255,0.1);}
.chat-bubble{max-width:74%;padding:0.55rem 0.85rem;border-radius:17px;font-size:0.85rem;line-height:1.5;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);word-break:break-word;}
.chat-bubble-wrap.me .chat-bubble{background:linear-gradient(135deg,rgba(79,195,247,0.17),rgba(206,147,216,0.11));border-color:rgba(79,195,247,0.22);}
.chat-bubble-meta{font-size:0.64rem;color:var(--sub);margin-top:3px;display:flex;gap:0.32rem;align-items:center;}
.chat-bubble-name{font-weight:700;color:var(--accent);}
.chat-input-row{display:flex;gap:0.45rem;margin-top:0.7rem;padding-top:0.7rem;border-top:1px solid rgba(255,255,255,0.07);flex-shrink:0;}
.chat-input{flex:1;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);border-radius:13px;padding:0.6rem 0.85rem;color:var(--text);font-family:'Cairo',sans-serif;font-size:0.88rem;outline:none;transition:border-color 0.3s;}
.chat-input:focus{border-color:var(--accent2);}
.chat-send-btn{padding:0.6rem 0.95rem;border-radius:13px;background:linear-gradient(135deg,rgba(206,147,216,0.22),rgba(79,195,247,0.15));border:1px solid var(--accent2);color:var(--accent2);font-family:'Cairo',sans-serif;font-size:0.8rem;font-weight:700;cursor:pointer;transition:all 0.3s;white-space:nowrap;}
.chat-send-btn:hover{transform:translateY(-2px);box-shadow:0 4px 18px rgba(206,147,216,0.3);}

/* TOAST */
.toast{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%) translateY(80px);background:rgba(12,12,28,0.97);border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(20px);border-radius:12px;padding:0.65rem 1.2rem;font-size:0.85rem;font-weight:600;z-index:9999;transition:transform 0.35s cubic-bezier(.16,1,.3,1);white-space:nowrap;box-shadow:0 4px 30px rgba(0,0,0,0.4);}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.success{border-color:rgba(105,240,174,0.4);color:var(--green);}
.toast.error{border-color:rgba(255,100,100,0.4);color:#ff6b6b;}

/* PARTICLES */
.particle{position:fixed;width:8px;height:8px;border-radius:50%;pointer-events:none;z-index:9999;animation:particleFly 0.8s ease forwards;}

/* SCROLLBAR */
::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:2px;}
</style>
</head>
<body>

<div class="bg-orbs"><div class="orb orb1"></div><div class="orb orb2"></div><div class="orb orb3"></div></div>
<div class="grid-bg"></div>

<!-- LOGIN -->
<div id="loginPage">
  <div class="login-card">
    <span class="login-logo">ğŸ“š</span>
    <div class="login-title">Ø¯Ø§ÙŠÙ…Ø§ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ù†Ø³Ù†Ø¯ ÙˆØ§Ù‡ÙŠ Ù…ÙˆØ§Ù‚ÙÙ†Ø§ Ø¨ØªØ«Ø¨Øª</div>
    <div class="login-sub">ØªØ§Ø¨Ø¹ Ù…Ø°Ø§ÙƒØ±ØªÙƒ ÙˆØµÙ„ÙˆØ§ØªÙƒ ÙˆÙ‚Ø±Ø¢Ù†Ùƒ ÙˆØªÙ†Ø§ÙØ³ Ù…Ø¹ ØµØ­Ø§Ø¨Ùƒ ğŸ”¥</div>
    <button class="google-btn" onclick="googleSignIn()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
      Ø§Ø¯Ø®Ù„ Ø¨Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„ Ø¨ØªØ§Ø¹Ùƒ
    </button>
    <div id="loginLoading">â³ Ø§Ø³ØªÙ†Ù‘Ù‰ Ø¨Ù†Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ...</div>
  </div>
</div>

<!-- APP -->
<div id="appPage">
  <nav>
    <div class="nav-logo">ğŸ¤ Ø¯Ø§ÙŠÙ…Ø§ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ù†Ø³Ù†Ø¯ ÙˆØ§Ù‡ÙŠ Ù…ÙˆØ§Ù‚ÙÙ†Ø§ Ø¨ØªØ«Ø¨Øª</div>
    <div class="nav-user">
      <img id="userAvatar" class="nav-avatar" src="" alt="">
      <span id="userName"></span>
      <button class="sign-out-btn" onclick="googleSignOut()">Ø®Ø±ÙˆØ¬</button>
    </div>
  </nav>

  <div class="tab-bar">
    <button class="tab-btn active" onclick="showTab('home',this)">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="tab-btn" onclick="showTab('leaderboard',this)">ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨</button>
    <button class="tab-btn" onclick="showTab('stats',this)">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
    <button class="tab-btn" onclick="showTab('friends',this)">ğŸ‘¥ Ø§Ù„ØµØ­Ø§Ø¨</button>
    <button class="tab-btn" onclick="showTab('chat',this)">ğŸ’¬ Ø§Ù„Ø´Ø§Øª</button>
  </div>

  <div class="main-content">

    <!-- HOME -->
    <div id="tab-home" class="tab-section active">
      <div class="my-stats-row">
        <div class="my-stat-card"><div class="my-stat-num" id="myStudyHours">0h 0m</div><div class="my-stat-label">ğŸ“š Ø§ØªØ°Ø§ÙƒØ±</div></div>
        <div class="my-stat-card"><div class="my-stat-num" id="myPrayersCount">0/6</div><div class="my-stat-label">ğŸ•Œ ØµÙ„ÙˆØ§Øª</div></div>
        <div class="my-stat-card"><div class="my-stat-num" id="myQuranPages">0</div><div class="my-stat-label">ğŸ“– ØµÙØ­Ø§Øª</div></div>
      </div>
      <div class="input-grid">
        <div class="glass-card">
          <div class="section-title"><div class="dot"></div> Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</div>
          <div class="timer-section">
            <div class="timer-circle-wrap">
              <svg class="timer-svg" width="190" height="190" viewBox="0 0 190 190">
                <defs>
                  <linearGradient id="timerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#4fc3f7"/><stop offset="100%" stop-color="#ce93d8"/>
                  </linearGradient>
                </defs>
                <circle class="timer-track" cx="95" cy="95" r="82"/>
                <circle id="timerCircle" cx="95" cy="95" r="82" style="stroke-dasharray:515.2;stroke-dashoffset:515.2"/>
              </svg>
              <div class="timer-inner">
                <div class="timer-digits"><span id="timerHours">00</span>:<span id="timerMins">00</span>:<span id="timerSecs">00</span></div>
                <div id="timerStatus">ÙˆØ§Ù‚Ù</div>
              </div>
            </div>
            <button class="timer-btn" id="timerBtn" onclick="toggleStudy()">â–¶ ÙŠÙ„Ø§ Ù†Ø°Ø§ÙƒØ±</button>
          </div>
        </div>
        <div class="gap-md">
          <div class="glass-card">
            <div class="section-title"><div class="dot" style="background:var(--green)"></div> ØµÙ„ÙˆØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ù‡</div>
            <div class="prayers-grid">
              <button class="prayer-btn" data-prayer="Ø§Ù„ÙØ¬Ø±"    onclick="togglePrayer('Ø§Ù„ÙØ¬Ø±')">ğŸŒ… Ø§Ù„ÙØ¬Ø±</button>
              <button class="prayer-btn" data-prayer="Ø§Ù„Ø¸Ù‡Ø±"    onclick="togglePrayer('Ø§Ù„Ø¸Ù‡Ø±')">â˜€ï¸ Ø§Ù„Ø¸Ù‡Ø±</button>
              <button class="prayer-btn" data-prayer="Ø§Ù„Ø¹ØµØ±"    onclick="togglePrayer('Ø§Ù„Ø¹ØµØ±')">ğŸŒ¤ Ø§Ù„Ø¹ØµØ±</button>
              <button class="prayer-btn" data-prayer="Ø§Ù„Ù…ØºØ±Ø¨"   onclick="togglePrayer('Ø§Ù„Ù…ØºØ±Ø¨')">ğŸŒ† Ø§Ù„Ù…ØºØ±Ø¨</button>
              <button class="prayer-btn" data-prayer="Ø§Ù„Ø¹Ø´Ø§Ø¡"   onclick="togglePrayer('Ø§Ù„Ø¹Ø´Ø§Ø¡')">ğŸŒ™ Ø§Ù„Ø¹Ø´Ø§Ø¡</button>
              <button class="prayer-btn" data-prayer="Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­" onclick="togglePrayer('Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­')">ğŸ•Œ Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­</button>
            </div>
          </div>
          <div class="glass-card">
            <div class="section-title"><div class="dot" style="background:var(--accent2)"></div> Ù‚Ø±Ø¢Ù† Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ù‡</div>
            <div class="quran-input-wrap">
              <input type="number" id="quranInput" class="quran-input" placeholder="ÙƒØ§Ù… ØµÙØ­Ø© Ø§ØªÙ‚Ø±Ø£ØªØŸ" min="0" max="604">
              <button class="save-btn" onclick="saveQuran()">ğŸ’¾ Ø§Ø­ÙØ¸</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div id="tab-leaderboard" class="tab-section">
      <div class="glass-card" style="margin-bottom:0.9rem">
        <div style="color:var(--sub);font-size:0.8rem">ğŸ—“ Ø¯ÙŠ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª <strong style="color:var(--accent)" id="todayLabel"></strong> Ø¨Ø³ â€” Ù…Ø´ ÙØ§ØªØª ğŸ˜¤</div>
      </div>
      <div class="boards-grid">
        <div class="glass-card"><div class="board-title">ğŸ“š ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</div><div id="studyBoard"></div></div>
        <div class="glass-card"><div class="board-title">ğŸ•Œ ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙ„ÙˆØ§Øª</div><div id="prayersBoard"></div></div>
        <div class="glass-card" style="grid-column:1/-1">
          <div class="board-title">ğŸ“– ØªØ±ØªÙŠØ¨ Ø§Ù„Ù‚Ø±Ø¢Ù†</div>
          <div id="quranBoard" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:0.3rem"></div>
        </div>
      </div>
    </div>

    <!-- STATS -->
    <div id="tab-stats" class="tab-section">
      <div class="glass-card">
        <div class="section-title"><div class="dot" style="background:var(--gold)"></div> Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ</div>
        <div class="stats-period-btns">
          <button class="stats-period-btn active" data-period="week"  onclick="loadStats('week')">ğŸ“… Ø¢Ø®Ø± Ø£Ø³Ø¨ÙˆØ¹</button>
          <button class="stats-period-btn"         data-period="month" onclick="loadStats('month')">ğŸ—“ Ø¢Ø®Ø± Ø´Ù‡Ø±</button>
        </div>
        <div id="statsLoading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
        <div id="chartsArea">
          <div class="stats-summary-grid">
            <div class="stats-summary-card"><div class="stats-summary-num" id="statsTotalStudy">-</div><div class="stats-summary-label">ğŸ“š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</div></div>
            <div class="stats-summary-card"><div class="stats-summary-num" id="statsAvgStudy">-</div><div class="stats-summary-label">â± Ù…Ø¹Ø¯Ù„ ÙŠÙˆÙ…ÙŠ</div></div>
            <div class="stats-summary-card"><div class="stats-summary-num" id="statsTotalPrayers">-</div><div class="stats-summary-label">ğŸ•Œ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙ„ÙˆØ§Øª</div></div>
            <div class="stats-summary-card"><div class="stats-summary-num" id="statsTotalQuran">-</div><div class="stats-summary-label">ğŸ“– Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†</div></div>
          </div>
          <div class="glass-card chart-card"><div class="chart-label">ğŸ“š Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© ÙŠÙˆÙ… Ø¨ÙŠÙˆÙ…</div><div class="chart-wrap"><canvas id="studyChart"></canvas></div></div>
          <div class="glass-card chart-card"><div class="chart-label">ğŸ•Œ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙ„ÙˆØ§Øª ÙŠÙˆÙ… Ø¨ÙŠÙˆÙ…</div><div class="chart-wrap"><canvas id="prayersChart"></canvas></div></div>
          <div class="glass-card chart-card"><div class="chart-label">ğŸ“– ØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† ÙŠÙˆÙ… Ø¨ÙŠÙˆÙ…</div><div class="chart-wrap"><canvas id="quranChart"></canvas></div></div>
        </div>
      </div>
    </div>

    <!-- FRIENDS -->
    <div id="tab-friends" class="tab-section">
      <div class="glass-card">
        <div class="section-title"><div class="dot"></div> Ø§Ù„ØµØ­Ø§Ø¨ Ø¯Ù„ÙˆÙ‚ØªÙŠ Ø¨ÙŠØ¹Ù…Ù„ÙˆØ§ Ø¥ÙŠÙ‡ØŸ</div>
        <div class="friends-grid" id="friendsStatus"></div>
      </div>
    </div>

    <!-- CHAT -->
    <div id="tab-chat" class="tab-section">
      <div class="glass-card chat-container">
        <div class="section-title"><div class="dot" style="background:var(--accent2)"></div> Ø´Ø§Øª Ø§Ù„ØµØ­Ø§Ø¨ ğŸ’¬</div>
        <div class="chat-messages" id="chatMessages"><div class="chat-loading">Ø§Ø³ØªÙ†Ù‘Ù‰ Ø¨Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø±Ø³Ø§ÙŠÙ„...</div></div>
        <div class="chat-input-row">
          <input type="text" id="chatInput" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø­Ø§Ø¬Ø© Ù„Ù„ØµØ­Ø§Ø¨..." maxlength="300" onkeydown="if(event.key==='Enter')sendChat()">
          <button class="chat-send-btn" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„ âœˆï¸</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- LOG MODAL -->
<div class="modal" id="logModal" onclick="if(event.target===this)closeLogModal()">
  <div class="modal-box">
    <div class="modal-header"><h3 id="logModalTitle">Ø§Ù„Ø³Ø¬Ù„</h3><button class="modal-close" onclick="closeLogModal()">âœ•</button></div>
    <div class="modal-body" id="logContent"></div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal" onclick="if(event.target===this)closeEditModal()">
  <div class="modal-box">
    <div class="modal-header"><h3 id="editModalTitle">âœï¸ ØªØ¹Ø¯ÙŠÙ„</h3><button class="modal-close" onclick="closeEditModal()">âœ•</button></div>
    <div class="modal-body">
      <div class="section-title" style="font-size:0.85rem;margin-bottom:0.7rem"><div class="dot" style="background:var(--green)"></div> Ø§Ù„ØµÙ„ÙˆØ§Øª</div>
      <div class="edit-checks">
        <label class="edit-check-item"><input type="checkbox" id="edit_Ø§Ù„ÙØ¬Ø±">    ğŸŒ… Ø§Ù„ÙØ¬Ø±</label>
        <label class="edit-check-item"><input type="checkbox" id="edit_Ø§Ù„Ø¸Ù‡Ø±">    â˜€ï¸ Ø§Ù„Ø¸Ù‡Ø±</label>
        <label class="edit-check-item"><input type="checkbox" id="edit_Ø§Ù„Ø¹ØµØ±">    ğŸŒ¤ Ø§Ù„Ø¹ØµØ±</label>
        <label class="edit-check-item"><input type="checkbox" id="edit_Ø§Ù„Ù…ØºØ±Ø¨">   ğŸŒ† Ø§Ù„Ù…ØºØ±Ø¨</label>
        <label class="edit-check-item"><input type="checkbox" id="edit_Ø§Ù„Ø¹Ø´Ø§Ø¡">   ğŸŒ™ Ø§Ù„Ø¹Ø´Ø§Ø¡</label>
        <label class="edit-check-item"><input type="checkbox" id="edit_Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­"> ğŸ•Œ Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­</label>
      </div>
      <div class="edit-field"><label class="edit-label">ğŸ“– ÙƒØ§Ù… ØµÙØ­Ø© Ù‚Ø±Ø¢Ù† Ø§ØªÙ‚Ø±Ø£ØªØŸ</label><input type="number" id="editQuran" class="edit-input" min="0" max="604"></div>
      <div class="edit-field"><label class="edit-label">ğŸ“š ÙƒØ§Ù… Ø³Ø§Ø¹Ø© Ø§ØªØ°Ø§ÙƒØ±ØŸ (Ù…Ø«Ø§Ù„: 2.5 = Ø³Ø§Ø¹ØªÙŠÙ† ÙˆÙ†Øµ)</label><input type="number" id="editStudy" class="edit-input" min="0" max="24" step="0.1"></div>
      <button class="save-edit-btn" onclick="saveEditLog()">âœ… Ø§Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
function showTab(name, btn) {
  document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
  if (name === 'leaderboard') {
    document.getElementById('todayLabel').textContent =
      new Date().toLocaleDateString('ar-EG',{weekday:'long',day:'numeric',month:'long'});
  }
  if (name === 'stats' && typeof loadStats === 'function') loadStats('week');
  if (name === 'chat') {
    const msgs = document.getElementById('chatMessages');
    if (msgs) setTimeout(() => msgs.scrollTop = msgs.scrollHeight, 100);
  }
}

// Fix timer circle dasharray for r=82
document.addEventListener('DOMContentLoaded', () => {
  const c = document.getElementById('timerCircle');
  if (c) { const circ = 2 * Math.PI * 82; c.style.strokeDasharray = circ; c.style.strokeDashoffset = circ; }
});
</script>

</body>
</html>
