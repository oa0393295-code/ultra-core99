<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN CORE V40 | Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ·Ø±Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">
    
    <style>
        /* ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø¨ØµØ±ÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù… (Visual Assets) */
        :root {
            --primary-neon: #06b6d4;
            --secondary-neon: #10b981;
            --danger-neon: #ef4444;
            --background-black: #010409;
            --card-dark: rgba(13, 17, 23, 0.98);
            --border-standard: rgba(48, 54, 61, 0.8);
            --shadow-intensity: 0 0 40px rgba(6, 182, 212, 0.25);
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--background-black);
            color: #e6edf3;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(6, 182, 212, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© (Advanced Glass-morphism) */
        .titan-panel {
            background: var(--card-dark);
            backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid var(--border-standard);
            border-radius: 2.5rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .titan-panel:hover {
            border-color: var(--primary-neon);
            box-shadow: var(--shadow-intensity);
        }

        /* Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙŠØªØ§Ù†ÙŠÙˆÙ… */
        .engine-viewport {
            position: relative;
            width: 450px;
            height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ring-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .ring-bg { fill: none; stroke: #0d1117; stroke-width: 25; }
        .ring-fill {
            fill: none; stroke: var(--primary-neon); stroke-width: 25; stroke-linecap: round;
            stroke-dasharray: 880; stroke-dashoffset: 880;
            transition: stroke-dashoffset 1s linear;
            filter: drop-shadow(0 0 15px var(--primary-neon));
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (Command Buttons) */
        .btn-action {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: #000;
            font-weight: 900;
            padding: 1.5rem 3rem;
            border-radius: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.3s;
        }

        .btn-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(6, 182, 212, 0.4);
        }

        /* ØªØ®ØµÙŠØµ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø¨Ø§Ø± */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-neon); }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¨Ø¶ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† */
        .status-pulse {
            width: 8px; height: 8px; background: var(--primary-neon); border-radius: 50%;
            animation: pulse-ani 1.5s infinite;
        }

        @keyframes pulse-ani {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
        }

        .log-item-card {
            background: rgba(255, 255, 255, 0.02);
            border-right: 4px solid var(--primary-neon);
        }
    </style>
</head>
<body class="antialiased">

    <div id="auth-gate" class="fixed inset-0 z-[1000] bg-black flex flex-col items-center justify-center p-6">
        <div class="mb-12 text-center">
            <h1 class="text-[10rem] font-black text-white italic tracking-tighter leading-none">ØªÙ€ÙŠØªØ§Ù†</h1>
            <p class="text-cyan-500 mono font-bold tracking-[1em] mt-2">V40_OS_LOADER</p>
        </div>
        <button id="btn-login" class="btn-action text-2xl px-20 py-8 rounded-full">ØªÙ€Ø´ØºÙŠÙ„ Ø§Ù„Ù€Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</button>
    </div>

    <div id="titan-app" class="hidden opacity-0 transition-opacity duration-1000">
        <header class="titan-panel m-6 rounded-3xl p-8 flex justify-between items-center sticky top-6 z-50">
            <div class="flex items-center gap-8">
                <div class="w-2 h-16 bg-cyan-500 rounded-full"></div>
                <div>
                    <h2 class="text-4xl font-black italic">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­ÙƒÙ… V40</h2>
                    <p id="meta-user" class="text-xs text-cyan-500 font-bold mono mt-2"></p>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <div class="text-right">
                    <p id="system-clock" class="text-2xl font-black mono text-white">00:00:00</p>
                    <p class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest">ØªØ²Ø§Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: ÙØ¹Ø§Ù„</p>
                </div>
                <button id="btn-logout" class="bg-red-500/10 text-red-500 border border-red-500/20 px-6 py-2 rounded-xl font-bold hover:bg-red-500 hover:text-white transition-all">Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <main class="p-6 grid grid-cols-12 gap-8">
            
            <aside class="col-span-12 lg:col-span-3 flex flex-col gap-8">
                <div class="titan-panel p-10">
                    <div class="flex justify-between items-center mb-10">
                        <h3 class="text-3xl font-black italic">Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                        <span id="prayer-ratio" class="bg-cyan-500/10 text-cyan-500 px-4 py-1 rounded-lg mono font-bold">0/6</span>
                    </div>
                    <div id="prayer-stack" class="space-y-4">
                        </div>
                </div>

                <div class="titan-panel p-10">
                    <h3 class="text-xl font-black mb-6 border-r-4 border-emerald-500 pr-4">ØªØ³Ø¬ÙŠÙ„ ØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†</h3>
                    <div class="flex gap-4">
                        <input type="number" id="quran-val" class="w-full bg-slate-900 border border-slate-800 rounded-2xl p-4 text-white font-black text-2xl outline-none focus:border-cyan-500" placeholder="0">
                        <button id="quran-save" class="bg-emerald-500 text-black px-6 rounded-2xl font-black">Ø­ÙØ¸</button>
                    </div>
                </div>
            </aside>

            <section class="col-span-12 lg:col-span-6 flex flex-col gap-8">
                <div class="titan-panel p-16 flex flex-col items-center justify-center">
                    <div class="engine-viewport">
                        <svg class="ring-svg" viewBox="0 0 320 320">
                            <circle class="ring-bg" cx="160" cy="160" r="140"></circle>
                            <circle id="timer-ring" class="ring-fill" cx="160" cy="160" r="140"></circle>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <h2 id="timer-label" class="text-[8rem] font-black mono text-white leading-none">00:00:00</h2>
                            <span id="engine-status" class="mt-6 text-sm text-cyan-400 font-bold tracking-[0.4em] uppercase">Standby</span>
                        </div>
                    </div>
                    <button id="timer-trigger" class="btn-action w-full max-w-lg mt-12 text-3xl italic">Ø¨Ù€Ø¯Ø¡ Ø§Ù„Ù€Ø¬Ù„Ø³Ø© Ø§Ù„Ø¢Ù†</button>
                    
                    <div class="grid grid-cols-2 gap-10 w-full mt-16 pt-10 border-t border-white/5">
                        <div class="text-center">
                            <p class="text-xs text-slate-500 font-black uppercase tracking-widest mb-2">Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ… (Ø¯Ù‚ÙŠÙ‚Ø©)</p>
                            <p id="dash-mins" class="text-6xl font-black mono text-white">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-slate-500 font-black uppercase tracking-widest mb-2">Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ… (ØµÙØ­Ø©)</p>
                            <p id="dash-quran" class="text-6xl font-black mono text-white">0</p>
                        </div>
                    </div>
                </div>

                <div class="titan-panel p-10">
                    <h3 class="text-2xl font-black italic mb-8">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ</h3>
                    <div id="personal-history" class="space-y-4 max-h-[800px] overflow-y-auto pr-4">
                        </div>
                </div>
            </section>

            <aside class="col-span-12 lg:col-span-3 flex flex-col gap-8">
                <div class="titan-panel p-8">
                    <h3 class="text-xl font-black text-center mb-8 italic tracking-widest border-b border-white/5 pb-4">Ø§Ù„Ø±ØµØ¯ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ Ù„Ø§ÙŠÙ ğŸ“¡</h3>
                    <div id="live-board" class="space-y-4 max-h-[400px] overflow-y-auto">
                        </div>
                </div>

                <div class="titan-panel h-[600px] flex flex-col overflow-hidden">
                    <div class="p-6 bg-slate-900/50 flex justify-between items-center">
                        <span class="text-xs font-black text-cyan-500 tracking-widest uppercase">MESSENGER_V4</span>
                        <div class="status-pulse"></div>
                    </div>
                    <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-6">
                        </div>
                    <div class="p-6 bg-black/40 flex gap-2">
                        <input id="chat-in" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." class="flex-1 bg-slate-900 border-none rounded-xl px-4 py-3 text-white outline-none focus:ring-1 focus:ring-cyan-500">
                        <button id="chat-send" class="bg-cyan-600 text-black px-4 rounded-xl font-black">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <div id="modal-inspector" class="hidden fixed inset-0 z-[2000] modal-overlay flex items-center justify-center p-8">
        <div class="titan-panel w-full max-w-5xl p-16 relative">
            <button onclick="TitanApp.ui.closeInspector()" class="absolute top-8 left-8 text-5xl hover:text-cyan-500">&times;</button>
            <div class="mb-12">
                <h4 id="inspect-user-name" class="text-7xl font-black italic leading-none"></h4>
                <p class="text-cyan-500 mono font-bold mt-4 tracking-widest uppercase">Deep Historical Analytics</p>
            </div>
            <div id="inspect-data-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[600px] overflow-y-auto pr-6">
                </div>
        </div>
    </div>

    <div id="modal-editor" class="hidden fixed inset-0 z-[2001] modal-overlay flex items-center justify-center p-6">
        <div class="titan-panel w-full max-w-xl p-12">
            <h4 id="edit-date-title" class="text-3xl font-black mb-10 italic">ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h4>
            <div class="space-y-8">
                <div>
                    <label class="text-[10px] text-slate-500 font-bold uppercase mb-2 block">Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</label>
                    <input type="number" id="edit-m" class="w-full bg-slate-900 border border-slate-800 rounded-2xl p-6 text-white font-black text-4xl">
                </div>
                <div>
                    <label class="text-[10px] text-slate-500 font-bold uppercase mb-2 block">Ø§Ù„ØµÙØ­Ø§Øª</label>
                    <input type="number" id="edit-q" class="w-full bg-slate-900 border border-slate-800 rounded-2xl p-6 text-white font-black text-4xl">
                </div>
                <div class="flex gap-4 pt-4">
                    <button id="btn-save-edit" class="flex-1 btn-action py-6 text-xl">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    <button onclick="TitanApp.ui.closeEditor()" class="flex-1 bg-slate-800 text-white font-bold rounded-2xl">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, query, collection, orderBy, limit, updateDoc, increment, addDoc, serverTimestamp, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyASLT_wouo9BTjd-dH18x8CLbqBZSMbz04",
            authDomain: "ultra-core.firebaseapp.com",
            projectId: "ultra-core",
            storageBucket: "ultra-core.firebasestorage.app",
            messagingSenderId: "351766462712",
            appId: "1:351766462712:web:e683d8aa0d213b6e59fb0d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const gProvider = new GoogleAuthProvider();

        /**
         * Ù†Ø¸Ø§Ù… TITAN V40 Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠ
         * ØªÙ… ØªÙ‚Ø³ÙŠÙ…Ù‡ Ø¥Ù„Ù‰ ÙˆØ­Ø¯Ø§Øª ÙˆØ¸ÙŠÙÙŠØ© Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ¹Ù‚ÙŠØ¯ ÙˆØ§Ù„ÙƒÙØ§Ø¡Ø©
         */
        const TitanApp = {
            state: {
                user: null,
                secs: 0,
                isRunning: false,
                interval: null,
                currentDate: new Date().toISOString().split('T')[0],
                activeEditDate: null,
                prayers: [
                    {id:'fajr', name:'ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø±'},
                    {id:'dhuhr', name:'ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø±'},
                    {id:'asr', name:'ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ±'},
                    {id:'maghrib', name:'ØµÙ„Ø§Ø© Ø§Ù„Ù…ØºØ±Ø¨'},
                    {id:'isha', name:'ØµÙ„Ø§Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡'},
                    {id:'taraweeh', name:'ØµÙ„Ø§Ø© Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­'}
                ]
            },

            // Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            data: {
                async initializeUser() {
                    const ref = doc(db, "users", TitanApp.state.user.uid);
                    await setDoc(ref, {
                        name: TitanApp.state.user.displayName,
                        uid: TitanApp.state.user.uid,
                        lastSeen: serverTimestamp(),
                        version: "V40_OS"
                    }, { merge: true });
                },

                async syncLog(field, value) {
                    const ref = doc(db, "users", TitanApp.state.user.uid, "logs", TitanApp.state.currentDate);
                    await setDoc(ref, {
                        [field]: increment(value),
                        date: TitanApp.state.currentDate
                    }, { merge: true });
                },

                async updateStatus(status) {
                    if(!TitanApp.state.user) return;
                    await updateDoc(doc(db, "users", TitanApp.state.user.uid), { status });
                }
            },

            // Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¹Ø¯Ø§Ø¯
            timer: {
                start() {
                    if(TitanApp.state.isRunning) return;
                    TitanApp.state.isRunning = true;
                    localStorage.setItem(`titan_run_${TitanApp.state.user.uid}`, "true");
                    TitanApp.ui.updateEngineState(true);
                    TitanApp.data.updateStatus("Ø¨ÙŠØ°Ø§ÙƒØ± Ø¯Ù„ÙˆÙ‚ØªÙŠ ğŸ”¥");

                    TitanApp.state.interval = setInterval(() => {
                        TitanApp.state.secs++;
                        localStorage.setItem(`titan_secs_${TitanApp.state.user.uid}`, TitanApp.state.secs);
                        TitanApp.ui.refreshTimerDisplay();

                        // Ù…Ø²Ø§Ù…Ù†Ø© ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
                        if(TitanApp.state.secs % 60 === 0) {
                            TitanApp.data.syncLog('mins', 1);
                        }

                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙŠØ© ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
                        if(TitanApp.state.secs % 30 === 0) {
                            const m = Math.floor(TitanApp.state.secs / 60);
                            TitanApp.data.updateStatus(`Ø¨ÙŠØ°Ø§ÙƒØ± Ø¯Ù„ÙˆÙ‚ØªÙŠ Ø¨Ù‚Ø§Ù„Ù‡ ${m} Ø¯Ù‚ÙŠÙ‚Ø© ğŸ”¥`);
                        }
                    }, 1000);
                },

                stop() {
                    clearInterval(TitanApp.state.interval);
                    TitanApp.state.isRunning = false;
                    localStorage.setItem(`titan_run_${TitanApp.state.user.uid}`, "false");
                    TitanApp.ui.updateEngineState(false);
                    TitanApp.data.updateStatus("");
                },

                toggle() {
                    TitanApp.state.isRunning ? this.stop() : this.start();
                }
            },

            // Ù…Ø­Ø±Ùƒ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            ui: {
                showApp(isAuth) {
                    document.getElementById('auth-gate').style.display = isAuth ? 'none' : 'flex';
                    const appEl = document.getElementById('titan-app');
                    appEl.classList.toggle('hidden', !isAuth);
                    if(isAuth) {
                        setTimeout(() => appEl.style.opacity = '1', 100);
                        this.renderPrayers();
                    }
                },

                refreshTimerDisplay() {
                    const s = TitanApp.state.secs;
                    const h = Math.floor(s/3600).toString().padStart(2,'0');
                    const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
                    const sc = (s%60).toString().padStart(2,'0');
                    document.getElementById('timer-label').innerText = `${h}:${m}:${sc}`;
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù†Ø²ÙŠØ§Ø­ Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ
                    document.getElementById('timer-ring').style.strokeDashoffset = 880 - ((s%60)/60 * 880);
                },

                updateEngineState(running) {
                    const btn = document.getElementById('timer-trigger');
                    const status = document.getElementById('engine-status');
                    btn.innerText = running ? "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù€Ø¹Ù…Ù„ÙŠØ©" : "Ø¨Ù€Ø¯Ø¡ Ø§Ù„Ù€Ø¬Ù„Ø³Ø© Ø§Ù„Ø¢Ù†";
                    btn.style.filter = running ? "hue-rotate(150deg)" : "none";
                    status.innerText = running ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù€ØªÙ†ÙÙŠØ°..." : "Standby";
                    status.classList.toggle('text-emerald-400', running);
                },

                renderPrayers() {
                    const container = document.getElementById('prayer-stack');
                    container.innerHTML = TitanApp.state.prayers.map(p => `
                        <div class="flex items-center justify-between p-5 bg-slate-900/40 rounded-2xl border border-slate-800 hover:border-cyan-500/30 transition-all">
                            <span class="font-bold text-slate-300">${p.name}</span>
                            <input type="checkbox" id="chk-${p.id}" onchange="TitanApp.handlers.handlePrayer('${p.id}')" class="w-7 h-7 accent-cyan-500 rounded-lg cursor-pointer">
                        </div>
                    `).join('');
                },

                openInspector(uid, name) {
                    document.getElementById('inspect-user-name').innerText = name;
                    const grid = document.getElementById('inspect-data-grid');
                    grid.innerHTML = '<div class="col-span-full py-20 text-center mono text-cyan-500 animate-pulse">Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ‚Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...</div>';
                    document.getElementById('modal-inspector').classList.remove('hidden');

                    getDocs(query(collection(db, "users", uid, "logs"), orderBy("date", "desc"))).then(snap => {
                        grid.innerHTML = snap.docs.map(doc => {
                            const d = doc.data();
                            return `
                                <div class="p-8 log-item-card rounded-3xl">
                                    <p class="text-[10px] text-cyan-500 mono mb-3 tracking-widest">${d.date}</p>
                                    <p class="text-3xl font-black text-white">${d.mins || 0} Ø¯Ù‚ÙŠÙ‚Ø© <span class="text-slate-700 mx-2">|</span> ${d.quran || 0} ØµÙØ­Ø©</p>
                                    <p class="text-xs text-slate-500 mt-4 leading-relaxed font-bold italic">${d.readable_prayers || 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ ØµÙ„ÙˆØ§Øª'}</p>
                                </div>
                            `;
                        }).join('');
                    });
                },

                closeInspector() { document.getElementById('modal-inspector').classList.add('hidden'); },

                openEditor(date, mins, quran) {
                    TitanApp.state.activeEditDate = date;
                    document.getElementById('edit-date-title').innerText = `ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„: ${date}`;
                    document.getElementById('edit-m').value = mins;
                    document.getElementById('edit-q').value = quran;
                    document.getElementById('modal-editor').classList.remove('hidden');
                },

                closeEditor() { document.getElementById('modal-editor').classList.add('hidden'); }
            },

            // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Logic Handlers)
            handlers: {
                async handlePrayer(pId) {
                    const isChecked = document.getElementById(`chk-${pId}`).checked;
                    const ref = doc(db, "users", TitanApp.state.user.uid, "logs", TitanApp.state.currentDate);
                    const snap = await getDoc(ref);
                    let habits = snap.exists() ? (snap.data().habits || {}) : {};
                    habits[pId] = isChecked;

                    const pNames = TitanApp.state.prayers.filter(p => habits[p.id]).map(p => p.name.replace('ØµÙ„Ø§Ø© ', '')).join(' â€¢ ');
                    await setDoc(ref, { habits, readable_prayers: pNames, date: TitanApp.state.currentDate }, { merge: true });
                },

                async handleManualEdit() {
                    const nM = parseInt(document.getElementById('edit-m').value) || 0;
                    const nQ = parseInt(document.getElementById('edit-q').value) || 0;
                    const ref = doc(db, "users", TitanApp.state.user.uid, "logs", TitanApp.state.activeEditDate);
                    
                    await updateDoc(ref, { mins: nM, quran: nQ });

                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ø­Ø¯Ø« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„Ù€ Storage
                    if(TitanApp.state.activeEditDate === TitanApp.state.currentDate) {
                        TitanApp.state.secs = nM * 60;
                        localStorage.setItem(`titan_secs_${TitanApp.state.user.uid}`, TitanApp.state.secs);
                        TitanApp.ui.refreshTimerDisplay();
                    }
                    TitanApp.ui.closeEditor();
                }
            }
        };

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (Real-time Listeners)
        function initListeners() {
            // Ø±ØµØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ø§ÙŠÙ
            onSnapshot(query(collection(db, "users"), limit(50)), (snap) => {
                const board = document.getElementById('live-board');
                const users = snap.docs.map(d => d.data()).sort((a,b) => (b.status ? 1 : 0) - (a.status ? 1 : 0));
                board.innerHTML = users.map(u => `
                    <div onclick="TitanApp.ui.openInspector('${u.uid}', '${u.name}')" class="flex items-center justify-between p-5 bg-slate-900/30 rounded-2xl border border-white/5 cursor-pointer hover:bg-slate-800 transition-all">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-cyan-500/10 rounded-xl flex items-center justify-center font-black text-cyan-500 border border-cyan-500/10 text-xl">${u.name[0]}</div>
                            <div>
                                <p class="text-sm font-black text-white">${u.name}</p>
                                ${u.status ? `<div class="flex items-center gap-2 mt-1"><div class="status-pulse"></div><p class="text-[9px] text-cyan-500 font-bold mono">${u.status}</p></div>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            });

            // Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø´Ø®ØµÙŠ
            onSnapshot(query(collection(db, "users", TitanApp.state.user.uid, "logs"), orderBy("date", "desc")), (snap) => {
                const history = document.getElementById('personal-history');
                history.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    if(d.date === TitanApp.state.currentDate) {
                        document.getElementById('dash-mins').innerText = d.mins || 0;
                        document.getElementById('dash-quran').innerText = d.quran || 0;
                        document.getElementById('prayer-ratio').innerText = `${Object.values(d.habits || {}).filter(v=>v).length}/6`;
                    }
                    return `
                        <div class="p-8 log-item-card rounded-2xl flex justify-between items-center group relative overflow-hidden">
                            <div class="relative z-10">
                                <p class="text-[9px] text-cyan-500 mono font-bold mb-1">${d.date}</p>
                                <p class="text-2xl font-black text-white">${d.mins || 0} Ø¯Ù‚ÙŠÙ‚Ø© | ${d.quran || 0} ØµÙØ­Ø©</p>
                                <p class="text-[10px] text-slate-500 mt-3 italic font-bold">${d.readable_prayers || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ ØµÙ„ÙˆØ§Øª'}</p>
                            </div>
                            <button onclick="TitanApp.ui.openEditor('${d.date}', ${d.mins || 0}, ${d.quran || 0})" class="opacity-0 group-hover:opacity-100 bg-white text-black px-6 py-3 rounded-xl font-black text-[10px] transition-all hover:scale-105 z-20">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</button>
                        </div>
                    `;
                }).join('');
            });

            // Ø´Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
            onSnapshot(query(collection(db, "chat"), orderBy("timestamp", "asc"), limit(100)), (snap) => {
                const box = document.getElementById('chat-box');
                box.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    const isMe = m.uid === TitanApp.state.user.uid;
                    return `
                        <div class="flex flex-col ${isMe?'items-end':'items-start'}">
                            <span class="text-[9px] font-bold text-slate-600 mb-1 uppercase">${m.sender}</span>
                            <div class="${isMe?'bg-cyan-600 text-black shadow-lg shadow-cyan-500/20':'bg-slate-800 text-white'} px-5 py-3 rounded-2xl text-xs font-bold max-w-[85%]">${m.text}</div>
                        </div>
                    `;
                }).join('');
                box.scrollTop = box.scrollHeight;
            });

            // Ù…Ø²Ø§Ù…Ù†Ø© ØªØ´ÙŠÙƒ Ø¨ÙˆÙƒØ³ Ø§Ù„ØµÙ„ÙˆØ§Øª Ù„Ù„ÙŠÙˆÙ…
            onSnapshot(doc(db, "users", TitanApp.state.user.uid, "logs", TitanApp.state.currentDate), (snap) => {
                if(snap.exists() && snap.data().habits) {
                    const h = snap.data().habits;
                    TitanApp.state.prayers.forEach(p => {
                        const el = document.getElementById(`chk-${p.id}`);
                        if(el) el.checked = h[p.id] || false;
                    });
                }
            });
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ (Bootloader)
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                TitanApp.state.user = user;
                TitanApp.ui.showApp(true);
                document.getElementById('meta-user').innerText = `ACCESS_GRANTED // ID: ${user.uid.substring(0,8)} // ${user.displayName}`;
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                const savedSecs = localStorage.getItem(`titan_secs_${user.uid}`);
                TitanApp.state.secs = savedSecs ? parseInt(savedSecs) : 0;
                
                if(localStorage.getItem(`titan_run_${user.uid}`) === "true") {
                    TitanApp.timer.start();
                } else {
                    TitanApp.ui.refreshTimerDisplay();
                }

                await TitanApp.data.initializeUser();
                initListeners();
            } else {
                TitanApp.ui.showApp(false);
            }
        });

        // Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (DOM Events)
        document.getElementById('btn-login').onclick = () => signInWithPopup(auth, gProvider);
        document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => { localStorage.clear(); window.location.reload(); });
        document.getElementById('timer-trigger').onclick = () => TitanApp.timer.toggle();
        
        document.getElementById('quran-save').onclick = async () => {
            const v = parseInt(document.getElementById('quran-val').value) || 0;
            if(v > 0) {
                await TitanApp.data.syncLog('quran', v);
                document.getElementById('quran-val').value = '';
            }
        };

        document.getElementById('chat-send').onclick = async () => {
            const inp = document.getElementById('chat-in');
            if(!inp.value.trim()) return;
            await addDoc(collection(db, "chat"), {
                text: inp.value,
                sender: TitanApp.state.user.displayName,
                uid: TitanApp.state.user.uid,
                timestamp: serverTimestamp()
            });
            inp.value = '';
        };

        document.getElementById('btn-save-edit').onclick = () => TitanApp.handlers.handleManualEdit();

        // Ø³Ø§Ø¹Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        setInterval(() => {
            document.getElementById('system-clock').innerText = new Date().toLocaleTimeString('en-US', { hour12: false });
        }, 1000);

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        window.addEventListener('beforeunload', () => TitanApp.data.updateStatus(""));

        // Ø±Ø¨Ø· Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ù…Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª
        window.TitanApp = TitanApp;

    </script>
</body>
</html>