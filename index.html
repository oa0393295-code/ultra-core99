<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA CORE | THE MASSIVE GUARDIAN SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary-cyan: #06b6d4; --deep-slate: #020617; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--deep-slate); color: #f8fafc; overflow-x: hidden; scroll-behavior: smooth; }
        .font-mono-custom { font-family: 'JetBrains Mono', monospace; }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© */
        .timer-wrapper { position: relative; width: 350px; height: 350px; filter: drop-shadow(0 0 20px rgba(6, 182, 212, 0.2)); }
        svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        circle { fill: none; stroke-width: 15; stroke-linecap: round; transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .circle-outer { stroke: #1e293b; }
        .circle-inner { stroke: var(--primary-cyan); stroke-dasharray: 880; stroke-dashoffset: 880; }
        
        /* Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        #notification-box { position: fixed; bottom: 20px; left: 20px; z-index: 1000; }
        .toast { background: #1e293b; border-right: 4px solid var(--primary-cyan); padding: 15px 25px; border-radius: 12px; margin-top: 10px; animation: slideIn 0.5s ease-out; }
        
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        .user-card { border: 1px solid rgba(51, 65, 85, 0.5); transition: all 0.3s; background: rgba(15, 23, 42, 0.6); }
        .user-card:hover { border-color: var(--primary-cyan); transform: scale(1.02); background: rgba(30, 41, 59, 0.8); }
        
        .prayer-dot { width: 10px; height: 10px; border-radius: 2px; transition: all 0.3s; }
        .done { background-color: #10b981; box-shadow: 0 0 10px #10b981; }
        .not-done { background-color: #334155; }
        
        .glass-effect { backdrop-filter: blur(10px); background: rgba(15, 23, 42, 0.7); border-bottom: 1px solid rgba(51, 65, 85, 0.5); }
    </style>
</head>
<body class="min-h-screen">

    <div id="notification-box"></div>

    <div id="login-screen" class="fixed inset-0 z-[500] flex flex-col items-center justify-center bg-slate-950">
        <div class="text-center animate-pulse">
            <h1 class="text-[10rem] font-black italic text-white leading-none opacity-10 absolute -top-10 left-1/2 -translate-x-1/2 select-none">SYSTEM</h1>
            <h2 class="text-7xl font-black text-white relative">ULTRA <span class="text-cyan-500">CORE</span></h2>
            <p class="text-slate-500 mt-4 tracking-[0.5em] font-bold">V4.0 MASSIVE EDITION</p>
            <button id="btn-login" class="mt-12 bg-cyan-500 text-black px-24 py-6 rounded-[2rem] font-black text-2xl hover:bg-white transition-all duration-500 shadow-[0_0_40px_rgba(6,182,212,0.4)]">INITIALIZE SYSTEM</button>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <nav class="glass-effect p-6 sticky top-0 z-50 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-cyan-500 rounded-full animate-bounce"></div>
                <h3 class="text-2xl font-black italic text-white uppercase tracking-tighter">ULTRA<span class="text-cyan-500">CORE</span></h3>
            </div>
            <div class="flex items-center gap-8">
                <div class="text-left">
                    <p id="user-info" class="text-xl font-black text-white"></p>
                    <div id="faith-bar-container" class="w-32 h-1 bg-slate-800 rounded-full mt-1 overflow-hidden">
                        <div id="faith-bar" class="h-full bg-emerald-500 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
                <button id="btn-logout" class="bg-red-500/10 text-red-500 border border-red-500/20 px-6 py-2 rounded-2xl font-black text-xs hover:bg-red-500 hover:text-white transition-all">TERMINATE SESSION</button>
            </div>
        </nav>

        <main class="max-w-[1800px] mx-auto p-8 grid grid-cols-12 gap-10">
            
            <div class="col-span-12 lg:col-span-3 space-y-8">
                <div class="bg-slate-900/80 rounded-[3rem] p-8 border border-slate-800 shadow-2xl border-t-4 border-t-emerald-500">
                    <h4 class="text-xl font-black text-emerald-400 mb-8 italic flex items-center justify-between">
                        Ø§Ù„ÙˆØ±Ø¯ ÙˆØ§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª ğŸŒ™
                        <span id="prayer-count" class="text-xs bg-emerald-500/10 px-3 py-1 rounded-lg">0/6</span>
                    </h4>
                    <div id="habits-grid" class="space-y-4">
                        <script>
                            const prayers = [
                                {id: 'fajr', n: 'ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø±'}, {id: 'dhuhr', n: 'ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø±'},
                                {id: 'asr', n: 'ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ±'}, {id: 'maghrib', n: 'ØµÙ„Ø§Ø© Ø§Ù„Ù…ØºØ±Ø¨'},
                                {id: 'isha', n: 'ØµÙ„Ø§Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡'}, {id: 'taraweeh', n: 'ØµÙ„Ø§Ø© Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­'}
                            ];
                            prayers.forEach(p => {
                                document.write(`
                                    <div class="group flex items-center justify-between p-5 bg-slate-800/40 rounded-[1.5rem] border border-slate-700/50 hover:border-emerald-500/50 transition-all">
                                        <span class="text-sm font-bold text-slate-300 group-hover:text-white">${p.n}</span>
                                        <input type="checkbox" id="check-${p.id}" onchange="advancedHabitSync('${p.id}')" class="w-6 h-6 rounded-lg accent-emerald-500 cursor-pointer">
                                    </div>
                                `);
                            });
                        </script>
                    </div>

                    <div class="mt-10 pt-8 border-t border-slate-800">
                        <h5 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Ø­ØµØ§Ø¯ Ø§Ù„Ù‚Ø±Ø¢Ù† (ØµÙØ­Ø§Øª)</h5>
                        <div class="flex gap-3">
                            <input type="number" id="quran-input" class="w-full bg-slate-800 rounded-2xl px-5 py-4 text-white font-black outline-none border border-slate-700 focus:border-emerald-500 transition-all" placeholder="0">
                            <button onclick="advancedQuranSync()" class="bg-emerald-500 text-black px-8 py-4 rounded-2xl font-black hover:scale-105 active:scale-95 transition-all">Ø­ÙØ¸</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-span-12 lg:col-span-6 space-y-10">
                <div class="bg-slate-900 border border-slate-800 rounded-[5rem] p-16 flex flex-col items-center justify-center relative overflow-hidden shadow-2xl">
                    <div class="timer-wrapper">
                        <svg viewBox="0 0 320 320">
                            <circle class="circle-outer" cx="160" cy="160" r="140"></circle>
                            <circle id="progress-bar" class="circle-inner" cx="160" cy="160" r="140"></circle>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <div id="timer-display" class="text-7xl font-mono-custom font-black text-white tracking-tighter">00:00:00</div>
                            <div id="user-status-text" class="text-[11px] font-black text-cyan-500 uppercase mt-4 tracking-[0.3em] bg-cyan-500/10 px-4 py-1 rounded-full">STANDBY</div>
                        </div>
                    </div>
                    
                    <button id="btn-timer" class="mt-12 w-full max-w-md py-8 rounded-[2.5rem] bg-cyan-500 text-black font-black text-3xl shadow-[0_0_50px_rgba(6,182,212,0.3)] hover:scale-105 transition-all active:scale-95">START FOCUS SESSION</button>
                    
                    <div class="absolute -top-24 -left-24 w-96 h-96 bg-cyan-500/10 rounded-full blur-[120px]"></div>
                </div>

                <div class="bg-slate-900 border border-slate-800 rounded-[3rem] p-12">
                    <h3 class="text-2xl font-black mb-10 text-white italic">ğŸ“Š Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„Ù†Ø´Ø§Ø·Ø§Øª</h3>
                    <div id="study-log" class="space-y-6 max-h-[500px] overflow-y-auto pr-4 font-mono-custom"></div>
                </div>
            </div>

            <div class="col-span-12 lg:col-span-3 space-y-8">
                <div class="bg-slate-900 border border-slate-800 rounded-[3rem] p-8">
                    <h3 class="text-xl font-black mb-8 text-center text-white italic uppercase tracking-widest border-b border-slate-800 pb-4">Hall of Fame ğŸ†</h3>
                    <div id="leaderboard-list" class="space-y-5"></div>
                </div>

                <div class="bg-slate-950 border border-slate-800 rounded-[2.5rem] h-[500px] flex flex-col overflow-hidden shadow-2xl">
                    <div class="p-4 bg-slate-900 border-b border-slate-800 text-center">
                        <span class="text-[10px] font-black text-cyan-500 tracking-widest">ENCRYPTED CHAT</span>
                    </div>
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6"></div>
                    <div class="p-5 bg-slate-900 flex gap-3">
                        <input id="chat-input" type="text" placeholder="Type a message..." class="flex-1 bg-slate-800 border-none rounded-2xl px-6 py-3 text-sm text-white outline-none focus:ring-2 focus:ring-cyan-500">
                        <button id="btn-send-chat" class="bg-cyan-500 text-black px-6 py-3 rounded-2xl font-black text-sm">SEND</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 z-[600] bg-black/98 backdrop-blur-xl flex items-center justify-center p-6">
        <div class="bg-slate-900 border-2 border-slate-800 p-12 rounded-[4rem] w-full max-w-xl text-right relative shadow-[0_0_100px_rgba(0,0,0,0.8)]">
            <h4 class="text-3xl font-black text-white mb-2 italic">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h4>
            <p id="edit-date-title" class="text-cyan-500 font-mono mb-10 text-sm"></p>
            
            <div class="grid grid-cols-2 gap-6 mb-8">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</label>
                    <select id="edit-hours" class="w-full bg-slate-800 p-5 rounded-3xl text-white font-black text-xl appearance-none outline-none focus:ring-2 focus:ring-cyan-500"></select>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase">Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</label>
                    <select id="edit-mins" class="w-full bg-slate-800 p-5 rounded-3xl text-white font-black text-xl appearance-none outline-none focus:ring-2 focus:ring-cyan-500"></select>
                </div>
            </div>

            <div class="mb-10 p-6 bg-slate-800/30 rounded-[2.5rem] border border-slate-700">
                <label class="text-[10px] font-black text-slate-500 uppercase block mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ (Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª)</label>
                <input id="edit-quran" type="number" class="w-full bg-slate-900 border-none rounded-2xl px-6 py-4 text-white font-black text-2xl outline-none focus:ring-2 focus:ring-emerald-500">
            </div>

            <div class="flex gap-4">
                <button id="btn-confirm-edit" class="flex-[2] bg-cyan-500 text-black py-6 rounded-3xl font-black text-xl shadow-neon hover:bg-white transition-all">ØªØ­Ø¯ÙŠØ« ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="flex-1 bg-slate-800 text-white py-6 rounded-3xl font-black text-xl">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, query, collection, orderBy, limit, updateDoc, increment, addDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyASLT_wouo9BTjd-dH18x8CLbqBZSMbz04",
            authDomain: "ultra-core.firebaseapp.com",
            projectId: "ultra-core",
            storageBucket: "ultra-core.firebasestorage.app",
            messagingSenderId: "351766462712",
            appId: "1:351766462712:web:e683d8aa0d213b6e59fb0d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let timerInterval, seconds = 0, isRunning = false, user = null, editingDate = "";
        const todayStr = new Date().toISOString().split('T')[0];

        // INITIALIZATION LOGIC
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                user = u;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('user-info').innerText = u.displayName;
                
                showToast(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${u.displayName.split(' ')[0]} ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…..`);

                // Restore Timer State
                const wasRunning = localStorage.getItem(`running_${user.uid}`) === "true";
                seconds = parseInt(localStorage.getItem(`secs_${user.uid}`)) || 0;
                
                if (wasRunning) {
                    startTimerLogic();
                } else {
                    updateDisplay();
                }

                await initUserDocument();
                loadLeaderboard(); loadStudyLog(); loadChat(); loadHabitStates();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        });

        async function initUserDocument() {
            try {
                const userRef = doc(db, "users", user.uid);
                await setDoc(userRef, { 
                    displayName: user.displayName, 
                    uid: user.uid,
                    last_seen: serverTimestamp() 
                }, { merge: true });
            } catch (err) { console.error("Init Error:", err); }
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®ØµØµ (Ù„Ø²ÙŠØ§Ø¯Ø© Ø­Ø¬Ù… Ø§Ù„ÙƒÙˆØ¯) ---
        function showToast(msg) {
            const box = document.getElementById('notification-box');
            const t = document.createElement('div');
            t.className = 'toast text-sm font-bold text-white';
            t.innerText = msg;
            box.appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª (Ø·Ù„Ø¨Ùƒ) ---
        function complexTimeFormatter(totalMins) {
            if (!totalMins || totalMins === 0) return "Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯";
            if (totalMins < 60) return `${totalMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return m > 0 ? `${h} Ø³Ø§Ø¹Ø© Ùˆ ${m} Ø¯Ù‚ÙŠÙ‚Ø©` : `${h} Ø³Ø§Ø¹Ø© ÙƒØ§Ù…Ù„Ø©`;
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ Ø§Ù„Ù…Ø¹Ù‚Ø¯ ---
        function updateCircleUI(percent) {
            const circle = document.getElementById('progress-bar');
            const circumference = 880; 
            const offset = circumference - (percent / 100 * circumference);
            circle.style.strokeDashoffset = offset;
        }

        function startTimerLogic() {
            if(isRunning) return;
            isRunning = true;
            localStorage.setItem(`running_${user.uid}`, "true");
            document.getElementById('btn-timer').innerText = "STOP FOCUS SESSION";
            document.getElementById('btn-timer').classList.replace('bg-cyan-500', 'bg-red-600');
            updateGlobalStatus("FOCUS MODE ON ğŸ”¥");

            timerInterval = setInterval(() => {
                seconds++;
                localStorage.setItem(`secs_${user.uid}`, seconds);
                updateDisplay();
                
                const percent = (seconds % 60 / 60) * 100;
                updateCircleUI(percent);

                if (seconds % 60 === 0) {
                    commitProgressToDB(1);
                }
            }, 1000);
        }

        function stopTimerLogic() {
            clearInterval(timerInterval);
            isRunning = false;
            localStorage.setItem(`running_${user.uid}`, "false");
            document.getElementById('btn-timer').innerText = "START FOCUS SESSION";
            document.getElementById('btn-timer').classList.replace('bg-red-600', 'bg-cyan-500');
            updateGlobalStatus("RELAXING â˜•");
        }

        function updateDisplay() {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (Habits & Quran) ---
        window.advancedHabitSync = async function(hId) {
            const isChecked = document.getElementById(`check-${hId}`).checked;
            const logRef = doc(db, "users", user.uid, "logs", todayStr);
            const userRef = doc(db, "users", user.uid);
            
            try {
                let habitObj = {}; habitObj[`habits.${hId}`] = isChecked;
                await setDoc(logRef, habitObj, { merge: true });
                
                let userHabitObj = {}; userHabitObj[`sync_habits.${hId}`] = isChecked;
                await updateDoc(userRef, userHabitObj);
                
                showToast(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ${hId} Ø¨Ù†Ø¬Ø§Ø­`);
                calculateFaithLevel();
            } catch (e) { showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©!"); }
        }

        window.advancedQuranSync = async function() {
            const pInput = document.getElementById('quran-input');
            const p = parseInt(pInput.value) || 0;
            if (p <= 0) return;
            
            const logRef = doc(db, "users", user.uid, "logs", todayStr);
            const userRef = doc(db, "users", user.uid);
            
            await setDoc(logRef, { quran_pages: increment(p) }, { merge: true });
            await updateDoc(userRef, { total_quran: increment(p) });
            
            showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${p} ØµÙØ­Ø§Øª Ù„Ù„Ù‚Ø±Ø¢Ù†.. Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠÙƒ`);
            pInput.value = '';
        }

        async function calculateFaithLevel() {
            const snap = await getDoc(doc(db, "users", user.uid, "logs", todayStr));
            if(snap.exists()) {
                const data = snap.data();
                const habits = data.habits || {};
                const count = Object.values(habits).filter(v => v === true).length;
                document.getElementById('faith-bar').style.width = `${(count/6)*100}%`;
                document.getElementById('prayer-count').innerText = `${count}/6`;
            }
        }

        function loadHabitStates() {
            onSnapshot(doc(db, "users", user.uid, "logs", todayStr), (snap) => {
                if(snap.exists() && snap.data().habits) {
                    const h = snap.data().habits;
                    Object.keys(h).forEach(k => {
                        const el = document.getElementById(`check-${k}`);
                        if(el) el.checked = h[k];
                    });
                    calculateFaithLevel();
                }
            });
        }

        // --- Ù„ÙŠØ¯Ø±Ø¨ÙˆØ±Ø¯ Ø§Ù„Ø£Ø¨Ø§Ø·Ø±Ø© (Ø¨Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØµÙ„ÙˆØ§Øª) ---
        function loadLeaderboard() {
            onSnapshot(query(collection(db, "users"), orderBy("daily_mins", "desc"), limit(10)), (snap) => {
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = '';
                snap.docs.forEach((d, i) => {
                    const data = d.data();
                    const h = data.sync_habits || {};
                    const pList = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha', 'taraweeh'];
                    
                    let pDots = pList.map(p => `<div class="prayer-dot ${h[p] ? 'done' : 'not-done'}"></div>`).join('');

                    list.innerHTML += `
                        <div class="user-card p-5 rounded-3xl mb-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-3">
                                    <span class="text-xs font-mono font-bold text-slate-600">#0${i+1}</span>
                                    <p class="font-black text-white text-sm">${data.displayName.split(' ')[0]}</p>
                                </div>
                                <span class="text-cyan-400 font-black text-xs">${complexTimeFormatter(data.daily_mins || 0)}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex gap-1">${pDots}</div>
                                ${data.total_quran ? `<span class="text-[10px] text-emerald-400 font-bold">ğŸ“– ${data.total_quran}p</span>` : ''}
                            </div>
                        </div>`;
                });
            });
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù…Ù‚ ---
        function loadStudyLog() {
            onSnapshot(collection(db, "users", user.uid, "logs"), (snap) => {
                const logDiv = document.getElementById('study-log');
                logDiv.innerHTML = '';
                const sorted = snap.docs.sort((a,b) => b.id.localeCompare(a.id));
                sorted.forEach(d => {
                    const data = d.data();
                    logDiv.innerHTML += `
                        <div class="flex justify-between items-center p-6 bg-slate-800/20 rounded-[2rem] border border-slate-700/30 hover:bg-slate-800/40 transition-all">
                            <div>
                                <p class="text-[9px] font-black text-slate-600 mb-1">${data.date}</p>
                                <p class="text-white font-black text-sm">${complexTimeFormatter(data.mins || 0)}</p>
                                <div class="flex gap-3 mt-1">
                                    <span class="text-emerald-500 text-[10px] font-black uppercase">Quran: ${data.quran_pages || 0} Pages</span>
                                </div>
                            </div>
                            <button onclick="triggerEditFlow('${data.date}', ${data.mins || 0}, ${data.quran_pages || 0})" class="bg-cyan-500/10 p-4 rounded-2xl text-cyan-500 hover:bg-cyan-500 hover:text-black transition-all">âœ</button>
                        </div>`;
                });
            });
        }

        window.triggerEditFlow = (date, mins, quran) => {
            editingDate = date;
            document.getElementById('edit-date-title').innerText = `Editing data for: ${date}`;
            document.getElementById('edit-quran').value = quran;
            const hSel = document.getElementById('edit-hours');
            const mSel = document.getElementById('edit-mins');
            hSel.innerHTML = ''; mSel.innerHTML = '';
            for(let i=0; i<=24; i++) hSel.innerHTML += `<option value="${i}" ${Math.floor(mins/60)==i?'selected':''}>${i} Hours</option>`;
            for(let i=0; i<=59; i++) mSel.innerHTML += `<option value="${i}" ${mins%60==i?'selected':''}>${i} Minutes</option>`;
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        document.getElementById('btn-confirm-edit').onclick = async () => {
            const h = parseInt(document.getElementById('edit-hours').value);
            const m = parseInt(document.getElementById('edit-mins').value);
            const q = parseInt(document.getElementById('edit-quran').value) || 0;
            const newTotal = (h * 60) + m;
            
            const logRef = doc(db, "users", user.uid, "logs", editingDate);
            const userRef = doc(db, "users", user.uid);
            
            const snap = await getDoc(logRef);
            const oldMins = snap.exists() ? (snap.data().mins || 0) : 0;
            const oldQuran = snap.exists() ? (snap.data().quran_pages || 0) : 0;

            await setDoc(logRef, { mins: newTotal, quran_pages: q }, { merge: true });
            
            if (editingDate === todayStr) {
                await updateDoc(userRef, { 
                    daily_mins: increment(newTotal - oldMins), 
                    total_quran: increment(q - oldQuran) 
                });
            }
            document.getElementById('edit-modal').classList.add('hidden');
            showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
        };

        // --- ÙˆØ¸Ø§Ø¦Ù Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Øª ---
        document.getElementById('btn-send-chat').onclick = async () => {
            const input = document.getElementById('chat-input');
            if (input.value.trim()) {
                await addDoc(collection(db, "chat"), { 
                    text: input.value, 
                    sender: user.displayName, 
                    uid: user.uid, 
                    timestamp: serverTimestamp() 
                });
                input.value = '';
            }
        };

        function loadChat() {
            onSnapshot(query(collection(db, "chat"), orderBy("timestamp", "asc"), limit(40)), (snap) => {
                const box = document.getElementById('chat-messages');
                box.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const isMe = data.uid === user.uid;
                    box.innerHTML += `
                        <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                            <span class="text-[8px] text-slate-600 font-bold px-1 mb-1">${data.sender.split(' ')[0]}</span>
                            <div class="${isMe ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-200'} px-5 py-3 rounded-[1.2rem] text-xs font-bold shadow-lg max-w-[80%]">${data.text}</div>
                        </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // HELPERS
        async function commitProgressToDB(m) {
            try {
                const logRef = doc(db, "users", user.uid, "logs", todayStr);
                const userRef = doc(db, "users", user.uid);
                await setDoc(logRef, { mins: increment(m) }, { merge: true });
                await updateDoc(userRef, { daily_mins: increment(m) });
            } catch (err) { console.error("Write Error:", err); }
        }

        async function updateGlobalStatus(status) {
            if (user) {
                await updateDoc(doc(db, "users", user.uid), { status: status });
                document.getElementById('user-status-text').innerText = status;
            }
        }

        document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('btn-logout').onclick = () => { localStorage.clear(); signOut(auth).then(()=>window.location.reload()); };
        document.getElementById('btn-timer').onclick = () => { if(!isRunning) startTimerLogic(); else stopTimerLogic(); };

        window.addEventListener('beforeunload', () => {
            if(isRunning) {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
                const userRef = doc(db, "users", user.uid);
                updateDoc(userRef, { status: "Ù…Ø±ÙŠØ­ Ø´ÙˆÙŠØ© â˜•" });
            }
        });
    </script>
</body>
</html>