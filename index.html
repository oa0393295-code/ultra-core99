<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN V120 | THE GOLIATH SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ - TITAN PALETTE */
        :root {
            --titan-cyan: #06b6d4;
            --titan-emerald: #10b981;
            --titan-red: #ef4444;
            --titan-bg: #020617;
            --titan-card: rgba(15, 23, 42, 0.95);
            --titan-border: rgba(56, 189, 248, 0.15);
        }

        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù… */
        body {
            font-family: 'Cairo', sans-serif;
            background: var(--titan-bg);
            color: #f1f5f9;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
            background-attachment: fixed;
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(6, 182, 212, 0.05) 0%, transparent 50%);
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… - GLASSMORPHISM */
        .glass-container {
            background: var(--titan-card);
            backdrop-filter: blur(25px);
            border: 1px solid var(--titan-border);
            border-radius: 2rem;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .glass-container:hover {
            border-color: rgba(56, 189, 248, 0.4);
            transform: translateY(-2px);
        }

        /* Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø²Ø¹Ø¨Ù„Ù„ÙŠ - THE ORB */
        .orb-nexus {
            position: relative;
            width: 390px; /* Ø§Ù„ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ */
            height: 390px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .orb-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
            filter: drop-shadow(0 0 10px rgba(6, 182, 212, 0.1));
        }

        .orb-track {
            fill: none;
            stroke: rgba(255, 255, 255, 0.02);
            stroke-width: 14;
        }

        .orb-progress {
            fill: none;
            stroke: var(--titan-cyan);
            stroke-width: 14;
            stroke-linecap: round;
            stroke-dasharray: 1130; /* 2 * PI * R (R=180) */
            stroke-dashoffset: 1130;
            transition: stroke-dashoffset 1s linear;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
        .btn-titan {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
            color: white;
            font-weight: 900;
            border-radius: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-titan:hover {
            transform: scale(1.02);
            filter: brightness(1.1);
            box-shadow: 0 0 20px rgba(8, 145, 178, 0.4);
        }

        .btn-titan:active {
            transform: scale(0.98);
        }

        /* ÙˆØ³ÙˆÙ… Ø§Ù„ØµÙ„Ø§Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
        .badge-system {
            font-size: 0.7rem;
            font-weight: 800;
            padding: 5px 10px;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .badge-on { 
            background: rgba(16, 185, 129, 0.15); 
            color: var(--titan-emerald); 
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-off { 
            background: rgba(239, 68, 68, 0.1); 
            color: var(--titan-red); 
            border: 1px solid rgba(239, 68, 68, 0.2);
            opacity: 0.6;
        }

        /* Ø´Ø§Øª ÙˆÙ†Ø¸Ø§Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--titan-cyan); border-radius: 10px; }
        
        #leaderboard .rank-card:first-child {
            border-right: 4px solid gold;
        }

        /* Modal Styles */
        .modal-overlay {
            background: rgba(2, 6, 23, 0.98);
            backdrop-filter: blur(15px);
        }

        /* Animations */
        @keyframes pulse-status {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .status-blink { animation: pulse-status 2s infinite; }
    </style>
</head>
<body>

    <div id="auth-gate" class="fixed inset-0 z-[9999] bg-slate-950 flex flex-col items-center justify-center">
        <div class="text-center space-y-8 p-10 glass-container">
            <h1 class="text-6xl font-black text-white italic tracking-tighter">TITAN <span class="text-cyan-500">V120</span></h1>
            <p class="text-slate-500 font-bold tracking-widest uppercase text-xs">The Goliath Architecture</p>
            <button id="login-trigger" class="btn-titan px-24 py-10 text-3xl">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <div id="mainframe" class="hidden opacity-0 transition-opacity duration-1000 p-4 md:p-8">
        <div class="max-w-[1920px] mx-auto grid grid-cols-12 gap-8">
            
            <aside class="col-span-12 lg:col-span-3 space-y-8">
                <div class="glass-container p-8">
                    <div class="flex items-center gap-6">
                        <div id="profile-initial" class="w-20 h-20 bg-gradient-to-tr from-cyan-600 to-blue-800 rounded-3xl flex items-center justify-center text-white text-4xl font-black shadow-xl">?</div>
                        <div class="overflow-hidden">
                            <h2 id="display-name" class="text-2xl font-black text-white truncate">...</h2>
                            <p id="live-clock" class="mono text-cyan-400 font-bold text-lg">00:00:00</p>
                        </div>
                    </div>
                    <button id="system-logout" class="mt-10 text-[10px] text-slate-600 font-black hover:text-red-500 tracking-widest transition-colors uppercase">Terminating_Session</button>
                </div>

                <div class="glass-container p-8">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest">Ø§Ù„ØµÙ„ÙˆØ§Øª ÙˆØ§Ù„Ø³Ù†Ù†</h3>
                        <span class="text-[10px] bg-slate-800 px-2 py-1 rounded text-cyan-500 font-black">LOCKED</span>
                    </div>
                    <div id="prayer-container" class="space-y-4">
                        </div>
                </div>

                <div class="glass-container p-8 border-b-4 border-emerald-500">
                    <h3 class="text-xs font-black text-slate-500 mb-6 uppercase tracking-widest">Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                    <div class="flex gap-3">
                        <input type="number" id="quran-input" class="w-full bg-slate-900/50 border border-slate-800 rounded-2xl p-5 text-white font-black focus:border-emerald-500 outline-none transition-all" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª">
                        <button id="quran-push" class="btn-titan px-8">Ø­ÙØ¸</button>
                    </div>
                </div>
            </aside>

            <section class="col-span-12 lg:col-span-6 space-y-8">
                <div class="glass-container p-16 flex flex-col items-center">
                    <div class="orb-nexus">
                        <svg class="orb-svg" viewBox="0 0 400 400">
                            <circle class="orb-track" cx="200" cy="200" r="180"></circle>
                            <circle id="orb-timer-path" class="orb-progress" cx="200" cy="200" r="180"></circle>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <h2 id="timer-display" class="text-8xl font-black mono text-white tracking-tighter">00:00:00</h2>
                            <p id="current-status-text" class="text-xs font-black text-slate-500 tracking-[0.5em] mt-6 italic uppercase">Ready_to_Start</p>
                        </div>
                    </div>
                    
                    <button id="timer-trigger" class="btn-titan mt-16 w-full max-w-lg py-10 text-4xl italic">Ø§Ø¨Ø¯Ø£</button>
                    
                    <div class="grid grid-cols-2 gap-12 w-full mt-16 pt-12 border-t border-white/5">
                        <div class="text-center group">
                            <p class="text-xs text-slate-500 font-black mb-4 uppercase group-hover:text-cyan-400">Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</p>
                            <p id="total-study-val" class="text-6xl font-black mono text-white">0</p>
                        </div>
                        <div class="text-center group">
                            <p class="text-xs text-slate-500 font-black mb-4 uppercase group-hover:text-emerald-400">Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†</p>
                            <p id="total-quran-val" class="text-6xl font-black mono text-white">0</p>
                        </div>
                    </div>
                </div>

                <div class="glass-container p-10">
                    <div class="flex justify-between items-center mb-10 border-r-4 border-cyan-500 pr-6">
                        <h3 class="text-xl font-black text-cyan-500 italic uppercase">Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§ØªÙŠ</h3>
                        <div class="text-[10px] font-black text-slate-600">HISTORY_LOG_STREAM</div>
                    </div>
                    <div id="history-stream" class="space-y-8 max-h-[900px] overflow-y-auto custom-scrollbar pr-4">
                        </div>
                </div>
            </section>

            <aside class="col-span-12 lg:col-span-3 space-y-8">
                <div class="glass-container p-8">
                    <h3 class="text-sm font-black text-center mb-10 uppercase tracking-[0.3em] text-cyan-400 border-b border-white/5 pb-4">Ø§Ù„ØªØ±ØªÙŠØ¨</h3>
                    <div id="leaderboard" class="space-y-5 max-h-[700px] overflow-y-auto custom-scrollbar">
                        </div>
                </div>

                <div class="glass-container h-[550px] flex flex-col overflow-hidden">
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-8 space-y-6 custom-scrollbar">
                        </div>
                    <div class="p-6 bg-slate-900/80 flex gap-3 border-t border-white/5">
                        <input id="chat-input-field" type="text" placeholder="Ø£Ø±Ø³Ù„ Ø¥Ø´Ø§Ø±Ø©..." class="flex-1 bg-transparent border-b-2 border-slate-800 p-3 text-white outline-none focus:border-cyan-500 transition-all font-bold">
                        <button id="chat-send-btn" class="btn-titan px-8 py-3">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <div id="inspect-modal" class="hidden fixed inset-0 z-[10001] modal-overlay flex items-center justify-center p-6">
        <div class="glass-container w-full max-w-6xl p-16 relative border-cyan-500">
            <button onclick="UI.closeInspect()" class="absolute top-10 left-10 text-6xl text-slate-600 hover:text-white transition-colors">&times;</button>
            <h4 id="inspect-user-title" class="text-7xl font-black italic mb-16 text-white border-r-[15px] border-cyan-500 pr-10">...</h4>
            <div id="inspect-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-h-[650px] overflow-y-auto custom-scrollbar p-4">
                </div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 z-[10002] modal-overlay flex items-center justify-center p-6">
        <div class="glass-container w-full max-w-2xl p-12">
            <h4 class="text-3xl font-black mb-10 text-cyan-500 italic">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
            <div class="space-y-10">
                <div class="space-y-8">
                    <div>
                        <label class="text-[10px] font-black text-slate-500 block mb-3 uppercase">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©)</label>
                        <input type="number" id="edit-mins-field" class="w-full bg-slate-900 border-2 border-slate-800 rounded-3xl p-8 text-white font-black text-5xl focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-500 block mb-3 uppercase">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª (Ø§Ù„Ù‚Ø±Ø¢Ù†)</label>
                        <input type="number" id="edit-quran-field" class="w-full bg-slate-900 border-2 border-slate-800 rounded-3xl p-8 text-white font-black text-5xl focus:border-emerald-500 outline-none">
                    </div>
                </div>
                <div id="edit-prayer-grid" class="grid grid-cols-3 gap-4">
                    </div>
                <div class="flex gap-6">
                    <button id="save-edit-btn" class="flex-1 btn-titan py-8 text-2xl">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button onclick="UI.closeEdit()" class="flex-1 bg-slate-800 text-white rounded-3xl font-black text-xl hover:bg-slate-700">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        /**
         * TITAN V120 - GOLIATH ENGINE
         * FIREBASE ENTERPRISE ARCHITECTURE
         */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, query, collection, orderBy, limit, updateDoc, increment, addDoc, serverTimestamp, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyASLT_wouo9BTjd-dH18x8CLbqBZSMbz04",
            authDomain: "ultra-core.firebaseapp.com",
            projectId: "ultra-core",
            storageBucket: "ultra-core.firebasestorage.app",
            messagingSenderId: "351766462712",
            appId: "1:351766462712:web:e683d8aa0d213b6e59fb0d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        /** * CLASS: TITAN_CORE 
         * Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ© ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯
         */
        class TitanCore {
            constructor() {
                this.user = null;
                this.totalSeconds = 0;
                this.isRunning = false;
                this.mainInterval = null;
                this.currentDay = new Date().toISOString().split('T')[0];
                this.prayerList = [
                    {id: 'fajr', label: 'Ø§Ù„ÙØ¬Ø±'},
                    {id: 'dhuhr', label: 'Ø§Ù„Ø¸Ù‡Ø±'},
                    {id: 'asr', label: 'Ø§Ù„Ø¹ØµØ±'},
                    {id: 'maghrib', label: 'Ø§Ù„Ù…ØºØ±Ø¨'},
                    {id: 'isha', label: 'Ø§Ù„Ø¹Ø´Ø§Ø¡'},
                    {id: 'taraweeh', label: 'ØªØ±Ø§ÙˆÙŠØ­'}
                ];
                this.editState = { date: null, habits: {} };
            }

            // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ©
            formatStudyTime(minutes) {
                if (!minutes || minutes === 0) return "0";
                if (minutes >= 60) {
                    const hours = (minutes / 60).toFixed(1);
                    return `${hours} Ø³`;
                }
                return `${minutes}`;
            }

            async initializeUser(user) {
                this.user = user;
                UI.renderFrame(true);
                this.restoreSession();
                this.initRealtimeStreams();
                this.handleAppLifecycle();
                
                // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
                await this.updateLiveStatus(this.isRunning ? "Ø¨ÙŠØ°Ø§ÙƒØ± Ø¯Ù„ÙˆÙ‚ØªÙŠ ğŸ”¥" : "Ø¨ÙŠØ±ÙŠØ­ Ø´ÙˆÙŠÙ‡ â˜•");
            }

            handleAppLifecycle() {
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØºÙ„Ù‚ Ø§Ù„ØªØ§Ø¨Ø© (Offline Mode)
                window.addEventListener('beforeunload', () => {
                    if (this.isRunning) {
                        localStorage.setItem(`titan_run_${this.user.uid}`, "false");
                    }
                    const userRef = doc(db, "users", this.user.uid);
                    updateDoc(userRef, { status: "offline ğŸŒ‘" });
                });
            }

            restoreSession() {
                const savedSecs = localStorage.getItem(`titan_secs_${this.user.uid}`);
                this.totalSeconds = savedSecs ? parseInt(savedSecs) : 0;
                
                const wasRunning = localStorage.getItem(`titan_run_${this.user.uid}`) === "true";
                if (wasRunning) {
                    this.toggleEngine(true);
                } else {
                    UI.updateOrbUI();
                }
            }

            async toggleEngine(forceStart = false) {
                if (!this.isRunning || forceStart) {
                    this.isRunning = true;
                    localStorage.setItem(`titan_run_${this.user.uid}`, "true");
                    UI.updateControlBtn(true);
                    await this.updateLiveStatus("Ø¨ÙŠØ°Ø§ÙƒØ± Ø¯Ù„ÙˆÙ‚ØªÙŠ ğŸ”¥");
                    
                    this.mainInterval = setInterval(() => {
                        this.totalSeconds++;
                        localStorage.setItem(`titan_secs_${this.user.uid}`, this.totalSeconds);
                        UI.updateOrbUI();
                        
                        // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
                        if (this.totalSeconds % 60 === 0) {
                            this.incrementDailyMetric('mins', 1);
                            this.updateLiveStatus("Ø¨ÙŠØ°Ø§ÙƒØ± Ø¯Ù„ÙˆÙ‚ØªÙŠ ğŸ”¥");
                        }
                    }, 1000);
                } else {
                    clearInterval(this.mainInterval);
                    this.isRunning = false;
                    localStorage.setItem(`titan_run_${this.user.uid}`, "false");
                    UI.updateControlBtn(false);
                    await this.updateLiveStatus("Ø¨ÙŠØ±ÙŠØ­ Ø´ÙˆÙŠÙ‡ â˜•");
                }
            }

            async incrementDailyMetric(field, value) {
                const logRef = doc(db, "users", this.user.uid, "logs", this.currentDay);
                await setDoc(logRef, { 
                    [field]: increment(value), 
                    date: this.currentDay 
                }, { merge: true });
            }

            async updateLiveStatus(statusText) {
                if (!this.user) return;
                const userRef = doc(db, "users", this.user.uid);
                await updateDoc(userRef, {
                    status: statusText,
                    todayMins: Math.floor(this.totalSeconds / 60),
                    name: this.user.displayName,
                    uid: this.user.uid,
                    lastPing: serverTimestamp()
                });
            }

            initRealtimeStreams() {
                // 1. ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (Ø§Ù„ØªØ±ØªÙŠØ¨)
                onSnapshot(query(collection(db, "users"), limit(40)), (snapshot) => {
                    const userList = snapshot.docs.map(d => d.data());
                    const sorted = userList.sort((a, b) => (b.todayMins || 0) - (a.todayMins || 0));
                    UI.drawLeaderboard(sorted);
                });

                // 2. ØªÙŠØ§Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©
                onSnapshot(query(collection(db, "users", this.user.uid, "logs"), orderBy("date", "desc")), (snapshot) => {
                    const logs = snapshot.docs.map(d => d.data());
                    const todayLog = logs.find(l => l.date === this.currentDay);
                    if (todayLog) UI.syncDashboard(todayLog);
                    UI.drawHistory(logs);
                });

                // 3. ØªÙŠØ§Ø± Ø§Ù„Ø´Ø§Øª
                onSnapshot(query(collection(db, "chat"), orderBy("timestamp", "asc"), limit(60)), (snapshot) => {
                    UI.drawChat(snapshot.docs.map(d => d.data()));
                });

                // 4. ØªÙŠØ§Ø± Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ù„Ø­Ø¸ÙŠ
                onSnapshot(doc(db, "users", this.user.uid, "logs", this.currentDay), (snapshot) => {
                    if (snapshot.exists()) {
                        UI.syncPrayerUI(snapshot.data().habits || {});
                    }
                });
            }
        }

        /** * CLASS: UI_CONTROLLER 
         * Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù† Ø§Ù„Ø±Ù†Ø¯Ø± ÙˆØ§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¨ØµØ±ÙŠ
         */
        const UI = {
            renderFrame(show) {
                const gate = document.getElementById('auth-gate');
                const main = document.getElementById('mainframe');
                if (show) {
                    gate.style.display = 'none';
                    main.classList.remove('hidden');
                    setTimeout(() => main.style.opacity = '1', 100);
                    this.initStaticElements();
                } else {
                    gate.style.display = 'flex';
                    main.classList.add('hidden');
                }
            },

            initStaticElements() {
                document.getElementById('display-name').innerText = Core.user.displayName;
                document.getElementById('profile-initial').innerText = Core.user.displayName[0];
                
                // Ø±Ù†Ø¯Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙ„ÙˆØ§Øª
                const container = document.getElementById('prayer-container');
                container.innerHTML = Core.prayerList.map(p => `
                    <div class="flex items-center justify-between p-5 bg-slate-900/40 rounded-2xl border border-white/5 hover:border-cyan-500/30 transition-all">
                        <span class="text-sm font-bold text-slate-400">${p.label}</span>
                        <input type="checkbox" id="prayer-${p.id}" onchange="Actions.togglePrayer('${p.id}')" class="w-7 h-7 accent-cyan-500 cursor-pointer">
                    </div>
                `).join('');
            },

            updateOrbUI() {
                const s = Core.totalSeconds;
                const hours = Math.floor(s / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((s % 3600) / 60).toString().padStart(2, '0');
                const seconds = (s % 60).toString().padStart(2, '0');
                
                document.getElementById('timer-display').innerText = `${hours}:${minutes}:${seconds}`;
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø³Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© (Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†)
                // 1130 Ù‡Ùˆ Ø§Ù„Ù…Ø­ÙŠØ· Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯Ø§Ø¦Ø±Ø© ÙÙŠ Ø§Ù„Ù€ CSS
                const offset = 1130 - ((s % 60) / 60 * 1130);
                document.getElementById('orb-timer-path').style.strokeDashoffset = offset;
            },

            updateControlBtn(active) {
                const btn = document.getElementById('timer-trigger');
                const txt = document.getElementById('current-status-text');
                if (active) {
                    btn.innerText = "Ø¥ÙŠÙ‚Ø§Ù";
                    btn.style.filter = "hue-rotate(150deg)";
                    txt.innerText = "Ø¨ÙŠØ°Ø§ÙƒØ± Ø¯Ù„ÙˆÙ‚ØªÙŠ ğŸ”¥";
                    txt.classList.add('status-blink', 'text-cyan-500');
                } else {
                    btn.innerText = "Ø§Ø¨Ø¯Ø£";
                    btn.style.filter = "none";
                    txt.innerText = "Ø¨ÙŠØ±ÙŠØ­ Ø´ÙˆÙŠÙ‡ â˜•";
                    txt.classList.remove('status-blink', 'text-cyan-500');
                }
            },

            syncDashboard(data) {
                document.getElementById('total-study-val').innerText = Core.formatStudyTime(data.mins || 0);
                document.getElementById('total-quran-val').innerText = data.quran || 0;
            },

            drawLeaderboard(users) {
                const container = document.getElementById('leaderboard');
                container.innerHTML = users.map((u, index) => {
                    const isTop = index === 0;
                    const isOnline = u.status && u.status.includes("Ø¨ÙŠØ°Ø§ÙƒØ±");
                    const isIdle = u.status && u.status.includes("Ø¨ÙŠØ±ÙŠØ­");
                    
                    const statusColor = isOnline ? 'text-cyan-500' : (isIdle ? 'text-amber-500' : 'text-slate-700');
                    
                    const prayerBadges = Core.prayerList.map(p => {
                        const done = u.lastHabits && u.lastHabits[p.id];
                        return `<div class="badge-system ${done ? 'badge-on' : 'badge-off'}">${p.label}</div>`;
                    }).join('');

                    return `
                        <div onclick="UI.openInspect('${u.uid}', '${u.name}')" class="rank-card glass-container p-6 cursor-pointer hover:bg-white/5 border-r-4 ${isTop ? 'border-amber-500' : 'border-transparent'}">
                            <div class="flex items-center justify-between mb-5">
                                <div class="flex items-center gap-4">
                                    <span class="text-3xl font-black mono ${index < 3 ? 'text-white' : 'text-slate-800'}">${index + 1}</span>
                                    <div>
                                        <p class="text-sm font-black text-white">${u.name} ${isTop ? 'ğŸ¥‡' : ''}</p>
                                        <span class="text-[9px] font-black uppercase ${statusColor}">${u.status || 'offline ğŸŒ‘'}</span>
                                    </div>
                                </div>
                                <div class="text-2xl font-black mono text-cyan-500">${Core.formatStudyTime(u.todayMins || 0)}</div>
                            </div>
                            <div class="flex flex-wrap gap-1.5">${prayerBadges}</div>
                        </div>
                    `;
                }).join('');
            },

            drawHistory(logs) {
                const container = document.getElementById('history-stream');
                container.innerHTML = logs.map(log => {
                    const prayers = Core.prayerList.map(p => {
                        const done = log.habits && log.habits[p.id];
                        return `<div class="badge-system ${done ? 'badge-on' : 'badge-off'}">${p.label}</div>`;
                    }).join('');

                    return `
                        <div class="glass-container p-8 relative group overflow-hidden">
                            <div class="flex justify-between items-start mb-8">
                                <div>
                                    <p class="mono text-[10px] text-cyan-600 mb-2 uppercase">${log.date}</p>
                                    <h4 class="text-3xl font-black text-white">Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©: ${Core.formatStudyTime(log.mins || 0)}</h4>
                                </div>
                                <div class="text-emerald-400 font-black text-2xl">Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†: ${log.quran || 0}</div>
                            </div>
                            <div class="flex flex-wrap gap-2 mb-4">${prayers}</div>
                            <button onclick="UI.openEdit('${log.date}', ${log.mins || 0}, ${log.quran || 0}, ${JSON.stringify(log.habits || {}).replace(/"/g, '&quot;')})" class="absolute bottom-5 left-5 opacity-0 group-hover:opacity-100 bg-white text-black px-8 py-2 rounded-xl text-xs font-black transition-all">ØªØ¹Ø¯ÙŠÙ„</button>
                        </div>
                    `;
                }).join('');
            },

            drawChat(messages) {
                const chatBox = document.getElementById('chat-messages');
                chatBox.innerHTML = messages.map(m => `
                    <div class="flex flex-col ${m.uid === Core.user.uid ? 'items-end' : 'items-start'}">
                        <span class="text-[9px] font-black text-slate-600 mb-2">${m.sender}</span>
                        <div class="${m.uid === Core.user.uid ? 'bg-cyan-600 text-black' : 'bg-slate-800 text-white'} px-6 py-3 rounded-[1.5rem] font-bold text-sm shadow-xl max-w-[85%]">
                            ${m.text}
                        </div>
                    </div>
                `).join('');
                chatBox.scrollTop = chatBox.scrollHeight;
            },

            syncPrayerUI(habits) {
                Core.prayerList.forEach(p => {
                    const el = document.getElementById(`prayer-${p.id}`);
                    if (el) el.checked = habits[p.id] || false;
                });
            },

            async openInspect(uid, name) {
                const title = document.getElementById('inspect-user-title');
                const body = document.getElementById('inspect-content');
                
                title.innerText = name;
                body.innerHTML = '<div class="col-span-full py-40 text-center mono text-cyan-500 animate-pulse text-4xl">DECRYPTING_BIO_LOGS...</div>';
                document.getElementById('inspect-modal').classList.remove('hidden');

                const logsSnapshot = await getDocs(query(collection(db, "users", uid, "logs"), orderBy("date", "desc")));
                body.innerHTML = logsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    const prayers = Core.prayerList.map(p => `
                        <div class="badge-system ${(data.habits && data.habits[p.id]) ? 'badge-on' : 'badge-off'}">${p.label}</div>
                    `).join('');

                    return `
                        <div class="glass-container p-10 bg-black/40 border-slate-800">
                            <p class="mono text-xs text-cyan-600 mb-8 uppercase tracking-widest">${data.date}</p>
                            <div class="space-y-4 mb-10">
                                <p class="text-2xl font-black text-white">Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©: ${Core.formatStudyTime(data.mins || 0)}</p>
                                <p class="text-2xl font-black text-emerald-500">Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†: ${data.quran || 0}</p>
                            </div>
                            <div class="flex flex-wrap gap-2">${prayers}</div>
                        </div>
                    `;
                }).join('');
            },

            closeInspect() { document.getElementById('inspect-modal').classList.add('hidden'); },

            openEdit(date, mins, quran, habits) {
                Core.editState = { date, habits: habits || {} };
                document.getElementById('edit-mins-field').value = mins;
                document.getElementById('edit-quran-field').value = quran;
                
                const grid = document.getElementById('edit-prayer-grid');
                grid.innerHTML = Core.prayerList.map(p => `
                    <div class="flex flex-col items-center p-5 bg-black/50 rounded-3xl border border-white/5">
                        <span class="text-[9px] font-black text-slate-600 mb-4">${p.label}</span>
                        <input type="checkbox" id="edit-p-${p.id}" ${Core.editState.habits[p.id] ? 'checked' : ''} onchange="Core.editState.habits['${p.id}'] = this.checked" class="w-8 h-8 accent-emerald-500 cursor-pointer">
                    </div>
                `).join('');
                
                document.getElementById('edit-modal').classList.remove('hidden');
            },

            closeEdit() { document.getElementById('edit-modal').classList.add('hidden'); }
        };

        /**
         * ACTIONS & HANDLERS
         */
        const Actions = {
            async togglePrayer(id) {
                const isChecked = document.getElementById(`prayer-${id}`).checked;
                const logRef = doc(db, "users", Core.user.uid, "logs", Core.currentDay);
                
                const snap = await getDoc(logRef);
                let currentHabits = snap.exists() ? (snap.data().habits || {}) : {};
                currentHabits[id] = isChecked;

                await setDoc(logRef, { habits: currentHabits, date: Core.currentDay }, { merge: true });
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ Snapshot Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„ØªØ±ØªÙŠØ¨
                await updateDoc(doc(db, "users", Core.user.uid), { lastHabits: currentHabits });
            },

            async commitEdit() {
                const nMins = parseInt(document.getElementById('edit-mins-field').value) || 0;
                const nQuran = parseInt(document.getElementById('edit-quran-field').value) || 0;
                const habits = Core.editState.habits;
                
                const logRef = doc(db, "users", Core.user.uid, "logs", Core.editState.date);
                await updateDoc(logRef, { mins: nMins, quran: nQuran, habits: habits });

                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ø­Ø¯Ø« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­Ù„ÙŠ
                if (Core.editState.date === Core.currentDay) {
                    Core.totalSeconds = nMins * 60;
                    localStorage.setItem(`titan_secs_${Core.user.uid}`, Core.totalSeconds);
                    UI.updateOrbUI();
                    Core.updateLiveStatus(Core.isRunning ? "Ø¨ÙŠØ°Ø§ÙƒØ± Ø¯Ù„ÙˆÙ‚ØªÙŠ ğŸ”¥" : "Ø¨ÙŠØ±ÙŠØ­ Ø´ÙˆÙŠÙ‡ â˜•");
                }
                UI.closeEdit();
            }
        };

        // INITIALIZATION
        const Core = new TitanCore();
        onAuthStateChanged(auth, user => {
            if (user) Core.initializeUser(user);
            else UI.renderFrame(false);
        });

        // EVENT BINDINGS
        document.getElementById('login-trigger').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('system-logout').onclick = () => signOut(auth).then(() => {
            localStorage.clear();
            window.location.reload();
        });

        document.getElementById('timer-trigger').onclick = () => Core.toggleEngine();
        document.getElementById('quran-push').onclick = async () => {
            const val = parseInt(document.getElementById('quran-input').value) || 0;
            if (val > 0) {
                await Core.incrementDailyMetric('quran', val);
                document.getElementById('quran-input').value = '';
            }
        };

        document.getElementById('chat-send-btn').onclick = async () => {
            const field = document.getElementById('chat-input-field');
            if (!field.value.trim()) return;
            await addDoc(collection(db, "chat"), {
                text: field.value,
                sender: Core.user.displayName,
                uid: Core.user.uid,
                timestamp: serverTimestamp()
            });
            field.value = '';
        };

        document.getElementById('save-edit-btn').onclick = () => Actions.commitEdit();

        // Keyboard Logic
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (document.activeElement.id === 'chat-input-field') document.getElementById('chat-send-btn').click();
                if (document.activeElement.id === 'quran-input') document.getElementById('quran-push').click();
            }
        });

        // Live Clock Service
        setInterval(() => {
            document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('en-GB');
        }, 1000);

        // Expose to window for inline calls
        window.UI = UI; window.Actions = Actions; window.Core = Core;

    </script>
</body>
</html>