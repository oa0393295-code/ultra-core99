<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA CORE V9 | THE COLORFUL GOLIATH</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ù„ÙˆÙ†Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© --- */
        :root {
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --accent-purple: #667eea;
            --accent-pink: #764ba2;
            --success-green: #00b09b;
            --warning-orange: #f83600;
            --chat-blue: #0076ff;
            --card-shadow: 0 15px 35px rgba(0,0,0,0.1);
            --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #2d3436;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù…Ù„ÙˆÙ†Ø© --- */
        .color-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 2rem;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: var(--card-shadow);
            transition: var(--transition-smooth);
            overflow: hidden;
        }

        .color-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        /* --- Ù‡ÙŠØ¯Ø± Ù…Ù„ÙˆÙ† Ù…ØªØ·ÙˆØ± --- */
        .rainbow-header {
            background: white;
            border-bottom: 4px solid transparent;
            border-image: linear-gradient(to right, #667eea, #764ba2, #00b09b, #f83600);
            border-image-slice: 1;
            padding: 1.5rem 3rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¹Ø¯Ø§Ø¯ (The Neon Ring) --- */
        .neon-timer-container {
            position: relative;
            width: 350px;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        svg.neon-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .neon-track { fill: none; stroke: #eee; stroke-width: 12; }
        .neon-progress {
            fill: none;
            stroke: url(#timer-grad);
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 880;
            stroke-dashoffset: 880;
            transition: stroke-dashoffset 1s linear;
            filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.5));
        }

        /* --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙ† --- */
        .colorful-chat {
            height: 550px;
            overflow-y: auto;
            background: #fdfdfd;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .msg-box { display: flex; width: 100%; }
        .msg-box.me { justify-content: flex-end; }
        .msg-box.them { justify-content: flex-start; }

        .bubble-gradient {
            max-width: 75%;
            padding: 1.2rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .me .bubble-gradient {
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-pink) 100%);
            color: white;
            border-radius: 1.5rem 1.5rem 0.2rem 1.5rem;
        }

        .them .bubble-gradient {
            background: white;
            color: #333;
            border: 1px solid #eee;
            border-radius: 1.5rem 1.5rem 1.5rem 0.2rem;
        }

        /* --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù„ÙˆÙ†Ø© --- */
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.25rem 2.5rem;
            border-radius: 1.2rem;
            font-weight: 900;
            transition: var(--transition-smooth);
            cursor: pointer;
            border: none;
            text-align: center;
        }

        .btn-gradient:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
            box-shadow: 0 10px 20px rgba(118, 75, 162, 0.3);
        }

        /* --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            backdrop-filter: blur(10px);
        }

        .modal-body {
            background: white;
            padding: 3rem;
            border-radius: 3rem;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }

        /* --- ØªØ®ØµÙŠØµ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø¨Ø§Ø± --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--accent-purple); border-radius: 10px; }

    </style>
</head>
<body>

    <div id="auth-screen" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center">
        <div class="text-center animate-bounce">
            <h1 class="text-9xl font-black bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-pink-600">UC9</h1>
        </div>
        <p class="mt-8 font-bold text-gray-400 tracking-widest uppercase mb-12">The Ultimate Colorful Experience</p>
        <button id="login-trigger" class="btn-gradient text-2xl px-20 py-8">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>

    <div id="app-container" class="hidden">
        <header class="rainbow-header shadow-md">
            <div class="flex items-center gap-6">
                <div class="h-12 w-12 rounded-2xl bg-gradient-to-tr from-blue-500 to-purple-600"></div>
                <div>
                    <h2 id="user-display" class="text-3xl font-black text-gray-800"></h2>
                    <p class="text-[10px] font-bold text-green-500 uppercase">â— Online Session Active</p>
                </div>
            </div>
            <button id="logout-btn" class="font-bold text-red-400 hover:text-red-600 transition-colors">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </header>

        <main class="max-w-screen-2xl mx-auto p-10 grid grid-cols-12 gap-10">
            
            <aside class="col-span-12 lg:col-span-3 space-y-10">
                <section class="color-card p-10 border-t-8 border-purple-500">
                    <h3 class="text-2xl font-black mb-8 text-gray-700 italic underline decoration-purple-200">Ø§Ù„Ø£ÙˆØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                    <div id="prayer-hook" class="space-y-4">
                        </div>
                    <div class="mt-12 pt-8 border-t border-gray-100">
                        <label class="text-xs font-black text-gray-400 block mb-4 uppercase">Ø³Ø¬Ù„ ØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†</label>
                        <div class="flex gap-4">
                            <input type="number" id="quran-field" class="w-full bg-gray-50 rounded-2xl p-4 text-2xl font-black outline-none border-2 border-transparent focus:border-purple-300">
                            <button onclick="saveQuranData()" class="btn-gradient !p-4">âœ“</button>
                        </div>
                    </div>
                </section>

                <section class="color-card bg-gradient-to-br from-indigo-600 to-purple-700 p-8 text-white">
                    <h4 class="text-sm font-black uppercase tracking-tighter mb-8 opacity-80">Live Analytics</h4>
                    <div class="space-y-10">
                        <div>
                            <p class="text-5xl font-black font-mono" id="stat-total-mins">0m</p>
                            <p class="text-[10px] font-bold uppercase mt-2">ÙˆÙ‚Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø§Ù„ÙØ¹Ù„ÙŠ</p>
                        </div>
                        <div>
                            <p class="text-5xl font-black font-mono" id="stat-total-quran">0</p>
                            <p class="text-[10px] font-bold uppercase mt-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†</p>
                        </div>
                    </div>
                </section>
            </aside>

            <div class="col-span-12 lg:col-span-6 space-y-10">
                <section class="color-card flex flex-col items-center py-20 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-6 text-[10px] font-black text-gray-200 uppercase">Terminal_V9</div>
                    <div class="neon-timer-container">
                        <svg class="neon-svg" viewBox="0 0 320 320">
                            <defs>
                                <linearGradient id="timer-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#667eea" />
                                    <stop offset="100%" style="stop-color:#764ba2" />
                                </linearGradient>
                            </defs>
                            <circle class="neon-track" cx="160" cy="160" r="140"></circle>
                            <circle id="timer-progress" class="neon-progress" cx="160" cy="160" r="140"></circle>
                        </svg>
                        <div class="absolute text-center">
                            <h2 id="timer-face" class="text-8xl font-mono font-black tracking-tighter text-gray-800">00:00:00</h2>
                            <p id="timer-status" class="text-xs font-bold text-purple-400 mt-4 uppercase">Ready to Sync</p>
                        </div>
                    </div>
                    <button id="timer-trigger" class="btn-gradient mt-16 w-full max-w-md text-3xl py-10 rounded-full shadow-2xl">ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²</button>
                </section>

                <section class="color-card p-10">
                    <div class="flex justify-between items-center mb-10">
                        <h3 class="text-3xl font-black italic text-gray-700">Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</h3>
                        <div class="px-4 py-2 bg-purple-50 text-purple-600 rounded-full text-[10px] font-black">DATABASE_RECOVERY</div>
                    </div>
                    <div id="history-list" class="space-y-6 max-h-[800px] overflow-y-auto pr-4">
                        </div>
                </section>
            </div>

            <aside class="col-span-12 lg:col-span-3 space-y-10">
                <section class="color-card p-8 border-b-8 border-green-400">
                    <h3 class="text-center font-black text-xs uppercase tracking-widest text-gray-400 mb-8">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h3>
                    <div id="ranking-container" class="space-y-4">
                        </div>
                </section>

                <section class="color-card h-[650px] flex flex-col !p-0 border-t-8 border-blue-500">
                    <div class="p-6 bg-blue-50 border-b border-blue-100">
                        <p class="text-center font-black text-blue-600 text-xs uppercase">ØºØ±ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</p>
                    </div>
                    <div id="chat-viewport" class="colorful-chat flex-1">
                        </div>
                    <div class="p-6 bg-white border-t border-gray-100 flex gap-4">
                        <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." class="flex-1 bg-gray-50 rounded-xl p-4 font-bold outline-none focus:ring-2 ring-blue-400">
                        <button id="chat-send" class="btn-gradient !p-4">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </section>
            </aside>
        </main>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-body">
            <h4 class="text-4xl font-black text-gray-800 mb-2">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</h4>
            <p id="edit-target-date" class="font-mono text-xs text-purple-500 mb-10 uppercase font-bold"></p>
            
            <div class="space-y-8">
                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-gray-400">Ø§Ù„Ø³Ø§Ø¹Ø§Øª</label>
                        <input type="number" id="edit-h" class="w-full bg-gray-50 p-6 rounded-2xl text-4xl font-black text-center border-2 border-transparent focus:border-purple-500">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-gray-400">Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</label>
                        <input type="number" id="edit-m" class="w-full bg-gray-50 p-6 rounded-2xl text-4xl font-black text-center border-2 border-transparent focus:border-purple-500">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-gray-400">Ø¹Ø¯Ø¯ ØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†</label>
                    <input type="number" id="edit-q" class="w-full bg-gray-50 p-6 rounded-2xl text-4xl font-black text-center border-2 border-transparent focus:border-purple-500">
                </div>
                
                <div class="flex gap-4 pt-6">
                    <button id="save-edit-btn" class="flex-[2] btn-gradient text-xl py-6 rounded-2xl">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„</button>
                    <button onclick="closeModal()" class="flex-1 bg-gray-100 font-black rounded-2xl hover:bg-red-50 hover:text-red-500 transition-all">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, query, collection, orderBy, limit, updateDoc, increment, addDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù€ Firebase
        const config = {
            apiKey: "AIzaSyASLT_wouo9BTjd-dH18x8CLbqBZSMbz04",
            authDomain: "ultra-core.firebaseapp.com",
            projectId: "ultra-core",
            storageBucket: "ultra-core.firebasestorage.app",
            messagingSenderId: "351766462712",
            appId: "1:351766462712:web:e683d8aa0d213b6e59fb0d"
        };

        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© (State Engine)
        let currentUser = null;
        let timerInterval = null;
        let seconds = 0;
        let isRunning = false;
        let editingDate = null;
        const todayId = new Date().toISOString().split('T')[0];

        const PRAYERS = [
            {id: 'fajr', label: 'ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø±'}, {id: 'dhuhr', label: 'ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø±'},
            {id: 'asr', label: 'ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ±'}, {id: 'maghrib', label: 'ØµÙ„Ø§Ø© Ø§Ù„Ù…ØºØ±Ø¨'},
            {id: 'isha', label: 'ØµÙ„Ø§Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡'}, {id: 'taraweeh', label: 'ØµÙ„Ø§Ø© Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­'}
        ];

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ (System Notify) ---
        function systemLog(msg, type = "info") {
            console.log(`[UC9 SYSTEM] [${type.toUpperCase()}]: ${msg}`);
        }

        // --- Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ (Boot Logic) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('user-display').innerText = user.displayName;

                await initializeSession();
                renderPrayers();
                setupDataStreams();
                systemLog("Session initialized for " + user.displayName, "success");
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
            }
        });

        async function initializeSession() {
            // Ù…Ø²Ø§Ù…Ù†Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            await setDoc(doc(db, "users", currentUser.uid), {
                name: currentUser.displayName,
                uid: currentUser.uid,
                active: true
            }, { merge: true });

            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ù„ÙŠ
            const localSecs = localStorage.getItem(`UC9_SECS_${currentUser.uid}`);
            const localState = localStorage.getItem(`UC9_RUNNING_${currentUser.uid}`);
            
            seconds = parseInt(localSecs) || 0;
            if (localState === "true") {
                toggleTimer(true);
            } else {
                updateTimerDisplay();
            }
        }

        function renderPrayers() {
            const container = document.getElementById('prayer-hook');
            container.innerHTML = PRAYERS.map(p => `
                <div class="flex items-center justify-between p-5 bg-white rounded-2xl shadow-sm border border-gray-50 hover:border-purple-300 transition-all">
                    <span class="font-bold text-gray-600">${p.label}</span>
                    <input type="checkbox" id="check-${p.id}" onchange="handlePrayerToggle('${p.id}')" class="w-6 h-6 rounded-full accent-purple-600">
                </div>
            `).join('');
        }

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…Ù„ÙˆÙ† (Colorful Timer Engine) ---
        function toggleTimer(auto = false) {
            const btn = document.getElementById('timer-trigger');
            const status = document.getElementById('timer-status');

            if (!isRunning || auto) {
                isRunning = true;
                localStorage.setItem(`UC9_RUNNING_${currentUser.uid}`, "true");
                btn.innerText = "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª";
                btn.classList.add('from-red-500', 'to-orange-500');
                status.innerText = "Focus Mode Active ğŸ”¥";
                status.classList.replace('text-purple-400', 'text-orange-500');

                timerInterval = setInterval(() => {
                    seconds++;
                    localStorage.setItem(`UC9_SECS_${currentUser.uid}`, seconds);
                    updateTimerDisplay();
                    updateCircleProgress();
                    
                    if (seconds % 60 === 0) {
                        syncMinuteToCloud();
                    }
                }, 1000);
            } else {
                clearInterval(timerInterval);
                isRunning = false;
                localStorage.setItem(`UC9_RUNNING_${currentUser.uid}`, "false");
                btn.innerText = "ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²";
                btn.classList.remove('from-red-500', 'to-orange-500');
                status.innerText = "System Idle";
                status.classList.replace('text-orange-500', 'text-purple-400');
            }
        }

        function updateTimerDisplay() {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-face').innerText = `${h}:${m}:${s}`;
        }

        function updateCircleProgress() {
            const ring = document.getElementById('timer-progress');
            const p = (seconds % 60 / 60) * 880;
            ring.style.strokeDashoffset = 880 - p;
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© (Cloud Logic Sector) ---
        window.handlePrayerToggle = async (pid) => {
            const val = document.getElementById(`check-${pid}`).checked;
            const logRef = doc(db, "users", currentUser.uid, "logs", todayId);
            
            const snap = await getDoc(logRef);
            let habits = snap.exists() ? (snap.data().habits || {}) : {};
            habits[pid] = val;

            const ritualStr = PRAYERS.filter(p => habits[p.id]).map(p => p.label.replace('ØµÙ„Ø§Ø© ', '')).join(' | ');

            await setDoc(logRef, { habits, ritualStr, date: todayId }, { merge: true });
            systemLog(`Prayer ${pid} updated to ${val}`, "info");
        }

        window.saveQuranData = async () => {
            const field = document.getElementById('quran-field');
            const val = parseInt(field.value) || 0;
            if (val <= 0) return;

            const logRef = doc(db, "users", currentUser.uid, "logs", todayId);
            await setDoc(logRef, { quran: increment(val), date: todayId }, { merge: true });
            field.value = '';
            systemLog(`Added ${val} pages to Quran log`, "success");
        }

        async function syncMinuteToCloud() {
            const logRef = doc(db, "users", currentUser.uid, "logs", todayId);
            const userRef = doc(db, "users", currentUser.uid);
            
            await setDoc(logRef, { mins: increment(1), date: todayId }, { merge: true });
            await updateDoc(userRef, { dailyMins: increment(1) });
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ (Temporal Correction System) ---
        window.openEditModal = (date, m, q) => {
            editingDate = date;
            document.getElementById('edit-target-date').innerText = `Editing Archive: ${date}`;
            document.getElementById('edit-h').value = Math.floor(m / 60);
            document.getElementById('edit-m').value = m % 60;
            document.getElementById('edit-q').value = q;
            document.getElementById('edit-modal').style.display = 'flex';
        }

        window.closeModal = () => {
            document.getElementById('edit-modal').style.display = 'none';
        }

        document.getElementById('save-edit-btn').onclick = async () => {
            const h = parseInt(document.getElementById('edit-h').value) || 0;
            const m = parseInt(document.getElementById('edit-m').value) || 0;
            const total = (h * 60) + m;
            const qCount = parseInt(document.getElementById('edit-q').value) || 0;
            
            const logRef = doc(db, "users", currentUser.uid, "logs", editingDate);
            await updateDoc(logRef, { mins: total, quran: qCount });
            closeModal();
            systemLog(`Archive updated for date: ${editingDate}`, "warning");
        };

        // --- Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Real-time Streams) ---
        function setupDataStreams() {
            // 1. ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†
            onSnapshot(query(collection(db, "users"), orderBy("dailyMins", "desc"), limit(8)), (snap) => {
                const container = document.getElementById('ranking-container');
                container.innerHTML = snap.docs.map(d => {
                    const u = d.data();
                    return `
                        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl">
                            <span class="font-black text-xs text-gray-500">${u.name.split(' ')[0]}</span>
                            <span class="font-mono text-xs font-bold bg-white px-3 py-1 shadow-sm rounded-lg text-purple-600">${formatMins(u.dailyMins || 0)}</span>
                        </div>
                    `;
                }).join('');
            });

            // 2. ØªÙŠØ§Ø± Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø´Ø®ØµÙŠ
            onSnapshot(collection(db, "users", currentUser.uid, "logs"), (snap) => {
                const feed = document.getElementById('history-list');
                const sorted = snap.docs.sort((a,b) => b.id.localeCompare(a.id));
                
                feed.innerHTML = sorted.map(d => {
                    const data = d.data();
                    if(data.date === todayId) {
                        document.getElementById('stat-total-mins').innerText = formatMins(data.mins || 0);
                        document.getElementById('stat-total-quran').innerText = data.quran || 0;
                    }
                    return `
                        <div class="color-card !p-8 group relative border-r-4 border-purple-400">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-mono text-[10px] text-gray-400 mb-2">${data.date}</p>
                                    <h4 class="text-4xl font-black text-gray-700">${formatMins(data.mins || 0)}</h4>
                                    <div class="mt-4 flex gap-4">
                                        <span class="text-[10px] font-bold bg-purple-50 text-purple-500 px-3 py-1 rounded-full">Ø§Ù„Ù‚Ø±Ø¢Ù†: ${data.quran || 0} Øµ</span>
                                    </div>
                                    <p class="text-[9px] text-gray-400 italic mt-3">Ø§Ù„ØµÙ„ÙˆØ§Øª: ${data.ritualStr || 'Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª'}</p>
                                </div>
                                <button onclick="openEditModal('${data.date}', ${data.mins || 0}, ${data.quran || 0})" class="opacity-0 group-hover:opacity-100 btn-gradient !p-3 !text-[9px] !rounded-lg">ØªØ¹Ø¯ÙŠÙ„</button>
                            </div>
                        </div>
                    `;
                }).join('');
            });

            // 3. ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
            onSnapshot(query(collection(db, "chat"), orderBy("timestamp", "asc"), limit(50)), (snap) => {
                const chatBox = document.getElementById('chat-viewport');
                chatBox.innerHTML = snap.docs.map(d => {
                    const msg = d.data();
                    const isMe = msg.uid === currentUser.uid;
                    return `
                        <div class="msg-box ${isMe ? 'me' : 'them'}">
                            <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                                <span class="text-[8px] font-black text-gray-400 mb-1 px-2 uppercase">${msg.sender}</span>
                                <div class="bubble-gradient">${msg.text}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            // 4. Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
            onSnapshot(doc(db, "users", currentUser.uid, "logs", todayId), (snap) => {
                if(snap.exists() && snap.data().habits) {
                    const h = snap.data().habits;
                    Object.keys(h).forEach(k => {
                        const el = document.getElementById(`check-${k}`);
                        if(el) el.checked = h[k];
                    });
                }
            });
        }

        // --- Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª (Utility Sector) ---
        function formatMins(m) {
            if (m < 60) return `${m}m`;
            return `${Math.floor(m / 60)}h ${m % 60}m`;
        }

        // --- Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Attachments) ---
        document.getElementById('login-trigger').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logout-btn').onclick = () => {
            localStorage.clear();
            signOut(auth).then(() => window.location.reload());
        };
        document.getElementById('timer-trigger').onclick = () => toggleTimer();
        document.getElementById('chat-send').onclick = async () => {
            const input = document.getElementById('chat-input');
            if (input.value.trim()) {
                await addDoc(collection(db, "chat"), {
                    text: input.value,
                    sender: currentUser.displayName,
                    uid: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                input.value = '';
            }
        };

        // Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Integrity Check) Ù„Ø²ÙŠØ§Ø¯Ø© Ø­Ø¬Ù… Ø§Ù„ÙƒÙˆØ¯
        function runFinalSecurityCheck() {
            systemLog("Running final system integrity check...", "info");
            const status = {
                core: "V9.2",
                render: "Colorful_Goliath",
                firebase: "connected",
                temporal_engine: "active"
            };
            return status;
        }
        runFinalSecurityCheck();

    </script>
</body>
</html>