<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN CORE V65 | Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØ§Ø¬Ø¯ ÙˆØ§Ù„Ø§Ø±ØªØ­Ø§Ù„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --titan-cyan: #06b6d4;
            --titan-emerald: #10b981;
            --titan-red: #ef4444;
            --titan-bg: #010409;
            --titan-panel: rgba(13, 17, 23, 0.98);
            --titan-border: rgba(48, 54, 61, 0.4);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--titan-bg);
            color: #e6edf3;
            background-image: radial-gradient(circle at 50% 50%, rgba(6, 182, 212, 0.02) 0%, transparent 70%);
            min-height: 100vh;
            margin: 0;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        .node-container {
            background: var(--titan-panel);
            backdrop-filter: blur(15px);
            border: 1px solid var(--titan-border);
            border-radius: 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            transition: all 0.4s ease;
        }

        .engine-orbital {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .orbital-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .orbital-track { fill: none; stroke: #0d1117; stroke-width: 12; }
        .orbital-fill {
            fill: none; stroke: var(--titan-cyan); stroke-width: 12; stroke-linecap: round;
            stroke-dasharray: 880; stroke-dashoffset: 880;
            transition: stroke-dashoffset 1s linear;
        }

        .cmd-button {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: #000; font-weight: 800;
            border-radius: 1rem;
            transition: 0.3s;
            cursor: pointer;
        }

        .prayer-matrix { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .prayer-cell { padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; border: 1px solid transparent; }
        .cell-active { background: rgba(16, 185, 129, 0.1); border-color: var(--titan-emerald); color: var(--titan-emerald); }
        .cell-inactive { background: rgba(239, 68, 68, 0.1); border-color: var(--titan-red); color: var(--titan-red); }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø±ØµØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .live-timer-badge {
            background: rgba(6, 182, 212, 0.15);
            color: var(--titan-cyan);
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 900;
            font-size: 1.1rem;
            margin-right: 15px;
            border: 1px solid rgba(6, 182, 212, 0.3);
            display: inline-block;
        }

        .custom-scroll { overflow-y: auto; scrollbar-width: thin; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="security-gate" class="fixed inset-0 z-[9999] bg-black flex flex-col items-center justify-center p-6">
        <h1 class="text-8xl font-black text-white italic tracking-tighter mb-8">TITAN V65</h1>
        <button id="auth-trigger" class="cmd-button px-16 py-6 text-xl shadow-2xl shadow-cyan-500/20">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>

    <div id="titan-mainframe" class="hidden opacity-0 transition-all duration-1000 p-6">
        <div class="max-w-[1700px] mx-auto grid grid-cols-12 gap-6">
            
            <aside class="col-span-12 lg:col-span-3 space-y-6">
                <div class="node-container p-6">
                    <div class="flex items-center gap-4">
                        <div id="user-hex" class="w-14 h-14 bg-cyan-900/30 border border-cyan-500/30 rounded-xl flex items-center justify-center text-cyan-400 font-black text-2xl">?</div>
                        <div>
                            <h2 id="user-alias" class="text-lg font-black text-white">ØªØ­Ù…ÙŠÙ„...</h2>
                            <p id="sys-time" class="text-sm font-bold mono text-cyan-600">00:00:00</p>
                        </div>
                    </div>
                    <button id="deauth-cmd" class="mt-6 w-full py-2 text-red-700 text-[10px] font-black uppercase tracking-widest hover:underline">Ø®Ø±ÙˆØ¬</button>
                </div>

                <div class="node-container p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xs font-black text-slate-400 uppercase italic">Ø§Ù„ØµÙ„ÙˆØ§Øª</h3>
                        <div id="p-ratio" class="mono text-xs font-black text-cyan-500">0/6</div>
                    </div>
                    <div id="prayer-hook" class="space-y-2"></div>
                </div>

                <div class="node-container p-6">
                    <h3 class="text-xs font-black text-slate-400 uppercase mb-4 italic">Ø§Ù„Ù‚Ø±Ø¢Ù†</h3>
                    <div class="flex gap-2">
                        <input type="number" id="q-input" class="flex-1 bg-black border border-slate-800 rounded-lg p-3 text-white font-black" placeholder="0">
                        <button id="q-push" class="cmd-button px-6 text-xs uppercase">Ø­ÙØ¸</button>
                    </div>
                </div>
            </aside>

            <section class="col-span-12 lg:col-span-6 space-y-6">
                <div class="node-container p-10 flex flex-col items-center">
                    <div class="engine-orbital">
                        <svg class="orbital-svg" viewBox="0 0 320 320">
                            <circle class="orbital-track" cx="160" cy="160" r="140"></circle>
                            <circle id="orb-progress" class="orbital-fill" cx="160" cy="160" r="140"></circle>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                            <h2 id="orb-timer" class="text-6xl font-black mono text-white leading-none">00:00:00</h2>
                            <div id="orb-status" class="mt-4 text-[9px] font-bold text-slate-500 tracking-[0.2em] uppercase">Standby</div>
                        </div>
                    </div>
                    <button id="orb-trigger" class="cmd-button mt-10 w-full max-w-sm py-6 text-lg italic">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ</button>
                    <div class="grid grid-cols-2 gap-6 w-full mt-10 pt-8 border-t border-white/5">
                        <div class="text-center">
                            <p class="text-[9px] text-slate-500 font-black mb-1 uppercase">Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ÙŠÙˆÙ…</p>
                            <p id="dash-m" class="text-4xl font-black mono text-white">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[9px] text-slate-500 font-black mb-1 uppercase">ØµÙØ­Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>
                            <p id="dash-q" class="text-4xl font-black mono text-white">0</p>
                        </div>
                    </div>
                </div>

                <div class="node-container p-6">
                    <h3 class="text-xs font-black uppercase mb-6 italic">Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ</h3>
                    <div id="history-stream" class="space-y-4 max-h-[600px] custom-scroll pr-2"></div>
                </div>
            </section>

            <aside class="col-span-12 lg:col-span-3 space-y-6">
                <div class="node-container p-6 border-b-2 border-cyan-500">
                    <h3 class="text-xs font-black text-center mb-6 uppercase tracking-widest text-cyan-500">Ø±ØµØ¯ Ø§Ù„Ù‚Ø§Ø¯Ø©</h3>
                    <div id="leaderboard-hook" class="space-y-4 max-h-[450px] custom-scroll"></div>
                </div>

                <div class="node-container h-[450px] flex flex-col overflow-hidden">
                    <div id="comms-flow" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scroll"></div>
                    <div class="p-3 bg-black/60 flex gap-2">
                        <input id="comms-input" type="text" placeholder="Ø¥Ø´Ø§Ø±Ø©..." class="flex-1 bg-slate-900 border border-slate-800 rounded-lg px-4 py-2 text-white text-xs outline-none">
                        <button id="comms-send" class="bg-cyan-600 text-black px-4 rounded-lg font-black italic">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <div id="inspector-modal" class="hidden fixed inset-0 z-[10000] bg-black/95 flex items-center justify-center p-6 backdrop-blur-2xl">
        <div class="node-container w-full max-w-4xl p-10 relative">
            <button onclick="CoreUI.closeInspector()" class="absolute top-6 left-6 text-3xl text-slate-500">&times;</button>
            <h4 id="ins-alias" class="text-4xl font-black italic mb-8"></h4>
            <div id="ins-data" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[500px] custom-scroll"></div>
        </div>
    </div>

    <div id="editor-modal" class="hidden fixed inset-0 z-[11000] bg-black/98 flex items-center justify-center p-6 backdrop-blur-3xl">
        <div class="node-container w-full max-w-xl p-8 border-2 border-cyan-500/20">
            <h4 class="text-xl font-black mb-8 italic">ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="ed-m" class="w-full bg-black border border-slate-800 rounded-xl p-4 text-white font-black text-2xl outline-none">
                    <input type="number" id="ed-q" class="w-full bg-black border border-slate-800 rounded-xl p-4 text-white font-black text-2xl outline-none">
                </div>
                <div id="ed-prayer-matrix" class="grid grid-cols-3 gap-2 bg-white/5 p-4 rounded-xl"></div>
                <div class="flex gap-4">
                    <button id="ed-save" class="flex-1 cmd-button py-4 text-sm">Ø­ÙØ¸</button>
                    <button onclick="CoreUI.closeEditor()" class="flex-1 bg-slate-800 text-white rounded-xl font-black text-xs">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, query, collection, orderBy, limit, updateDoc, increment, addDoc, serverTimestamp, getDoc, getDocs, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const fbConfig = {
            apiKey: "AIzaSyASLT_wouo9BTjd-dH18x8CLbqBZSMbz04",
            authDomain: "ultra-core.firebaseapp.com",
            projectId: "ultra-core",
            storageBucket: "ultra-core.firebasestorage.app",
            messagingSenderId: "351766462712",
            appId: "1:351766462712:web:e683d8aa0d213b6e59fb0d"
        };

        const app = initializeApp(fbConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        /**
         * TITAN V65 - ARCHITECTURAL KERNEL
         */
        class TitanCore {
            constructor() {
                this.user = null;
                this.secs = 0;
                this.isActive = false;
                this.ticker = null;
                this.today = new Date().toISOString().split('T')[0];
                this.todayFocus = 0;
                this.activeEdit = { date: null, habits: {} };
                this.prayerSchema = [
                    {id:'fajr', n:'Ø§Ù„ÙØ¬Ø±'}, {id:'dhuhr', n:'Ø§Ù„Ø¸Ù‡Ø±'}, {id:'asr', n:'Ø§Ù„Ø¹ØµØ±'},
                    {id:'maghrib', n:'Ø§Ù„Ù…ØºØ±Ø¨'}, {id:'isha', n:'Ø§Ù„Ø¹Ø´Ø§Ø¡'}, {id:'taraweeh', n:'ØªØ±Ø§ÙˆÙŠØ­'}
                ];
            }

            async initialize(userData) {
                this.user = userData;
                CoreUI.boot(true);
                this.restoreSession();
                await this.syncProfile();
                this.setupLifecycle(); // ØªÙØ¹ÙŠÙ„ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                this.startLiveStreams();
            }

            setupLifecycle() {
                // Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ§Ø¨Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
                window.addEventListener('beforeunload', () => {
                    this.clearStatusSync();
                });
                // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø±Ø¤ÙŠØ© Ø§Ù„ØµÙØ­Ø© (Ù„Ù„ØªØ£ÙƒÙŠØ¯ ÙÙ‚Ø·)
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden' && !this.isActive) {
                        // Ù„Ø§ Ù†ÙØ¹Ù„ Ø´ÙŠØ¡ Ù‡Ù†Ø§ Ù„Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø·Ù„Ø¨ Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
                    }
                });
            }

            async clearStatusSync() {
                if(!this.user) return;
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù…Ø³Ø­ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹
                const ref = doc(db, "users", this.user.uid);
                await updateDoc(ref, { status: "" });
            }

            async syncProfile() {
                const ref = doc(db, "users", this.user.uid);
                await setDoc(ref, { 
                    name: this.user.displayName, 
                    uid: this.user.uid, 
                    lastActive: serverTimestamp() 
                }, { merge: true });
                document.getElementById('user-alias').innerText = this.user.displayName;
                document.getElementById('user-hex').innerText = this.user.displayName[0];
            }

            restoreSession() {
                const s = localStorage.getItem(`v65_secs_${this.user.uid}`);
                this.secs = s ? parseInt(s) : 0;
                if(localStorage.getItem(`v65_run_${this.user.uid}`) === "true") this.toggleEngine();
                else CoreUI.updateOrbDisplay();
            }

            toggleEngine() {
                if(!this.isActive) {
                    this.isActive = true;
                    localStorage.setItem(`v65_run_${this.user.uid}`, "true");
                    CoreUI.setOrbState(true);
                    this.updateBroadcast();
                    this.ticker = setInterval(() => {
                        this.secs++;
                        localStorage.setItem(`v65_secs_${this.user.uid}`, this.secs);
                        CoreUI.updateOrbDisplay();
                        if(this.secs % 60 === 0) {
                            this.incrementLog('mins', 1);
                            this.updateBroadcast(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø±ØµØ¯ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
                        }
                    }, 1000);
                } else {
                    clearInterval(this.ticker);
                    this.isActive = false;
                    localStorage.setItem(`v65_run_${this.user.uid}`, "false");
                    CoreUI.setOrbState(false);
                    this.updateBroadcast();
                }
            }

            async incrementLog(field, val) {
                const ref = doc(db, "users", this.user.uid, "logs", this.today);
                await setDoc(ref, { [field]: increment(val), date: this.today }, { merge: true });
            }

            async updateBroadcast() {
                if(!this.user) return;
                const statusText = this.isActive ? "Ø¨ÙŠØ°Ø§ÙƒØ± Ø¯Ù„ÙˆÙ‚ØªÙŠ ğŸ”¥" : "";
                await updateDoc(doc(db, "users", this.user.uid), { 
                    status: statusText, 
                    todayMins: this.todayFocus || 0 
                });
            }

            startLiveStreams() {
                onSnapshot(query(collection(db, "users"), limit(50)), (snap) => {
                    const users = snap.docs.map(d => d.data()).sort((a,b) => (b.todayMins || 0) - (a.todayMins || 0));
                    CoreUI.renderLeaderboard(users);
                });

                onSnapshot(query(collection(db, "users", this.user.uid, "logs"), orderBy("date", "desc")), (snap) => {
                    this.todayFocus = 0;
                    const logs = snap.docs.map(doc => {
                        const d = doc.data();
                        if(d.date === this.today) {
                            this.todayFocus = d.mins || 0;
                            CoreUI.updateDashboard(d);
                            this.updateBroadcast(); // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
                        }
                        return d;
                    });
                    CoreUI.renderHistory(logs);
                });

                onSnapshot(query(collection(db, "chat"), orderBy("timestamp", "asc"), limit(50)), (snap) => {
                    CoreUI.renderComms(snap.docs.map(d => d.data()));
                });

                onSnapshot(doc(db, "users", this.user.uid, "logs", this.today), (snap) => {
                    if(snap.exists()) CoreUI.syncPrayerUI(snap.data().habits || {});
                });
            }
        }

        const CoreUI = {
            boot(isReady) {
                document.getElementById('security-gate').style.display = isReady ? 'none' : 'flex';
                const frame = document.getElementById('titan-mainframe');
                frame.classList.toggle('hidden', !isReady);
                if(isReady) {
                    setTimeout(() => frame.style.opacity = '1', 50);
                    this.buildPrayerHooks();
                }
            },

            updateOrbDisplay() {
                const s = Kernel.secs;
                const h = Math.floor(s/3600).toString().padStart(2,'0');
                const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
                const sc = (s%60).toString().padStart(2,'0');
                document.getElementById('orb-timer').innerText = `${h}:${m}:${sc}`;
                document.getElementById('orb-progress').style.strokeDashoffset = 880 - ((s%60)/60 * 880);
            },

            setOrbState(active) {
                const btn = document.getElementById('orb-trigger');
                btn.innerText = active ? "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù€ØªØ±ÙƒÙŠØ²" : "ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ";
                btn.style.filter = active ? "hue-rotate(160deg)" : "none";
                document.getElementById('orb-status').innerText = active ? "Executing_Logic" : "Standby";
            },

            buildPrayerHooks() {
                const h = document.getElementById('prayer-hook');
                h.innerHTML = Kernel.prayerSchema.map(p => `
                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5">
                        <span class="text-xs font-bold text-slate-400">${p.n}</span>
                        <input type="checkbox" id="chk-${p.id}" onchange="LogicHandlers.togglePrayer('${p.id}')" class="w-5 h-5 accent-cyan-500 cursor-pointer">
                    </div>
                `).join('');
            },

            updateDashboard(d) {
                document.getElementById('dash-m').innerText = d.mins || 0;
                document.getElementById('dash-q').innerText = d.quran || 0;
                const done = Object.values(d.habits || {}).filter(v => v).length;
                document.getElementById('p-ratio').innerText = `${done}/6`;
            },

            renderLeaderboard(users) {
                const hook = document.getElementById('leaderboard-hook');
                hook.innerHTML = users.map((u, i) => `
                    <div onclick="CoreUI.openInspector('${u.uid}', '${u.name}')" class="p-4 bg-white/5 rounded-xl border border-white/5 cursor-pointer hover:bg-white/10 transition-all">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="mono text-xs font-black ${i<3?'text-cyan-500':'text-slate-700'}">#${i+1}</span>
                                <p class="text-sm font-black text-white">${u.name}</p>
                            </div>
                            <div class="live-timer-badge mono">${u.todayMins || 0} Ø¯</div>
                        </div>
                        ${u.status ? `<div class="mt-3 flex items-center gap-2"><div class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse"></div><p class="text-xs text-cyan-500 italic font-black">${u.status}</p></div>` : ''}
                    </div>
                `).join('');
            },

            renderHistory(logs) {
                const stream = document.getElementById('history-stream');
                stream.innerHTML = logs.map(l => {
                    const pCells = Kernel.prayerSchema.map(p => `<div class="prayer-cell ${(l.habits && l.habits[p.id]) ? 'cell-active' : 'cell-inactive'}">${p.n}</div>`).join('');
                    return `
                        <div class="node-container p-5 relative group">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-[9px] text-cyan-500 mono mb-1">${l.date}</p>
                                    <h4 class="text-2xl font-black text-white">${l.mins || 0} <span class="text-xs text-slate-600">Ø¯Ù‚ÙŠÙ‚Ø©</span></h4>
                                </div>
                                <div class="bg-emerald-500/5 px-3 py-1 rounded border border-emerald-500/10"><p class="text-xl font-black text-emerald-400">${l.quran || 0} Øµ</p></div>
                            </div>
                            <div class="prayer-matrix">${pCells}</div>
                            <button onclick="CoreUI.openEditor('${l.date}', ${l.mins || 0}, ${l.quran || 0}, ${JSON.stringify(l.habits || {}).replace(/"/g, '&quot;')})" class="absolute bottom-4 left-4 opacity-0 group-hover:opacity-100 bg-white text-black px-4 py-2 rounded-lg text-[9px] font-black">ØªØ¹Ø¯ÙŠÙ„</button>
                        </div>`;
                }).join('');
            },

            renderComms(msgs) {
                const f = document.getElementById('comms-flow');
                f.innerHTML = msgs.map(m => `
                    <div class="flex flex-col ${m.uid===Kernel.user.uid?'items-end':'items-start'}">
                        <span class="text-[8px] text-slate-600 mb-1 font-black">${m.sender}</span>
                        <div class="${m.uid===Kernel.user.uid?'bg-cyan-600 text-black':'bg-slate-800 text-white'} px-4 py-2 rounded-xl text-xs font-bold">${m.text}</div>
                    </div>`).join('');
                f.scrollTop = f.scrollHeight;
            },

            syncPrayerUI(h) {
                Kernel.prayerSchema.forEach(p => { if(document.getElementById(`chk-${p.id}`)) document.getElementById(`chk-${p.id}`).checked = h[p.id] || false; });
            },

            openInspector(uid, name) {
                document.getElementById('ins-alias').innerText = name;
                document.getElementById('ins-data').innerHTML = '<div class="col-span-full text-center mono text-cyan-600 animate-pulse">Scanning_Bio_Logs...</div>';
                document.getElementById('inspector-modal').classList.remove('hidden');
                getDocs(query(collection(db, "users", uid, "logs"), orderBy("date", "desc"))).then(snap => {
                    document.getElementById('ins-data').innerHTML = snap.docs.map(doc => {
                        const d = doc.data();
                        const pCells = Kernel.prayerSchema.map(p => `<div class="prayer-cell ${(d.habits && d.habits[p.id]) ? 'cell-active' : 'cell-inactive'}">${p.n}</div>`).join('');
                        return `<div class="p-4 bg-white/5 rounded-xl border border-white/5">
                            <p class="text-[9px] text-cyan-500 mono mb-2">${d.date}</p>
                            <div class="flex justify-between items-center mb-2"><p class="text-xl font-black text-white">${d.mins || 0}m</p><p class="text-lg font-black text-emerald-400">${d.quran || 0}p</p></div>
                            <div class="prayer-matrix">${pCells}</div>
                        </div>`;
                    }).join('');
                });
            },
            closeInspector() { document.getElementById('inspector-modal').classList.add('hidden'); },

            openEditor(date, mins, quran, habits) {
                Kernel.activeEdit = { date, habits: habits || {} };
                document.getElementById('ed-m').value = mins;
                document.getElementById('ed-q').value = quran;
                document.getElementById('ed-prayer-matrix').innerHTML = Kernel.prayerSchema.map(p => `
                    <div class="flex flex-col items-center gap-1 p-2 bg-black/40 rounded-lg">
                        <span class="text-[8px] font-bold text-slate-500">${p.n}</span>
                        <input type="checkbox" id="ed-chk-${p.id}" ${Kernel.activeEdit.habits[p.id] ? 'checked' : ''} onchange="Kernel.activeEdit.habits['${p.id}'] = this.checked" class="w-4 h-4 accent-emerald-500">
                    </div>`).join('');
                document.getElementById('editor-modal').classList.remove('hidden');
            },
            closeEditor() { document.getElementById('editor-modal').classList.add('hidden'); }
        };

        const LogicHandlers = {
            async togglePrayer(id) {
                const chk = document.getElementById(`chk-${id}`).checked;
                const ref = doc(db, "users", Kernel.user.uid, "logs", Kernel.today);
                const snap = await getDoc(ref);
                let habits = snap.exists() ? (snap.data().habits || {}) : {};
                habits[id] = chk;
                await setDoc(ref, { habits, date: Kernel.today }, { merge: true });
            },

            async commitEdit() {
                const nM = parseInt(document.getElementById('ed-m').value) || 0;
                const nQ = parseInt(document.getElementById('ed-q').value) || 0;
                const h = Kernel.activeEdit.habits;
                const ref = doc(db, "users", Kernel.user.uid, "logs", Kernel.activeEdit.date);
                await updateDoc(ref, { mins: nM, quran: nQ, habits: h });
                if(Kernel.activeEdit.date === Kernel.today) {
                    Kernel.secs = nM * 60;
                    localStorage.setItem(`v65_secs_${Kernel.user.uid}`, Kernel.secs);
                    CoreUI.updateOrbDisplay();
                    Kernel.updateBroadcast();
                }
                CoreUI.closeEditor();
            }
        };

        const Kernel = new TitanCore();
        onAuthStateChanged(auth, async (u) => { if(u) await Kernel.initialize(u); else CoreUI.boot(false); });

        document.getElementById('auth-trigger').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('deauth-cmd').onclick = () => signOut(auth).then(() => { localStorage.clear(); window.location.reload(); });
        document.getElementById('orb-trigger').onclick = () => Kernel.toggleEngine();
        document.getElementById('ed-save').onclick = () => LogicHandlers.commitEdit();
        document.getElementById('q-push').onclick = async () => {
            const v = parseInt(document.getElementById('q-input').value) || 0;
            if(v > 0) { await Kernel.incrementLog('quran', v); document.getElementById('q-input').value = ''; }
        };
        document.getElementById('comms-send').onclick = async () => {
            const inp = document.getElementById('comms-input');
            if(!inp.value.trim()) return;
            await addDoc(collection(db, "chat"), { text: inp.value, sender: Kernel.user.displayName, uid: Kernel.user.uid, timestamp: serverTimestamp() });
            inp.value = '';
        };

        setInterval(() => { document.getElementById('sys-time').innerText = new Date().toLocaleTimeString('en-US', { hour12: false }); }, 1000);
        window.CoreUI = CoreUI; window.LogicHandlers = LogicHandlers; window.Kernel = Kernel;
    </script>
</body>
</html>