<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø£Ù„ØªØ±Ø§ ÙƒÙˆØ± | Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --sys-cyan: #06b6d4;
            --sys-emerald: #10b981;
            --sys-bg: #010409;
            --sys-card: rgba(13, 17, 23, 0.95);
            --sys-border: rgba(48, 54, 61, 0.8);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--sys-bg);
            color: #e6edf3;
            background-image: 
                radial-gradient(circle at 2px 2px, rgba(6, 182, 212, 0.05) 1px, transparent 0);
            background-size: 40px 40px;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø© */
        .ultra-glass {
            background: var(--sys-card);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--sys-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        /* Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†ÙŠÙˆÙ†ÙŠ */
        .timer-viewport {
            position: relative;
            width: 440px;
            height: 440px;
            filter: drop-shadow(0 0 20px rgba(6, 182, 212, 0.2));
        }

        .svg-ring { transform: rotate(-90deg); width: 100%; height: 100%; }
        .ring-track { fill: none; stroke: #161b22; stroke-width: 18; }
        .ring-progress {
            fill: none; stroke: var(--sys-cyan); stroke-width: 18; stroke-linecap: round;
            stroke-dasharray: 880; stroke-dashoffset: 880;
            transition: stroke-dashoffset 1s linear, stroke 0.5s ease;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© */
        .btn-command {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: #000;
            font-weight: 900;
            letter-spacing: -0.5px;
            box-shadow: 0 4px 14px 0 rgba(6, 182, 212, 0.39);
        }

        .btn-command:active { transform: scale(0.95); }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù… */
        .log-item {
            border-right: 5px solid var(--sys-cyan);
            background: linear-gradient(90deg, rgba(30, 41, 59, 0.4) 0%, transparent 100%);
        }

        .status-badge {
            font-size: 9px;
            padding: 2px 10px;
            border-radius: 20px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--sys-emerald);
            border: 1px solid rgba(16, 185, 129, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; }
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--sys-cyan); }
    </style>
</head>
<body class="antialiased overflow-x-hidden">

    <div id="gatekeeper" class="fixed inset-0 z-[10000] bg-black flex flex-col items-center justify-center p-6">
        <div class="relative mb-12">
            <div class="absolute -inset-20 bg-cyan-500/10 blur-[120px] rounded-full"></div>
            <h1 class="text-9xl font-black text-white italic tracking-tighter mix-blend-difference">UC<span class="text-cyan-500">.</span></h1>
        </div>
        <button id="gate-trigger" class="btn-command px-24 py-7 rounded-[2rem] text-2xl tracking-tighter">ØªÙ‡ÙŠØ¦Ù€Ù€Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù€Ù…Ø±ÙƒØ²ÙŠ</button>
    </div>

    <div id="app-container" class="hidden opacity-0 transition-opacity duration-1000">
        <header class="ultra-glass sticky top-0 z-[500] px-10 py-6 flex justify-between items-center border-b border-white/5">
            <div class="flex items-center gap-8">
                <div class="h-14 w-2 bg-cyan-500 rounded-full shadow-[0_0_15px_rgba(6,182,212,0.5)]"></div>
                <div>
                    <h2 class="text-3xl font-black text-white leading-none">Ù…Ù€Ø±ÙƒØ² Ø§Ù„Ù€ØªØ­ÙƒÙ…</h2>
                    <p id="active-user-tag" class="text-[10px] text-cyan-500 font-bold uppercase tracking-[0.3em] mt-2"></p>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <div id="live-indicator" class="flex items-center gap-2 px-4 py-2 bg-emerald-500/5 rounded-full border border-emerald-500/20">
                    <div class="w-2 h-2 bg-emerald-500 rounded-full animate-ping"></div>
                    <span class="text-[10px] font-black text-emerald-500">Ø§ØªØµØ§Ù„ Ù†Ø´Ø·</span>
                </div>
                <button id="system-exit" class="text-red-500 font-black text-xs hover:underline">Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            </div>
        </header>

        <main class="max-w-[1920px] mx-auto p-10 grid grid-cols-12 gap-12">
            
            <section class="col-span-12 lg:col-span-3 space-y-10">
                <div class="ultra-glass rounded-[3.5rem] p-10 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-emerald-500"></div>
                    <h3 class="text-2xl font-black text-white mb-10 flex items-center justify-between">
                        Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„Ø±ÙˆØ­Ø§Ù†ÙŠ
                        <span id="prayer-count-ui" class="text-sm font-mono text-emerald-500 bg-emerald-500/10 px-3 py-1 rounded-lg">0/6</span>
                    </h3>
                    <div id="prayer-container" class="space-y-4">
                        </div>
                    
                    <div class="mt-12 space-y-6">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest text-center">ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†</p>
                        <div class="flex gap-4">
                            <input type="number" id="quran-input" class="w-full bg-slate-900/50 border border-slate-700 rounded-2xl px-6 py-5 text-white font-black text-2xl outline-none focus:border-emerald-500" placeholder="0">
                            <button onclick="executeQuranUpdate()" class="bg-emerald-500 text-black px-8 rounded-2xl font-black hover:bg-white transition-all">Ø­ÙØ¸</button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="col-span-12 lg:col-span-6 space-y-10">
                <div class="ultra-glass rounded-[5rem] p-20 flex flex-col items-center justify-center relative">
                    <div class="timer-viewport">
                        <svg class="svg-ring" viewBox="0 0 320 320">
                            <circle class="ring-track" cx="160" cy="160" r="140"></circle>
                            <circle id="timer-progress-bar" class="ring-progress" cx="160" cy="160" r="140"></circle>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <h2 id="timer-display" class="text-8xl font-mono font-black text-white tracking-tighter neon-glow-cyan">00:00:00</h2>
                            <div id="engine-mode" class="mt-6 px-8 py-2 bg-cyan-500/10 border border-cyan-500/20 rounded-full text-[10px] font-black text-cyan-400 uppercase tracking-widest">System Standby</div>
                        </div>
                    </div>
                    
                    <button id="timer-trigger" class="btn-command mt-16 w-full max-w-lg py-10 rounded-[3rem] text-4xl italic tracking-tighter">ØªÙØ¹ÙŠÙ„ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ²</button>
                    
                    <div class="grid grid-cols-2 gap-8 w-full mt-16 pt-10 border-t border-white/5">
                        <div class="text-center">
                            <p class="text-[10px] text-slate-500 font-black uppercase mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµÙØ­Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>
                            <p id="today-quran-stat" class="text-3xl font-black text-white font-mono">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[10px] text-slate-500 font-black uppercase mb-2">Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</p>
                            <p id="today-mins-stat" class="text-3xl font-black text-white font-mono">0</p>
                        </div>
                    </div>
                </div>

                <div class="ultra-glass rounded-[3.5rem] p-12">
                    <h3 class="text-2xl font-black text-white mb-10 flex items-center gap-4">
                        <div class="w-2 h-8 bg-cyan-500"></div>
                        Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ
                    </h3>
                    <div id="my-logs-archive" class="space-y-6 max-h-[600px] overflow-y-auto pr-6">
                        </div>
                </div>
            </section>

            <section class="col-span-12 lg:col-span-3 space-y-10">
                <div class="ultra-glass rounded-[3rem] p-8 border-b-4 border-cyan-500">
                    <h3 class="text-xl font-black text-center text-white mb-10 tracking-widest">Ù„ÙˆØ­Ø© Ø§Ù„Ù†Ø®Ø¨Ø© ğŸ†</h3>
                    <div id="global-leaderboard" class="space-y-4">
                        </div>
                </div>

                <div class="ultra-glass rounded-[3rem] h-[550px] flex flex-col overflow-hidden">
                    <div class="p-6 bg-slate-900/50 border-b border-slate-800 text-center">
                        <span class="text-[10px] font-black text-cyan-500 tracking-[0.4em]">ENCRYPTED CHAT</span>
                    </div>
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-8 space-y-6"></div>
                    <div class="p-6 bg-slate-950 flex gap-4">
                        <input id="chat-input-field" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." class="flex-1 bg-slate-900 border-none rounded-2xl px-6 py-4 text-sm text-white outline-none ring-1 ring-slate-800 focus:ring-cyan-500">
                        <button id="send-chat-btn" class="bg-cyan-500 text-black px-8 rounded-2xl font-black text-xs">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="inspector-modal" class="hidden fixed inset-0 z-[10000] bg-black/98 backdrop-blur-3xl flex items-center justify-center p-8">
        <div class="ultra-glass p-16 rounded-[5rem] w-full max-w-4xl border-2 border-slate-800 shadow-[0_0_100px_rgba(6,182,212,0.1)]">
            <div class="flex justify-between items-start mb-12">
                <div>
                    <h4 id="inspector-user-name" class="text-5xl font-black text-white italic tracking-tighter"></h4>
                    <p class="text-cyan-500 font-mono text-sm tracking-[0.5em] uppercase mt-4">Operational History Metadata</p>
                </div>
                <button onclick="closeInspector()" class="text-slate-500 hover:text-white text-6xl leading-none">&times;</button>
            </div>
            
            <div id="inspector-logs-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[600px] overflow-y-auto pr-6">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, query, collection, orderBy, limit, updateDoc, increment, addDoc, serverTimestamp, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURATION LAYER
        const firebaseConfig = {
            apiKey: "AIzaSyASLT_wouo9BTjd-dH18x8CLbqBZSMbz04",
            authDomain: "ultra-core.firebaseapp.com",
            projectId: "ultra-core",
            storageBucket: "ultra-core.firebasestorage.app",
            messagingSenderId: "351766462712",
            appId: "1:351766462712:web:e683d8aa0d213b6e59fb0d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // STATE ENGINE
        let internalSeconds = 0, isEngineRunning = false, sessionUser = null, timerInterval = null;
        const currentDayKey = new Date().toISOString().split('T')[0];

        const PRAYER_REFERENCE = [
            {id: 'fajr', label: 'ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø±'}, {id: 'dhuhr', label: 'ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø±'},
            {id: 'asr', label: 'ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ±'}, {id: 'maghrib', label: 'ØµÙ„Ø§Ø© Ø§Ù„Ù…ØºØ±Ø¨'},
            {id: 'isha', label: 'ØµÙ„Ø§Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡'}, {id: 'taraweeh', label: 'ØµÙ„Ø§Ø© Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­'}
        ];

        // BOOT PROTOCOL
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                sessionUser = user;
                document.getElementById('gatekeeper').style.display = 'none';
                const appRoot = document.getElementById('app-container');
                appRoot.classList.remove('hidden');
                setTimeout(() => appRoot.style.opacity = '1', 100);
                
                document.getElementById('active-user-tag').innerText = `USER_ID: ${user.uid.substring(0,12)}... | ${user.displayName}`;

                // Restore Engine State
                internalSeconds = parseInt(localStorage.getItem(`UC_V4_SECS_${user.uid}`)) || 0;
                if (localStorage.getItem(`UC_V4_RUN_${user.uid}`) === "true") runEngineControl(true);
                else refreshTimerUI();

                await syncUserCore();
                initializePrayerUI();
                activateGlobalStreams();
            } else {
                document.getElementById('gatekeeper').style.display = 'flex';
            }
        });

        async function syncUserCore() {
            const ref = doc(db, "users", sessionUser.uid);
            await setDoc(ref, { name: sessionUser.displayName, uid: sessionUser.uid, lastSeen: serverTimestamp() }, { merge: true });
        }

        function initializePrayerUI() {
            const container = document.getElementById('prayer-container');
            container.innerHTML = PRAYER_REFERENCE.map(p => `
                <div class="group flex items-center justify-between p-6 bg-slate-900/40 rounded-[2rem] border border-slate-800 hover:border-emerald-500/30 transition-all cursor-pointer">
                    <span class="font-bold text-slate-400 group-hover:text-white">${p.label}</span>
                    <div class="relative inline-flex items-center">
                        <input type="checkbox" id="check-${p.id}" onchange="processPrayerSync('${p.id}')" class="w-7 h-7 accent-emerald-500 rounded-lg cursor-pointer">
                    </div>
                </div>
            `).join('');
        }

        // --- CORE ENGINE (TIMER) ---
        function runEngineControl(force = false) {
            if (!isEngineRunning || force) {
                isEngineRunning = true;
                localStorage.setItem(`UC_V4_RUN_${sessionUser.uid}`, "true");
                const btn = document.getElementById('timer-trigger');
                btn.innerText = "Ø¥ÙŠÙ‚Ù€Ø§Ù Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„";
                btn.style.filter = "hue-rotate(140deg)";
                document.getElementById('engine-mode').innerText = "Status: Executing Focus ğŸ”¥";
                updateCloudStatus("Ø¨ÙŠØ°Ø§ÙƒØ± Ø¯Ù„ÙˆÙ‚ØªÙŠ ğŸ”¥");

                timerInterval = setInterval(() => {
                    internalSeconds++;
                    localStorage.setItem(`UC_V4_SECS_${sessionUser.uid}`, internalSeconds);
                    refreshTimerUI();
                    syncCircularProgress((internalSeconds % 60 / 60) * 100);
                    if (internalSeconds % 60 === 0) logActivityMins(1);
                }, 1000);
            } else {
                clearInterval(timerInterval);
                isEngineRunning = false;
                localStorage.setItem(`UC_V4_RUN_${sessionUser.uid}`, "false");
                const btn = document.getElementById('timer-trigger');
                btn.innerText = "ØªÙØ¹ÙŠÙ„ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ²";
                btn.style.filter = "none";
                document.getElementById('engine-mode').innerText = "Status: System Idle";
                updateCloudStatus("Ù…Ø±ÙŠØ­ Ø´ÙˆÙŠØ© â˜•");
            }
        }

        function refreshTimerUI() {
            const h = Math.floor(internalSeconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((internalSeconds % 3600) / 60).toString().padStart(2, '0');
            const s = (internalSeconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
        }

        function syncCircularProgress(p) {
            document.getElementById('timer-progress-bar').style.strokeDashoffset = 880 - (p / 100 * 880);
        }

        // --- DATA PIPELINE (The Verbose Logging System) ---
        window.processPrayerSync = async (pId) => {
            const isChecked = document.getElementById(`check-${pId}`).checked;
            const logRef = doc(db, "users", sessionUser.uid, "logs", currentDayKey);
            const userRef = doc(db, "users", sessionUser.uid);

            const snap = await getDoc(logRef);
            let habits = snap.exists() ? (snap.data().habits || {}) : {};
            habits[pId] = isChecked;

            // Verbose Transformation Engine
            const prayerString = PRAYER_REFERENCE.filter(k => habits[k.id]).map(k => k.label).join(' â€¢ ');

            await setDoc(logRef, { 
                habits: habits, 
                readable_prayers: prayerString, 
                date: currentDayKey 
            }, { merge: true });

            await updateDoc(userRef, { [`live_habits.${pId}`]: isChecked });
            updatePrayerCountUI(habits);
        }

        window.executeQuranUpdate = async () => {
            const val = parseInt(document.getElementById('quran-input').value) || 0;
            if (val <= 0) return;
            const logRef = doc(db, "users", sessionUser.uid, "logs", currentDayKey);
            const userRef = doc(db, "users", sessionUser.uid);
            await setDoc(logRef, { quran: increment(val), date: currentDayKey }, { merge: true });
            await updateDoc(userRef, { total_q: increment(val) });
            document.getElementById('quran-input').value = '';
        }

        async function logActivityMins(m) {
            const logRef = doc(db, "users", sessionUser.uid, "logs", currentDayKey);
            const userRef = doc(db, "users", sessionUser.uid);
            await setDoc(logRef, { mins: increment(m), date: currentDayKey }, { merge: true });
            await updateDoc(userRef, { daily_mins: increment(m) });
        }

        async function updateCloudStatus(statusText) {
            await updateDoc(doc(db, "users", sessionUser.uid), { status: statusText });
        }

        function updatePrayerCountUI(habits) {
            const count = Object.values(habits).filter(v => v === true).length;
            document.getElementById('prayer-count-ui').innerText = `${count}/6`;
        }

        // --- PEER INSPECTION ENGINE (View Friend Logs) ---
        window.openInspector = async (uid, name) => {
            document.getElementById('inspector-user-name').innerText = name;
            const container = document.getElementById('inspector-logs-grid');
            container.innerHTML = '<div class="col-span-full py-20 text-center font-mono text-cyan-500 animate-pulse">DECRYPTING ARCHIVES...</div>';
            document.getElementById('inspector-modal').classList.remove('hidden');

            const q = query(collection(db, "users", uid, "logs"), orderBy("date", "desc"), limit(30));
            const snap = await getDocs(q);
            
            container.innerHTML = '';
            if (snap.empty) {
                container.innerHTML = '<p class="col-span-full text-center text-slate-500 py-10">No Operational Data Found.</p>';
                return;
            }

            snap.forEach(d => {
                const data = d.data();
                container.innerHTML += `
                    <div class="p-8 ultra-glass rounded-[2.5rem] border-l-4 border-cyan-500 hover:scale-[1.02] transition-transform">
                        <div class="flex justify-between items-start mb-6">
                            <span class="text-[10px] font-mono text-slate-500 uppercase">${data.date}</span>
                            <span class="text-2xl font-black text-white font-mono">${formatLogTime(data.mins || 0)}</span>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 text-emerald-500 font-bold text-xs">
                                <span>ğŸ“–</span> <span>Ø§Ù„Ù‚Ø±Ø¢Ù†: ${data.quran || 0} ØµÙØ­Ø©</span>
                            </div>
                            <div class="text-[11px] text-slate-400 leading-relaxed">
                                <span class="text-white font-black block mb-1">Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©:</span>
                                ${data.readable_prayers || 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª'}
                            </div>
                        </div>
                    </div>`;
            });
        }

        window.closeInspector = () => document.getElementById('inspector-modal').classList.add('hidden');

        // --- GLOBAL STREAMING SYSTEM ---
        function activateGlobalStreams() {
            // Leaderboard Realtime
            onSnapshot(query(collection(db, "users"), orderBy("daily_mins", "desc"), limit(12)), (snap) => {
                const board = document.getElementById('global-leaderboard');
                board.innerHTML = '';
                snap.docs.forEach(d => {
                    const data = d.data();
                    board.innerHTML += `
                        <div class="p-6 ultra-glass rounded-3xl border ${d.id === sessionUser.uid ? 'border-cyan-500/50 bg-cyan-500/5' : 'border-slate-800'}">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-black text-white text-sm">${data.name.split(' ')[0]}</h4>
                                <span class="status-badge">${data.status || 'Standby'}</span>
                            </div>
                            <div class="flex justify-between items-end">
                                <span class="text-xl font-mono font-black text-white">${formatLogTime(data.daily_mins || 0)}</span>
                                <button onclick="openInspector('${d.id}', '${data.name}')" class="text-[9px] font-black text-cyan-500 bg-cyan-500/10 px-4 py-2 rounded-xl hover:bg-cyan-500 hover:text-black transition-all">ØªÙØªÙŠØ´ Ø§Ù„Ø³Ø¬Ù„</button>
                            </div>
                        </div>`;
                });
            });

            // Personal Log Stream
            onSnapshot(collection(db, "users", sessionUser.uid, "logs"), (snap) => {
                const archive = document.getElementById('my-logs-archive');
                archive.innerHTML = '';
                const sorted = snap.docs.sort((a,b) => b.id.localeCompare(a.id));
                sorted.forEach(d => {
                    const data = d.data();
                    if(data.date === currentDayKey) {
                        document.getElementById('today-quran-stat').innerText = data.quran || 0;
                        document.getElementById('today-mins-stat').innerText = data.mins || 0;
                        updatePrayerCountUI(data.habits || {});
                    }
                    archive.innerHTML += `
                        <div class="p-6 ultra-glass rounded-3xl log-item">
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-[10px] font-mono text-slate-500">${data.date}</span>
                                <span class="text-xl font-black text-white font-mono">${formatLogTime(data.mins || 0)}</span>
                            </div>
                            <p class="text-[10px] text-slate-400 font-bold">ğŸ•‹ Ø§Ù„ØµÙ„ÙˆØ§Øª: <span class="text-emerald-500">${data.readable_prayers || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</span></p>
                        </div>`;
                });
            });

            // Encrypted Chat Stream
            onSnapshot(query(collection(db, "chat"), orderBy("timestamp", "asc"), limit(50)), (snap) => {
                const chatBox = document.getElementById('chat-messages');
                chatBox.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const isMe = data.uid === sessionUser.uid;
                    chatBox.innerHTML += `
                        <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                            <span class="text-[8px] text-slate-600 font-black mb-1 px-2">${data.sender.split(' ')[0]}</span>
                            <div class="${isMe ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-300'} px-5 py-3 rounded-2xl text-[11px] font-bold shadow-xl max-w-[85%]">${data.text}</div>
                        </div>`;
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            // Daily Habit UI Restoration
            onSnapshot(doc(db, "users", sessionUser.uid, "logs", currentDayKey), (snap) => {
                if(snap.exists() && snap.data().habits) {
                    const h = snap.data().habits;
                    Object.keys(h).forEach(k => {
                        const el = document.getElementById(`check-${k}`);
                        if(el) el.checked = h[k];
                    });
                }
            });
        }

        function formatLogTime(m) {
            if (m < 60) return `${m}m`;
            return `${Math.floor(m/60)}h ${m%60}m`;
        }

        // INTERACTION TRIGGERS
        document.getElementById('gate-trigger').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('system-exit').onclick = () => { localStorage.clear(); signOut(auth).then(()=>window.location.reload()); };
        document.getElementById('timer-trigger').onclick = () => runEngineControl();
        document.getElementById('send-chat-btn').onclick = async () => {
            const field = document.getElementById('chat-input-field');
            if (field.value.trim()) {
                await addDoc(collection(db, "chat"), { text: field.value, sender: sessionUser.displayName, uid: sessionUser.uid, timestamp: serverTimestamp() });
                field.value = '';
            }
        };

    </script>
</body>
</html>