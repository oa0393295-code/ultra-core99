<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ğŸ”¥ Study War Ultimate Live</title>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
  text-align:center;
}
h1{color:#00ffcc;text-shadow:0 0 15px #00ffcc;}
input,button{
  padding:10px;
  margin:5px;
  border-radius:8px;
  border:none;
}
button{
  background:#ff00ff;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}
button:hover{transform:scale(1.05);}
.section{
  background:rgba(255,255,255,0.05);
  margin:20px auto;
  padding:15px;
  border-radius:12px;
  width:90%;
  max-width:600px;
}
.player{
  background:rgba(255,255,255,0.08);
  margin:8px;
  padding:8px;
  border-radius:8px;
}
.first{background:gold;color:#000;font-weight:bold;}
.badge{
  display:inline-block;
  background:#ffcc00;
  color:#000;
  padding:4px 8px;
  border-radius:6px;
  margin:4px;
}
.timer{
  font-size:28px;
  margin:10px;
  color:#00ffcc;
}
</style>
</head>
<body>

<h1>ğŸ”¥ Study War Ultimate</h1>

<!-- AUTH -->
<div id="auth" class="section">
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button id="registerBtn">ØªØ³Ø¬ÙŠÙ„</button>
  <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- MAIN -->
<div id="main" style="display:none;">

  <!-- PROFILE -->
  <div class="section">
    <h2 id="welcome"></h2>
    <input type="number" id="hours" placeholder="Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©">
    <button onclick="addStudy()">Ø£Ø¶Ù Ø³Ø§Ø¹Ø§Øª</button>
    <div id="achievements"></div>
    <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  </div>

  <!-- LEADERBOARD -->
  <div class="section">
    <h2>ğŸ† Leaderboard</h2>
    <div id="leaderboard"></div>
  </div>

  <!-- ROOM -->
  <div class="section">
    <h2>ğŸ”¥ Live Room</h2>
    <input type="text" id="roomName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø±ÙˆÙ…">
    <button onclick="createRoom()">Ø¥Ù†Ø´Ø§Ø¡ Ø±ÙˆÙ…</button><br>

    <input type="text" id="joinRoomId" placeholder="ID Ø§Ù„Ø±ÙˆÙ…">
    <button onclick="joinRoom()">Ø¯Ø®ÙˆÙ„ Ø±ÙˆÙ…</button>

    <div id="roomArea" style="display:none;">
      <h3 id="roomTitle"></h3>
      <div class="timer" id="timer">25:00</div>
      <button onclick="startPomodoro()">Ø§Ø¨Ø¯Ø£ Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ</button>
      <button onclick="toggleStudy()">ğŸ“š Ø§Ø¨Ø¯Ø£/Ø£ÙˆÙ‚Ù Ù…Ø°Ø§ÙƒØ±Ø©</button>
      <div id="roomMembers"></div>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, getDocs, query, orderBy, updateDoc, onSnapshot, setDoc }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyASLT_wouo9BTjd-dH18x8CLbqBZSMbz04",
  authDomain: "ultra-core.firebaseapp.com",
  projectId: "ultra-core",
  storageBucket: "ultra-core.firebasestorage.app",
  messagingSenderId: "351766462712",
  appId: "1:351766462712:web:e683d8aa0d213b6e59fb0d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore(app);

const playersRef = collection(db,"players");
const roomsRef = collection(db,"rooms");

let currentRoomId=null;
let studying=false;
let localTimer=null;

/* AUTH */
registerBtn.onclick=()=>{
  createUserWithEmailAndPassword(auth,email.value,password.value)
  .catch(e=>alert(e.message));
};

loginBtn.onclick=()=>{
  signInWithEmailAndPassword(auth,email.value,password.value)
  .catch(e=>alert(e.message));
};

onAuthStateChanged(auth,user=>{
  if(user){
    authDiv(false);
    welcome.innerText="Ù…Ø±Ø­Ø¨Ù‹Ø§ "+user.email;
    checkUser(user);
    listenLeaderboard();
  }else authDiv(true);
});

function authDiv(show){
  document.getElementById("auth").style.display=show?"block":"none";
  document.getElementById("main").style.display=show?"none":"block";
}

function logout(){ signOut(auth); }

/* USER SETUP */
async function checkUser(user){
  const snap=await getDocs(playersRef);
  let exists=false;
  snap.forEach(d=>{ if(d.data().uid===user.uid) exists=true;});
  if(!exists){
    await addDoc(playersRef,{
      uid:user.uid,
      name:user.email,
      points:0,
      totalHours:0,
      badges:[]
    });
  }
}

/* ADD STUDY */
window.addStudy=async()=>{
  const h=parseInt(hours.value);
  if(!h)return alert("Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù…");
  const snap=await getDocs(playersRef);
  snap.forEach(async d=>{
    if(d.data().uid===auth.currentUser.uid){
      let data=d.data();
      let total=data.totalHours+h;
      let points=data.points+h*10;
      let badges=data.badges||[];

      if(total>=10 && !badges.includes("10 Ø³Ø§Ø¹Ø§Øª"))badges.push("10 Ø³Ø§Ø¹Ø§Øª");
      if(total>=50 && !badges.includes("50 Ø³Ø§Ø¹Ø§Øª"))badges.push("50 Ø³Ø§Ø¹Ø§Øª");

      await updateDoc(doc(db,"players",d.id),{totalHours:total,points,badges});
    }
  });
};

/* LEADERBOARD */
function listenLeaderboard(){
  const q=query(playersRef,orderBy("points","desc"));
  onSnapshot(q,s=>{
    leaderboard.innerHTML="";
    let i=0;
    s.forEach(d=>{
      i++;
      let div=document.createElement("div");
      div.className="player";
      if(i===1)div.classList.add("first");
      div.innerHTML=`${i}. ${d.data().name} - ${d.data().points} Ù†Ù‚Ø·Ø©`;
      leaderboard.appendChild(div);
    });
  });
}

/* ROOM */
window.createRoom=async()=>{
  const name=roomName.value;
  if(!name)return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…");
  const room=await addDoc(roomsRef,{
    name,
    members:[auth.currentUser.uid],
    live:{},
    pomodoroEnd:null
  });
  alert("Room ID: "+room.id);
};

window.joinRoom=async()=>{
  currentRoomId=joinRoomId.value;
  if(!currentRoomId)return alert("Ø§Ø¯Ø®Ù„ ID");
  roomArea.style.display="block";
  roomTitle.innerText="Room: "+currentRoomId;
  listenRoom();
};

function listenRoom(){
  const roomDoc=doc(db,"rooms",currentRoomId);
  onSnapshot(roomDoc,s=>{
    const data=s.data();
    if(!data)return;
    roomMembers.innerHTML="";
    if(data.live){
      Object.keys(data.live).forEach(uid=>{
        let div=document.createElement("div");
        div.className="player";
        div.innerText=uid+" "+(data.live[uid].studying?"ğŸ“š":"â¸");
        roomMembers.appendChild(div);
      });
    }
    if(data.pomodoroEnd){
      runTimer(data.pomodoroEnd);
    }
  });
}

/* PRESENCE */
window.toggleStudy=async()=>{
  studying=!studying;
  await updateDoc(doc(db,"rooms",currentRoomId),{
    [`live.${auth.currentUser.uid}`]:{
      studying,
      time:Date.now()
    }
  });
};

/* POMODORO */
window.startPomodoro=async()=>{
  const end=Date.now()+25*60*1000;
  await updateDoc(doc(db,"rooms",currentRoomId),{
    pomodoroEnd:end
  });
};

function runTimer(end){
  if(localTimer)clearInterval(localTimer);
  localTimer=setInterval(()=>{
    let diff=end-Date.now();
    if(diff<=0){timer.innerText="00:00";clearInterval(localTimer);return;}
    let m=Math.floor(diff/60000);
    let s=Math.floor((diff%60000)/1000);
    timer.innerText=`${m}:${s<10?"0"+s:s}`;
  },1000);
}

</script>
</body>
</html>
