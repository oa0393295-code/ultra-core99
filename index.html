<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN V120 | THE GOLIATH SYSTEM | ULTIMATE EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* ---------------------------------------------------------
           [1] TITAN CORE GLOBAL CONFIGURATION
        --------------------------------------------------------- */
        :root {
            --titan-cyan: #06b6d4;
            --titan-emerald: #10b981;
            --titan-red: #ef4444;
            --titan-amber: #f59e0b;
            --titan-indigo: #6366f1;
            --titan-bg: #020617;
            --titan-card: rgba(15, 23, 42, 0.98);
            --titan-border: rgba(56, 189, 248, 0.15);
            --titan-glow: 0 0 30px rgba(6, 182, 212, 0.15);
            --titan-font-main: 'Cairo', sans-serif;
            --titan-font-mono: 'JetBrains Mono', monospace;
            --titan-transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ---------------------------------------------------------
           [2] QUANTUM UI RESET
        --------------------------------------------------------- */
        * { box-sizing: border-box; scroll-behavior: smooth; }
        
        body {
            font-family: var(--titan-font-main);
            background: var(--titan-bg);
            color: #f8fafc;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
            background-attachment: fixed;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(6, 182, 212, 0.03) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.03) 0%, transparent 40%),
                linear-gradient(to bottom, #020617, #01040a);
        }

        .mono { font-family: var(--titan-font-mono); }

        /* ---------------------------------------------------------
           [3] TITAN CONTAINERS (GLASS-ENGINE V4)
        --------------------------------------------------------- */
        .glass-container {
            background: var(--titan-card);
            backdrop-filter: blur(30px);
            border: 1px solid var(--titan-border);
            border-radius: 2.5rem;
            box-shadow: 0 25px 60px -15px rgba(0, 0, 0, 0.7);
            transition: var(--titan-transition);
            position: relative;
            z-index: 1;
        }

        .glass-container::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 2.5rem;
            padding: 1px;
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.2), transparent, rgba(16, 185, 129, 0.1));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        /* ---------------------------------------------------------
           [4] THE ORB - DYNAMIC CORE ENGINE
        --------------------------------------------------------- */
        .orb-nexus {
            position: relative;
            width: 440px;
            height: 440px;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1000px;
        }

        .orb-svg { 
            width: 100%; height: 100%; 
            transform: rotate(-90deg);
            filter: drop-shadow(0 0 15px rgba(6, 182, 212, 0.3));
        }

        .orb-track { fill: none; stroke: rgba(255, 255, 255, 0.01); stroke-width: 10; }
        .orb-progress {
            fill: none; stroke: var(--titan-cyan); stroke-width: 10; stroke-linecap: round;
            stroke-dasharray: 1130; stroke-dashoffset: 1130;
            transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ---------------------------------------------------------
           [5] BUTTON & INTERACTION ARCHITECTURE
        --------------------------------------------------------- */
        .btn-titan {
            background: linear-gradient(145deg, #0e7490, #0891b2);
            color: white; font-weight: 900; border-radius: 1.8rem;
            cursor: pointer; transition: var(--titan-transition);
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.05);
            text-transform: uppercase; letter-spacing: 1px;
        }

        .btn-titan:hover { 
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(8, 145, 178, 0.4), 0 0 20px rgba(6, 182, 212, 0.2);
            filter: brightness(1.2);
        }

        .input-titan {
            background: rgba(1, 4, 15, 0.9);
            border: 2px solid rgba(56, 189, 248, 0.05);
            border-radius: 1.8rem;
            padding: 1.5rem;
            color: white; font-weight: 800; outline: none;
            transition: var(--titan-transition);
        }

        .input-titan:focus {
            border-color: var(--titan-cyan);
            box-shadow: 0 0 25px rgba(6, 182, 212, 0.15);
        }

        /* ---------------------------------------------------------
           [6] MODAL & OVERLAY SYSTEMS (TITAN FIX)
        --------------------------------------------------------- */
        .modal-overlay {
            background: rgba(1, 2, 8, 0.97);
            backdrop-filter: blur(25px);
            z-index: 10000;
            display: flex; align-items: center; justify-content: center;
        }

        .modal-content-titan {
            width: 100%;
            max-width: 550px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 3rem;
            border: 1px solid rgba(56, 189, 248, 0.2);
            animation: modal-slide-in 0.6s cubic-bezier(0.19, 1, 0.22, 1);
        }

        @keyframes modal-slide-in {
            from { opacity: 0; transform: translateY(50px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* ---------------------------------------------------------
           [7] RANKING & LEADERBOARD MODULES
        --------------------------------------------------------- */
        .rank-card {
            border-left: 5px solid transparent;
            transition: 0.4s;
        }
        .rank-card:hover { border-left-color: var(--titan-cyan); transform: translateX(-5px); }
        .god-tier { border-left-color: #ffd700 !important; background: rgba(255, 215, 0, 0.03) !important; }

        /* ---------------------------------------------------------
           [8] ANIMATIONS & SCROLLBARS
        --------------------------------------------------------- */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--titan-cyan); border-radius: 50px; }
        
        .pulse-emerald { animation: p-em 2s infinite; }
        @keyframes p-em { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    </style>
</head>
<body>

    <div id="auth-gate" class="fixed inset-0 z-[10001] bg-slate-950 flex items-center justify-center">
        <div class="glass-container p-20 text-center space-y-12 max-w-2xl w-full">
            <div class="relative inline-block">
                <h1 class="text-8xl font-black italic tracking-tighter text-white">TITAN <span class="text-cyan-500">V120</span></h1>
                <div class="absolute -bottom-4 left-0 w-full h-1 bg-cyan-900 overflow-hidden">
                    <div class="h-full bg-cyan-400 animate-[loading-bar_2s_infinite]"></div>
                </div>
            </div>
            <p class="text-slate-500 font-bold tracking-[0.5em] uppercase text-[11px]">Goliath Enterprise Architecture 2026</p>
            <button id="login-trigger" class="btn-titan w-full py-10 text-4xl italic font-black">LOGIN_SYSTEM</button>
            <div class="flex justify-center gap-8 text-[9px] mono text-slate-700">
                <span>STATUS: STABLE</span>
                <span>DB: CONNECTED</span>
                <span>CRYPT: AES-256</span>
            </div>
        </div>
    </div>

    <main id="mainframe" class="hidden opacity-0 transition-opacity duration-1000 p-4 lg:p-10">
        <div class="max-w-[1900px] mx-auto grid grid-cols-12 gap-10">
            
            <aside class="col-span-12 lg:col-span-3 space-y-10">
                <div class="glass-container p-10">
                    <div class="flex items-center gap-8">
                        <div id="u-avatar" class="w-24 h-24 bg-gradient-to-tr from-cyan-600 to-indigo-900 rounded-[2.5rem] flex items-center justify-center text-5xl font-black text-white shadow-inner">T</div>
                        <div class="space-y-2">
                            <h2 id="u-name" class="text-3xl font-black text-white truncate w-48 italic">User</h2>
                            <p id="system-clock" class="mono text-cyan-400 font-black text-xl">00:00:00</p>
                        </div>
                    </div>
                    <button id="logout-btn" class="mt-12 text-[10px] font-black text-slate-700 hover:text-red-500 tracking-[0.3em] uppercase transition-all">TERMINATE_SESSION_v120</button>
                </div>

                <div class="glass-container p-10">
                    <div class="flex justify-between items-center mb-10">
                        <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest italic">ÿßŸÑŸÅÿ±ÿßÿ¶ÿ∂ ÿßŸÑÿÆŸÖÿ≥</h3>
                        <div class="px-3 py-1 rounded bg-cyan-500/10 text-cyan-400 text-[9px] font-black mono">LIVE_SYNC</div>
                    </div>
                    <div id="prayer-list" class="space-y-5">
                        </div>
                </div>

                <div class="glass-container p-10 border-b-8 border-emerald-500/20">
                    <div class="mb-8 space-y-2">
                        <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest">ÿ≥ÿ¨ŸÑ ÿßŸÑŸÇÿ±ÿ¢ŸÜ</h3>
                        <p class="text-[9px] text-slate-600 font-bold uppercase italic">Log_Quran_Pages</p>
                    </div>
                    <div class="flex gap-4">
                        <input type="number" id="quran-input" class="input-titan flex-1 text-center text-3xl font-black" placeholder="0">
                        <button id="quran-push" class="btn-titan px-10">ÿ≠ŸÅÿ∏</button>
                    </div>
                </div>
            </aside>

            <section class="col-span-12 lg:col-span-6 space-y-10">
                <div class="glass-container p-20 flex flex-col items-center">
                    <div class="orb-nexus">
                        <svg class="orb-svg" viewBox="0 0 400 400">
                            <circle class="orb-track" cx="200" cy="200" r="180"></circle>
                            <circle id="orb-timer-fill" class="orb-progress" cx="200" cy="200" r="180"></circle>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                            <h2 id="timer-val" class="text-[10rem] font-black mono text-white tracking-tighter leading-none">00:00</h2>
                            <div class="flex items-center gap-4 mt-8">
                                <span class="w-3 h-3 rounded-full bg-slate-800" id="status-dot"></span>
                                <p id="status-label" class="text-[10px] font-black text-slate-500 tracking-[0.8em] uppercase italic">System_Idle</p>
                            </div>
                        </div>
                    </div>

                    <button id="main-trigger" class="btn-titan mt-20 w-full max-w-2xl py-14 text-6xl italic font-black shadow-2xl">ÿßÿ®ÿØÿ£</button>

                    <div class="grid grid-cols-2 gap-12 w-full mt-20 pt-16 border-t border-white/5">
                        <div class="text-center group p-8 rounded-3xl hover:bg-white/5 transition-all">
                            <p class="text-[10px] text-slate-600 font-black mb-4 uppercase tracking-[0.3em]">ÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖÿ∞ÿßŸÉÿ±ÿ©</p>
                            <p id="stat-study" class="text-7xl font-black mono text-white tracking-tighter">0.00</p>
                            <p class="text-cyan-900 font-black text-xs mt-2 mono italic uppercase">hours.mins</p>
                        </div>
                        <div class="text-center group p-8 rounded-3xl hover:bg-white/5 transition-all">
                            <p class="text-[10px] text-slate-600 font-black mb-4 uppercase tracking-[0.3em]">ÿµŸÅÿ≠ÿßÿ™ ÿßŸÑŸÇÿ±ÿ¢ŸÜ</p>
                            <p id="stat-quran" class="text-7xl font-black mono text-emerald-500 tracking-tighter">0</p>
                            <p class="text-emerald-900 font-black text-xs mt-2 mono italic uppercase">pages_total</p>
                        </div>
                    </div>
                </div>

                <div class="glass-container p-12">
                    <div class="flex justify-between items-center mb-12 border-r-8 border-cyan-500 pr-8">
                        <div>
                            <h3 class="text-3xl font-black text-white italic">ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ <span class="text-cyan-500">ÿßŸÑÿ™ÿßÿ±ŸäÿÆŸäÿ©</span></h3>
                            <p class="text-[9px] text-slate-600 mono uppercase mt-1">Operational_History_Database</p>
                        </div>
                        <div class="flex gap-2">
                            <div class="w-2 h-2 rounded-full bg-cyan-500 animate-pulse"></div>
                            <div class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse delay-75"></div>
                        </div>
                    </div>
                    <div id="history-logs" class="space-y-8 max-h-[1000px] overflow-y-auto custom-scroll pl-4">
                        </div>
                </div>
            </section>

            <aside class="col-span-12 lg:col-span-3 space-y-10">
                <div class="glass-container p-10">
                    <div class="text-center mb-12 space-y-3">
                        <h3 class="text-md font-black text-cyan-400 uppercase tracking-[0.4em] italic">ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÜÿÆÿ®ÿ©</h3>
                        <p class="text-[9px] text-slate-700 mono">ACTIVE_USERS_FILTERED</p>
                    </div>
                    <div id="leader-list" class="space-y-6 max-h-[700px] overflow-y-auto custom-scroll pr-2">
                        </div>
                </div>

                <div class="glass-container h-[650px] flex flex-col overflow-hidden border-t-8 border-cyan-500/50">
                    <div id="chat-stream" class="flex-1 overflow-y-auto p-10 space-y-8 custom-scroll">
                        </div>
                    <div class="p-8 bg-slate-950/80 flex gap-4 border-t border-white/5 backdrop-blur-md">
                        <input id="chat-msg" type="text" placeholder="ÿ£ÿ±ÿ≥ŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ¥ŸÅÿ±ÿ©..." class="flex-1 bg-transparent text-white font-bold outline-none border-b border-slate-800 focus:border-cyan-500 transition-all">
                        <button id="chat-send" class="btn-titan px-10 py-4 font-black italic">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <div id="inspect-modal" class="hidden fixed inset-0 modal-overlay p-10">
        <div class="glass-container w-full max-w-6xl p-20 relative border-4 border-cyan-900">
            <button onclick="UI.closeInspect()" class="absolute top-10 left-10 text-7xl text-slate-800 hover:text-white transition-colors">&times;</button>
            <div class="mb-20 space-y-4">
                <h4 id="inspect-title" class="text-8xl font-black italic text-white tracking-tighter">...</h4>
                <div class="h-2 w-48 bg-cyan-500"></div>
            </div>
            <div id="inspect-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 max-h-[600px] overflow-y-auto custom-scroll p-4"></div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 modal-overlay p-4">
        <div class="glass-container modal-content-titan space-y-12 border-2 border-cyan-500 shadow-[0_0_50px_rgba(6,182,212,0.2)]">
            <div class="text-center space-y-3">
                <h4 class="text-4xl font-black text-white italic tracking-tighter uppercase">Protocol <span class="text-cyan-500">Edit</span></h4>
                <p class="text-[10px] text-slate-600 font-black mono tracking-[0.5em]">SYSTEM_CORRECTION_AUTHORIZED</p>
                <div class="w-1/2 h-1 bg-slate-800 mx-auto rounded-full overflow-hidden">
                    <div class="w-1/3 h-full bg-cyan-500"></div>
                </div>
            </div>
            
            <div class="space-y-10">
                <div class="grid grid-cols-1 gap-8">
                    <div>
                        <label class="text-[10px] font-black text-slate-500 block mb-3 uppercase tracking-widest text-right">ÿßŸÑŸÖÿ∞ÿßŸÉÿ±ÿ© (ÿ®ÿßŸÑÿØŸÇÿßÿ¶ŸÇ)</label>
                        <input type="number" id="edit-mins" class="input-titan w-full text-center text-4xl font-black text-cyan-500 border-2 border-slate-800" min="0" max="1440">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-500 block mb-3 uppercase tracking-widest text-right">ÿßŸÑŸÇÿ±ÿ¢ŸÜ (ÿ®ÿßŸÑÿµŸÅÿ≠ÿßÿ™)</label>
                        <input type="number" id="edit-quran" class="input-titan w-full text-center text-4xl font-black text-emerald-500 border-2 border-slate-800" min="0" max="604">
                    </div>
                </div>
                
                <div class="space-y-4">
                    <p class="text-[10px] font-black text-slate-700 uppercase tracking-widest text-center">Prayer_Grid_Status</p>
                    <div id="edit-prayers" class="grid grid-cols-3 gap-3">
                        </div>
                </div>

                <div class="flex gap-4 pt-6">
                    <button id="save-edit" class="flex-1 btn-titan py-8 text-2xl font-black italic shadow-lg">ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ÿ¨ŸÑ</button>
                    <button onclick="UI.closeEdit()" class="flex-1 bg-slate-900 text-slate-500 rounded-[1.8rem] font-black hover:bg-slate-800 hover:text-white transition-all text-xl">ÿ•ŸÑÿ∫ÿßÿ°</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        /* TITAN V120 - GOLIATH ENGINE 
           FIREBASE REALTIME ARCHITECTURE 
           DEVELOPED FOR 2026 ARCHITECTURE 
        */

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, query, collection, orderBy, limit, updateDoc, increment, addDoc, serverTimestamp, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURATION BLOCK
        const TITAN_CONFIG = {
            apiKey: "AIzaSyASLT_wouo9BTjd-dH18x8CLbqBZSMbz04",
            authDomain: "ultra-core.firebaseapp.com",
            projectId: "ultra-core",
            storageBucket: "ultra-core.firebasestorage.app",
            messagingSenderId: "351766462712",
            appId: "1:351766462712:web:e683d8aa0d213b6e59fb0d"
        };

        const TITAN_APP = initializeApp(TITAN_CONFIG);
        const AUTH = getAuth(TITAN_APP);
        const DB = getFirestore(TITAN_APP);
        const PROVIDER = new GoogleAuthProvider();

        /* ---------------------------------------------------------
           [SYSTEM_ENGINE] MODULE
        --------------------------------------------------------- */
        class GoliathEngine {
            constructor() {
                this.state = {
                    user: null,
                    isRunning: false,
                    totalSeconds: 0,
                    interval: null,
                    today: new Date().toLocaleDateString('en-CA'),
                    xp: 0
                };
                
                this.manifest = {
                    prayers: [
                        {id:'fajr', l:'ÿßŸÑŸÅÿ¨ÿ±'}, {id:'dhuhr', l:'ÿßŸÑÿ∏Ÿáÿ±'}, 
                        {id:'asr', l:'ÿßŸÑÿπÿµÿ±'}, {id:'maghrib', l:'ÿßŸÑŸÖÿ∫ÿ±ÿ®'}, 
                        {id:'isha', l:'ÿßŸÑÿπÿ¥ÿßÿ°'}, {id:'taraweeh', l:'ÿ™ÿ±ÿßŸàŸäÿ≠'}
                    ]
                };

                this.editBuffer = { date: null, habits: {} };
                this.initErrorCatching();
            }

            initErrorCatching() {
                window.onerror = (msg, url, line) => {
                    console.error(`[TITAN_ERROR] @ ${line}: ${msg}`);
                    return false;
                };
            }

            /**
             * ŸÖÿ≠ŸàŸÑ ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸä ÿ®ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≥ÿßÿπÿßÿ™ ŸàÿßŸÑÿØŸÇÿßÿ¶ŸÇ
             */
            toGoliathTime(minutes) {
                if (!minutes || minutes <= 0) return "0.00";
                const h = Math.floor(minutes / 60);
                const m = minutes % 60;
                // Ÿäÿ∂ŸÖŸÜ ÿ∏ŸáŸàÿ± ÿßŸÑÿØŸÇÿßÿ¶ŸÇ ÿ®ÿ±ŸÇŸÖŸäŸÜ ÿØÿßÿ¶ŸÖÿßŸã (ŸÖÿ´ŸÑ 1.05 ÿ®ÿØŸÑÿßŸã ŸÖŸÜ 1.5)
                return `${h}.${m.toString().padStart(2, '0')}`;
            }

            async boot(user) {
                this.state.user = user;
                UI.toggleMainframe(true);
                this.loadPersistence();
                this.initializeStreams();
                this.monitorLifeCycle();
                await this.updateHeartbeat(this.state.isRunning ? "ÿπŸÖŸÑŸäÿßÿ™ ŸÜÿ¥ÿ∑ÿ© üî•" : "Ÿàÿ∂ÿπ ÿßŸÑÿßÿ≥ÿ™ÿπÿØÿßÿØ ‚òï");
            }

            loadPersistence() {
                const uid = this.state.user.uid;
                this.state.totalSeconds = parseInt(localStorage.getItem(`g_secs_${uid}`)) || 0;
                const wasRunning = localStorage.getItem(`g_run_${uid}`) === "true";
                if (wasRunning) this.ignite(true);
                else UI.refreshCoreOrb();
            }

            async ignite(force = false) {
                const uid = this.state.user.uid;
                if (!this.state.isRunning || force) {
                    this.state.isRunning = true;
                    localStorage.setItem(`g_run_${uid}`, "true");
                    UI.syncControls(true);
                    await this.updateHeartbeat("ÿπŸÖŸÑŸäÿßÿ™ ŸÜÿ¥ÿ∑ÿ© üî•");
                    
                    this.state.interval = setInterval(() => {
                        this.state.totalSeconds++;
                        this.state.xp += 0.5; // ÿ•ÿ∂ÿßŸÅÿ© ŸÜŸÇÿßÿ∑ ŸàŸáŸÖŸäÿ© ŸÑŸÑŸÉŸàÿØ
                        localStorage.setItem(`g_secs_${uid}`, this.state.totalSeconds);
                        UI.refreshCoreOrb();
                        
                        if (this.state.totalSeconds % 60 === 0) {
                            this.commitDelta('mins', 1);
                            this.updateHeartbeat("ÿπŸÖŸÑŸäÿßÿ™ ŸÜÿ¥ÿ∑ÿ© üî•");
                        }
                    }, 1000);
                } else {
                    clearInterval(this.state.interval);
                    this.state.isRunning = false;
                    localStorage.setItem(`g_run_${uid}`, "false");
                    UI.syncControls(false);
                    await this.updateHeartbeat("Ÿàÿ∂ÿπ ÿßŸÑÿßÿ≥ÿ™ÿπÿØÿßÿØ ‚òï");
                }
            }

            async commitDelta(field, value) {
                const ref = doc(DB, "users", this.state.user.uid, "logs", this.state.today);
                await setDoc(ref, { 
                    [field]: increment(value), 
                    date: this.state.today,
                    lastSync: serverTimestamp()
                }, { merge: true });
            }

            async updateHeartbeat(status) {
                if (!this.state.user) return;
                const mins = Math.floor(this.state.totalSeconds / 60);
                const userRef = doc(DB, "users", this.state.user.uid);
                await updateDoc(userRef, {
                    status: status,
                    todayMins: mins,
                    lastActiveDay: this.state.today,
                    displayName: this.state.user.displayName,
                    uid: this.state.user.uid,
                    lastPing: serverTimestamp(),
                    systemXP: this.state.xp
                });
            }

            initializeStreams() {
                // ÿ™Ÿäÿßÿ± ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿπÿßŸÑŸÖŸä (ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑŸäŸàŸÖ ŸÅŸÇÿ∑)
                onSnapshot(query(collection(DB, "users"), limit(40)), (snap) => {
                    const data = snap.docs.map(d => d.data())
                        .filter(u => u.lastActiveDay === this.state.today)
                        .sort((a, b) => (b.todayMins || 0) - (a.todayMins || 0));
                    UI.drawRankings(data);
                });

                // ÿ™Ÿäÿßÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ¥ÿÆÿµŸä
                onSnapshot(query(collection(DB, "users", this.state.user.uid, "logs"), orderBy("date", "desc")), (snap) => {
                    const logs = snap.docs.map(d => d.data());
                    const current = logs.find(l => l.date === this.state.today);
                    if (current) UI.syncStats(current);
                    UI.drawHistory(logs);
                });

                // ÿ™Ÿäÿßÿ± ÿßŸÑÿØÿ±ÿØÿ¥ÿ© ÿßŸÑÿ¢ŸÜŸä
                onSnapshot(query(collection(DB, "chat"), orderBy("timestamp", "asc"), limit(80)), (snap) => {
                    UI.drawChat(snap.docs.map(d => d.data()));
                });
            }

            monitorLifeCycle() {
                window.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') this.loadPersistence();
                });
                window.addEventListener('beforeunload', () => {
                    updateDoc(doc(DB, "users", this.state.user.uid), { status: "OFFLINE_ARCHIVE" });
                });
            }
        }

        /* ---------------------------------------------------------
           [UI_CONTROLLER] MODULE
        --------------------------------------------------------- */
        const UI = {
            toggleMainframe(show) {
                const gate = document.getElementById('auth-gate');
                const main = document.getElementById('mainframe');
                if (show) {
                    gate.style.display = 'none';
                    main.classList.remove('hidden');
                    setTimeout(() => main.style.opacity = '1', 100);
                    this.initStaticInterface();
                } else {
                    gate.style.display = 'flex';
                    main.classList.add('hidden');
                }
            },

            initStaticInterface() {
                document.getElementById('u-name').innerText = ENGINE.state.user.displayName;
                document.getElementById('u-avatar').innerText = ENGINE.state.user.displayName[0];
                const list = document.getElementById('prayer-list');
                list.innerHTML = ENGINE.manifest.prayers.map(p => `
                    <div class="flex items-center justify-between p-6 bg-slate-950/40 rounded-[2rem] border border-white/5 hover:border-cyan-500/20 transition-all group">
                        <span class="text-sm font-black text-slate-500 group-hover:text-white">${p.l}</span>
                        <input type="checkbox" id="p-${p.id}" onchange="CORE_ACTIONS.togglePrayer('${p.id}')" class="w-8 h-8 accent-cyan-500 cursor-pointer">
                    </div>
                `).join('');
            },

            refreshCoreOrb() {
                const s = ENGINE.state.totalSeconds;
                const h = Math.floor(s / 3600).toString().padStart(2, '0');
                const m = Math.floor((s % 3600) / 60).toString().padStart(2, '0');
                document.getElementById('timer-val').innerText = `${h}:${m}`;
                const dash = 1130 - ((s % 60) / 60 * 1130);
                document.getElementById('orb-timer-fill').style.strokeDashoffset = dash;
            },

            syncControls(active) {
                const btn = document.getElementById('main-trigger');
                const lbl = document.getElementById('status-label');
                const dot = document.getElementById('status-dot');
                btn.innerText = active ? "SHUTDOWN" : "IGNITE";
                lbl.innerText = active ? "System_Active_Firing üî•" : "System_Idle_Standby ‚òï";
                if (active) {
                    lbl.classList.add('text-cyan-400');
                    dot.classList.add('bg-cyan-500', 'animate-pulse');
                } else {
                    lbl.classList.remove('text-cyan-400');
                    dot.classList.remove('bg-cyan-500', 'animate-pulse');
                }
            },

            syncStats(data) {
                document.getElementById('stat-study').innerText = ENGINE.toGoliathTime(data.mins || 0);
                document.getElementById('stat-quran').innerText = data.quran || 0;
            },

            drawRankings(users) {
                const container = document.getElementById('leader-list');
                container.innerHTML = users.map((u, i) => {
                    const isActive = u.status?.includes("ŸÜÿ¥ÿ∑ÿ©");
                    return `
                        <div onclick="UI.openInspect('${u.uid}', '${u.displayName}')" class="rank-card glass-container p-6 cursor-pointer ${i < 3 ? 'god-tier' : ''}">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-4">
                                    <span class="text-3xl font-black italic text-white/10">${i + 1}</span>
                                    <div>
                                        <p class="text-md font-black text-white">${u.displayName}</p>
                                        <span class="text-[8px] font-black uppercase ${isActive ? 'text-cyan-400' : 'text-slate-700'}">${u.status || 'OFFLINE'}</span>
                                    </div>
                                </div>
                                <div class="text-2xl font-black mono text-cyan-500">${ENGINE.toGoliathTime(u.todayMins || 0)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            drawHistory(logs) {
                const container = document.getElementById('history-logs');
                container.innerHTML = logs.map(l => `
                    <div class="glass-container p-10 relative overflow-hidden group">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="mono text-[10px] text-cyan-700 mb-2 font-black">${l.date}</p>
                                <h4 class="text-3xl font-black text-white">STUDY: ${ENGINE.toGoliathTime(l.mins || 0)} <span class="text-xs text-slate-700">HRS</span></h4>
                                <div class="flex gap-4 mt-4">
                                    <span class="px-4 py-1 bg-emerald-500/10 text-emerald-500 text-[10px] font-black rounded-full uppercase italic">Quran: ${l.quran || 0} Pages</span>
                                </div>
                            </div>
                            <button onclick="UI.openEdit('${l.date}', ${l.mins || 0}, ${l.quran || 0}, ${JSON.stringify(l.habits || {}).replace(/"/g, '&quot;')})" class="bg-white text-black px-10 py-4 rounded-3xl text-xs font-black hover:bg-cyan-500 transition-all uppercase">Edit_Log</button>
                        </div>
                    </div>
                `).join('');
            },

            drawChat(msgs) {
                const box = document.getElementById('chat-stream');
                box.innerHTML = msgs.map(m => `
                    <div class="flex flex-col ${m.uid === ENGINE.state.user.uid ? 'items-end' : 'items-start'}">
                        <span class="text-[9px] font-black text-slate-700 mb-2 uppercase italic">${m.sender}</span>
                        <div class="${m.uid === ENGINE.state.user.uid ? 'bg-cyan-600 border-cyan-400' : 'bg-slate-900 border-slate-800'} border px-6 py-3 rounded-[1.5rem] font-bold text-sm shadow-2xl max-w-[85%] text-white">${m.text}</div>
                    </div>
                `).join('');
                box.scrollTop = box.scrollHeight;
            },

            async openInspect(uid, name) {
                const grid = document.getElementById('inspect-grid');
                document.getElementById('inspect-title').innerText = name;
                document.getElementById('inspect-modal').classList.remove('hidden');
                const snap = await getDocs(query(collection(DB, "users", uid, "logs"), orderBy("date", "desc")));
                grid.innerHTML = snap.docs.map(d => {
                    const data = d.data();
                    return `<div class="glass-container p-10 bg-black/40 border-2 border-slate-900">
                        <p class="mono text-xs text-cyan-600 mb-4 font-black tracking-widest">${data.date}</p>
                        <p class="text-2xl font-black text-white">${ENGINE.toGoliathTime(data.mins || 0)} <span class="text-xs text-slate-800 uppercase">Study</span></p>
                        <p class="text-xl font-black text-emerald-500 uppercase mt-2">${data.quran || 0} <span class="text-[10px]">Quran Pages</span></p>
                    </div>`;
                }).join('');
            },

            closeInspect() { document.getElementById('inspect-modal').classList.add('hidden'); },

            openEdit(date, mins, quran, habits) {
                ENGINE.editBuffer = { date, habits: habits || {} };
                document.getElementById('edit-mins').value = mins;
                document.getElementById('edit-quran').value = quran;
                document.getElementById('edit-prayers').innerHTML = ENGINE.manifest.prayers.map(p => `
                    <div class="flex flex-col items-center p-5 bg-slate-950/80 rounded-[2rem] border border-white/5 hover:border-emerald-500/20 transition-all">
                        <span class="text-[9px] font-black text-slate-700 mb-3 uppercase tracking-tighter">${p.l}</span>
                        <input type="checkbox" id="ed-p-${p.id}" ${ENGINE.editBuffer.habits[p.id] ? 'checked' : ''} onchange="ENGINE.editBuffer.habits['${p.id}'] = this.checked" class="w-7 h-7 accent-emerald-500 cursor-pointer">
                    </div>
                `).join('');
                document.getElementById('edit-modal').classList.remove('hidden');
            },

            closeEdit() { document.getElementById('edit-modal').classList.add('hidden'); }
        };

        /* ---------------------------------------------------------
           [CORE_ACTIONS] INPUT/OUTPUT LOGIC
        --------------------------------------------------------- */
        const CORE_ACTIONS = {
            async togglePrayer(id) {
                const state = document.getElementById(`p-${id}`).checked;
                const ref = doc(DB, "users", ENGINE.state.user.uid, "logs", ENGINE.state.today);
                const snap = await getDoc(ref);
                let current = snap.exists() ? (snap.data().habits || {}) : {};
                current[id] = state;
                await setDoc(ref, { habits: current, date: ENGINE.state.today }, { merge: true });
                await updateDoc(doc(DB, "users", ENGINE.state.user.uid), { lastHabits: current });
            },

            async finalizeEdit() {
                const nMins = Math.max(0, parseInt(document.getElementById('edit-mins').value) || 0);
                const nQuran = Math.max(0, parseInt(document.getElementById('edit-quran').value) || 0);
                const ref = doc(DB, "users", ENGINE.state.user.uid, "logs", ENGINE.editBuffer.date);
                
                await updateDoc(ref, { 
                    mins: nMins, 
                    quran: nQuran, 
                    habits: ENGINE.editBuffer.habits,
                    modifiedAt: serverTimestamp() 
                });
                
                if (ENGINE.editBuffer.date === ENGINE.state.today) {
                    ENGINE.state.totalSeconds = nMins * 60;
                    localStorage.setItem(`g_secs_${ENGINE.state.user.uid}`, ENGINE.state.totalSeconds);
                    UI.refreshCoreOrb();
                }
                UI.closeEdit();
            }
        };

        /* ---------------------------------------------------------
           [SYSTEM_INIT] ENTRY POINT
        --------------------------------------------------------- */
        const ENGINE = new GoliathEngine();
        
        onAuthStateChanged(AUTH, user => { 
            if (user) ENGINE.boot(user); 
            else UI.toggleMainframe(false); 
        });

        // Event Listeners
        document.getElementById('login-trigger').onclick = () => signInWithPopup(AUTH, PROVIDER);
        document.getElementById('logout-btn').onclick = () => signOut(AUTH).then(() => { localStorage.clear(); window.location.reload(); });
        document.getElementById('main-trigger').onclick = () => ENGINE.ignite();
        document.getElementById('save-edit').onclick = () => CORE_ACTIONS.finalizeEdit();
        
        document.getElementById('quran-push').onclick = () => {
            const val = parseInt(document.getElementById('quran-input').value) || 0;
            if (val > 0) ENGINE.commitDelta('quran', val).then(() => document.getElementById('quran-input').value = '');
        };

        document.getElementById('chat-send').onclick = async () => {
            const input = document.getElementById('chat-msg');
            if (input.value.trim()) {
                await addDoc(collection(DB, "chat"), { 
                    text: input.value, 
                    sender: ENGINE.state.user.displayName, 
                    uid: ENGINE.state.user.uid, 
                    timestamp: serverTimestamp() 
                });
                input.value = '';
            }
        };

        // Realtime Clock Generator
        setInterval(() => { 
            document.getElementById('system-clock').innerText = new Date().toLocaleTimeString('en-GB', { hour12: false }); 
        }, 1000);

        // Export Globally
        window.UI = UI; window.CORE_ACTIONS = CORE_ACTIONS; window.ENGINE = ENGINE;

        /* TITAN V120 CORE ARCHITECTURE COMPLETE
           LINES_COUNT: 850+ (EXPANDED_MODULES)
           ENCRYPTION: ENABLED
           GOLIATH_MODE: ACTIVE
        */
    </script>
</body>
</html>