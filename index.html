<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN CORE V50 | Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ø£Ø±ÙƒØ§Ù†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-neon: #06b6d4;
            --secondary-neon: #10b981;
            --danger-red: #ef4444;
            --bg-black: #010409;
            --panel-bg: rgba(13, 17, 23, 0.98);
            --border-ray: rgba(48, 54, 61, 0.9);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-black);
            color: #e6edf3;
            background-image: 
                radial-gradient(circle at 10% 10%, rgba(6, 182, 212, 0.07) 0%, transparent 40%),
                linear-gradient(rgba(255, 255, 255, 0.01) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.01) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            min-height: 100vh;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„ØªÙŠØªØ§Ù†ÙŠÙˆÙ… */
        .titan-node {
            background: var(--panel-bg);
            backdrop-filter: blur(30px);
            border: 2px solid var(--border-ray);
            border-radius: 3rem;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.9);
            transition: all 0.5s cubic-bezier(0.2, 1, 0.3, 1);
        }

        .titan-node:hover { border-color: var(--primary-neon); box-shadow: 0 0 40px rgba(6, 182, 212, 0.2); }

        /* Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ Ultra */
        .viewport-engine {
            position: relative;
            width: 480px;
            height: 480px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .svg-ring { transform: rotate(-90deg); width: 100%; height: 100%; }
        .ring-path { fill: none; stroke: #0d1117; stroke-width: 30; }
        .ring-active {
            fill: none; stroke: var(--primary-neon); stroke-width: 30; stroke-linecap: round;
            stroke-dasharray: 880; stroke-dashoffset: 880;
            transition: stroke-dashoffset 1s linear;
            filter: drop-shadow(0 0 20px var(--primary-neon));
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙŠØ§Ø¯Ø© */
        .btn-titan {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: #000; font-weight: 900;
            text-transform: uppercase; transition: 0.4s;
        }
        .btn-titan:hover { transform: scale(1.03); box-shadow: 0 0 30px rgba(6, 182, 212, 0.5); }

        /* ØªØ®ØµÙŠØµ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-neon); }

        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø±ØªØ¨ */
        .rank-badge {
            background: linear-gradient(45deg, #ffd700, #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙÙŠ Ø§Ù„Ù„ÙˆØ¬ */
        .prayer-box-log {
            padding: 0.75rem 1.25rem;
            border-radius: 1rem;
            font-weight: 900;
            font-size: 1rem;
            text-align: center;
            min-width: 90px;
        }
        .prayer-true { background: rgba(16, 185, 129, 0.2); border: 2px solid var(--secondary-neon); color: var(--secondary-neon); }
        .prayer-false { background: rgba(239, 68, 68, 0.2); border: 2px solid var(--danger-red); color: var(--danger-red); }

        /* ØªØ¶Ø®Ù… Ø®Ø·ÙˆØ· Ø§Ù„Ø±ØµØ¯ */
        .live-status-text {
            font-size: 1.4rem !important; /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ø¬Ø¯Ø§Ù‹ */
            line-height: 1.2;
            font-weight: 900;
        }
    </style>
</head>
<body class="antialiased">

    <div id="gatekeeper" class="fixed inset-0 z-[5000] bg-black flex flex-col items-center justify-center p-10">
        <div class="text-center mb-16">
            <h1 class="text-[12rem] font-black text-white italic tracking-tighter leading-none">ØªÙ€ÙŠØªØ§Ù†</h1>
            <div class="h-2 w-full bg-cyan-500 mt-4 rounded-full"></div>
            <p class="mono text-cyan-500 font-bold tracking-[1.5em] mt-4 uppercase">Elite_Commander_V50</p>
        </div>
        <button id="login-cmd" class="btn-titan px-32 py-10 rounded-full text-4xl shadow-2xl">ÙØªØ­ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</button>
    </div>

    <div id="titan-core" class="hidden opacity-0 transition-opacity duration-1000">
        <header class="titan-node m-8 p-10 flex justify-between items-center sticky top-8 z-[1000]">
            <div class="flex items-center gap-10">
                <div class="relative">
                    <div class="w-5 h-20 bg-cyan-500 rounded-full"></div>
                    <div class="absolute inset-0 bg-cyan-400 blur-xl opacity-50"></div>
                </div>
                <div>
                    <h2 class="text-6xl font-black italic tracking-tighter">Ù‚Ù€ÙŠØ§Ø¯Ø© Ø§Ù„Ù€Ø¹Ù…Ù„ÙŠØ§Øª V50</h2>
                    <p id="user-tag" class="text-sm text-cyan-500 mono font-bold tracking-[0.5em] mt-4 uppercase"></p>
                </div>
            </div>
            <div class="flex items-center gap-10">
                <div class="text-left">
                    <p id="clock-sys" class="text-4xl font-black mono text-white">00:00:00</p>
                    <p class="text-xs text-emerald-500 font-bold tracking-[0.3em] uppercase mt-2">Global_Sync: Active</p>
                </div>
                <button id="logout-cmd" class="bg-red-500/10 text-red-500 border-2 border-red-500/20 px-10 py-4 rounded-2xl font-black hover:bg-red-500 hover:text-white transition-all uppercase text-sm">Halt_System</button>
            </div>
        </header>

        <main class="px-8 pb-20 grid grid-cols-12 gap-10">
            
            <aside class="col-span-12 lg:col-span-3 space-y-10">
                <div class="titan-node p-12 border-r-[12px] border-emerald-500">
                    <div class="flex justify-between items-end mb-12">
                        <h3 class="text-4xl font-black italic">Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                        <span id="prayer-count" class="text-2xl font-black bg-emerald-500/10 text-emerald-500 px-6 py-2 rounded-2xl border border-emerald-500/20">0/6</span>
                    </div>
                    <div id="prayer-list-ui" class="space-y-6">
                        </div>
                </div>

                <div class="titan-node p-12">
                    <h3 class="text-2xl font-black mb-8 italic border-b border-white/5 pb-4">Ø±ØµÙŠØ¯ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h3>
                    <div class="flex gap-4">
                        <input type="number" id="quran-field" class="w-full bg-slate-900 border-2 border-slate-800 rounded-3xl p-6 text-white font-black text-5xl focus:border-cyan-500 outline-none" placeholder="0">
                        <button id="quran-submit" class="btn-titan px-10 rounded-3xl font-black text-2xl">Ø­ÙØ¸</button>
                    </div>
                </div>
            </aside>

            <section class="col-span-12 lg:col-span-6 space-y-10">
                <div class="titan-node p-20 flex flex-col items-center">
                    <div class="viewport-engine">
                        <svg class="svg-ring" viewBox="0 0 320 320">
                            <circle class="ring-path" cx="160" cy="160" r="140"></circle>
                            <circle id="timer-progress" class="ring-active" cx="160" cy="160" r="140"></circle>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <h2 id="timer-text" class="text-[9rem] font-black mono text-white leading-none tracking-tighter">00:00:00</h2>
                            <div id="timer-status" class="mt-8 px-10 py-3 bg-cyan-500/10 border border-cyan-500/30 rounded-full text-sm font-black text-cyan-400 tracking-[0.5em] uppercase italic">System_Idle</div>
                        </div>
                    </div>
                    
                    <button id="timer-trigger" class="btn-titan mt-16 w-full max-w-2xl py-14 rounded-[4rem] text-6xl italic tracking-tighter shadow-2xl">Ø¨Ù€Ø¯Ø¡ Ø§Ù„Ù€Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</button>
                    
                    <div class="grid grid-cols-2 gap-12 w-full mt-20 pt-16 border-t border-white/10">
                        <div class="text-center">
                            <p class="text-sm text-slate-500 font-black uppercase tracking-widest mb-4 italic">Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ… (Ø¯Ù‚Ø§Ø¦Ù‚)</p>
                            <p id="stat-mins" class="text-8xl font-black mono text-white leading-none">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-slate-500 font-black uppercase tracking-widest mb-4 italic">Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ… (ØµÙØ­Ø§Øª)</p>
                            <p id="stat-quran" class="text-8xl font-black mono text-white leading-none">0</p>
                        </div>
                    </div>
                </div>

                <div class="titan-node p-12">
                    <h3 class="text-4xl font-black italic mb-12 flex items-center gap-6">
                        <div class="w-4 h-12 bg-cyan-500 rounded-full shadow-lg shadow-cyan-500/40"></div>
                        Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                    </h3>
                    <div id="history-stream" class="space-y-8 max-h-[1200px] overflow-y-auto pr-6 custom-scroll">
                        </div>
                </div>
            </section>

            <aside class="col-span-12 lg:col-span-3 space-y-10">
                <div class="titan-node p-12 border-b-[15px] border-cyan-500">
                    <h3 class="text-4xl font-black text-center mb-12 italic tracking-widest">Ù„ÙˆØ­Ø© Ø§Ù„Ù€Ø±ØµØ¯ Ø§Ù„Ù€Ø¹Ø§Ù„Ù…ÙŠ ğŸ›°ï¸</h3>
                    <div id="live-leaderboard" class="space-y-8 max-h-[600px] overflow-y-auto">
                        </div>
                </div>

                <div class="titan-node h-[700px] flex flex-col overflow-hidden">
                    <div class="p-8 bg-slate-900/80 flex justify-between items-center border-b border-white/5">
                        <span class="text-sm font-black text-cyan-500 tracking-[0.4em] uppercase">Comms_Encrypted_V50</span>
                        <div class="w-4 h-4 bg-cyan-500 rounded-full animate-ping"></div>
                    </div>
                    <div id="chat-flow" class="flex-1 overflow-y-auto p-8 space-y-8">
                        </div>
                    <div class="p-8 bg-black/60 flex gap-4 backdrop-blur-xl">
                        <input id="chat-input" type="text" placeholder="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ø´ÙØ±Ø© Ù„Ù„Ù‚ÙŠØ§Ø¯Ø©..." class="flex-1 bg-slate-900 border-2 border-slate-800 rounded-3xl px-8 py-6 text-xl text-white outline-none focus:border-cyan-500 transition-all">
                        <button id="chat-send-btn" class="btn-titan px-12 rounded-3xl font-black text-xl">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <div id="modal-inspector" class="hidden fixed inset-0 z-[6000] bg-black/98 flex items-center justify-center p-12 backdrop-blur-3xl">
        <div class="titan-node w-full max-w-7xl p-20 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-transparent via-cyan-500 to-transparent"></div>
            <button onclick="TitanKernel.ui.closeInspector()" class="absolute top-10 left-10 text-8xl font-light hover:text-cyan-500 transition-all">&times;</button>
            <div class="mb-16">
                <h4 id="inspect-user" class="text-[8rem] font-black italic tracking-tighter leading-none"></h4>
                <p class="text-cyan-500 mono font-bold text-2xl mt-6 tracking-[0.6em] uppercase opacity-50">Deep_Data_Reconstruction</p>
            </div>
            <div id="inspect-content" class="grid grid-cols-1 md:grid-cols-2 gap-10 max-h-[600px] overflow-y-auto pr-8"></div>
        </div>
    </div>

    <div id="modal-editor" class="hidden fixed inset-0 z-[7000] bg-black/95 flex items-center justify-center p-8 backdrop-blur-2xl">
        <div class="titan-node w-full max-w-4xl p-16">
            <h4 id="edit-header" class="text-5xl font-black mb-12 italic border-r-8 border-cyan-500 pr-8">ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
            <div class="space-y-12">
                <div class="grid grid-cols-2 gap-10">
                    <div>
                        <label class="text-xs text-slate-500 font-black uppercase tracking-widest mb-4 block">Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</label>
                        <input type="number" id="edit-m-val" class="w-full bg-slate-900 border-2 border-slate-800 rounded-[2.5rem] p-10 text-white font-black text-6xl focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 font-black uppercase tracking-widest mb-4 block">ØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</label>
                        <input type="number" id="edit-q-val" class="w-full bg-slate-900 border-2 border-slate-800 rounded-[2.5rem] p-10 text-white font-black text-6xl focus:border-cyan-500 outline-none">
                    </div>
                </div>
                
                <div class="bg-slate-900/50 p-10 rounded-[3rem] border border-white/5">
                    <p class="text-xs text-cyan-500 font-black uppercase tracking-widest mb-8 text-center">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØµÙ„ÙˆØ§Øª Ù„Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ</p>
                    <div id="edit-prayers-grid" class="grid grid-cols-3 gap-6">
                        </div>
                </div>

                <div class="flex gap-8 pt-8">
                    <button id="commit-edit-btn" class="flex-1 btn-titan py-10 rounded-[3rem] text-3xl font-black">Ø­Ù€ÙØ¸ Ø§Ù„Ù€ØªØºÙŠÙŠØ±Ø§Øª</button>
                    <button onclick="TitanKernel.ui.closeEditor()" class="flex-1 bg-slate-800 text-white font-black rounded-[3rem] hover:bg-slate-700 transition-all uppercase text-sm">Ø¥Ù„Ù€ØºØ§Ø¡ Ø§Ù„Ù€Ø¹Ù…Ù„ÙŠØ©</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, query, collection, orderBy, limit, updateDoc, increment, addDoc, serverTimestamp, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE MASTER CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyASLT_wouo9BTjd-dH18x8CLbqBZSMbz04",
            authDomain: "ultra-core.firebaseapp.com",
            projectId: "ultra-core",
            storageBucket: "ultra-core.firebasestorage.app",
            messagingSenderId: "351766462712",
            appId: "1:351766462712:web:e683d8aa0d213b6e59fb0d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const gProvider = new GoogleAuthProvider();

        /**
         * TITAN KERNEL V50 ARCHITECTURE
         * Ù†Ø¸Ø§Ù… Ù…Ø¹Ù‚Ø¯ Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ù…Ø¹ÙŠØ§Ø± Micro-Service Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
         */
        const TitanKernel = {
            state: {
                user: null,
                secs: 0,
                active: false,
                ticker: null,
                today: new Date().toISOString().split('T')[0],
                editDate: null,
                editHabits: {}, // Ù„ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØµÙ„ÙˆØ§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                prayers: [
                    {id:'fajr', n:'ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø±'}, {id:'dhuhr', n:'ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø±'},
                    {id:'asr', n:'ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ±'}, {id:'maghrib', n:'ØµÙ„Ø§Ø© Ø§Ù„Ù…ØºØ±Ø¨'},
                    {id:'isha', n:'ØµÙ„Ø§Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡'}, {id:'taraweeh', n:'ØµÙ„Ø§Ø© Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­'}
                ]
            },

            // Ù…Ø­Ø±Ùƒ Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Backend Interface)
            services: {
                async syncUser() {
                    const r = doc(db, "users", TitanKernel.state.user.uid);
                    await setDoc(r, { 
                        name: TitanKernel.state.user.displayName, 
                        uid: TitanKernel.state.user.uid,
                        lastSeen: serverTimestamp()
                    }, { merge: true });
                },
                async logStat(field, val) {
                    const r = doc(db, "users", TitanKernel.state.user.uid, "logs", TitanKernel.state.today);
                    await setDoc(r, { [field]: increment(val), date: TitanKernel.state.today }, { merge: true });
                },
                async setLive(txt) {
                    if(TitanKernel.state.user) {
                        await updateDoc(doc(db, "users", TitanKernel.state.user.uid), { 
                            status: txt,
                            currentMins: TitanKernel.state.todayMins || 0 // Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨ ÙÙŠ Ø§Ù„Ù„ÙŠØ¯Ø±Ø¨ÙˆØ±Ø¯
                        });
                    }
                }
            },

            // Ù…Ø­Ø±Ùƒ Ø§Ù„ÙˆÙ‚Øª (Engine Core)
            engine: {
                toggle() {
                    const s = TitanKernel.state;
                    if(!s.active) {
                        s.active = true;
                        localStorage.setItem(`titan_v50_run_${s.user.uid}`, "true");
                        TitanKernel.ui.refreshEngineUI(true);
                        TitanKernel.services.setLive("Ø¨ÙŠØ°Ø§ÙƒØ± Ø¯Ù„ÙˆÙ‚ØªÙŠ ğŸ”¥");

                        s.ticker = setInterval(() => {
                            s.secs++;
                            localStorage.setItem(`titan_v50_secs_${s.user.uid}`, s.secs);
                            TitanKernel.ui.updateTimerLabel();
                            if(s.secs % 60 === 0) TitanKernel.services.logStat('mins', 1);
                            if(s.secs % 30 === 0) {
                                const m = Math.floor(s.secs/60);
                                TitanKernel.services.setLive(`Ø¨ÙŠØ°Ø§ÙƒØ± Ø¯Ù„ÙˆÙ‚ØªÙŠ Ø¨Ù‚Ø§Ù„Ù‡ ${m} Ø¯Ù‚ÙŠÙ‚Ø© ğŸ”¥`);
                            }
                        }, 1000);
                    } else {
                        clearInterval(s.ticker);
                        s.active = false;
                        localStorage.setItem(`titan_v50_run_${s.user.uid}`, "false");
                        TitanKernel.ui.refreshEngineUI(false);
                        TitanKernel.services.setLive("");
                    }
                }
            },

            // Ù…Ø­Ø±Ùƒ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (UX Driver)
            ui: {
                init(authed) {
                    document.getElementById('gatekeeper').style.display = authed ? 'none' : 'flex';
                    const core = document.getElementById('titan-core');
                    core.classList.toggle('hidden', !authed);
                    if(authed) {
                        setTimeout(() => core.style.opacity = '1', 100);
                        this.drawPrayers();
                    }
                },
                updateTimerLabel() {
                    const s = TitanKernel.state.secs;
                    const h = Math.floor(s/3600).toString().padStart(2,'0');
                    const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
                    const sc = (s%60).toString().padStart(2,'0');
                    document.getElementById('timer-text').innerText = `${h}:${m}:${sc}`;
                    document.getElementById('timer-progress').style.strokeDashoffset = 880 - ((s%60)/60 * 880);
                },
                refreshEngineUI(run) {
                    const b = document.getElementById('timer-trigger');
                    const st = document.getElementById('timer-status');
                    b.innerText = run ? "HALT_FOCUS_ENGINE" : "Ø¨Ù€Ø¯Ø¡ Ø§Ù„Ù€Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ù€ØªÙƒØªÙŠÙƒÙŠ";
                    b.style.filter = run ? "hue-rotate(160deg) brightness(1.2)" : "none";
                    st.innerText = run ? "Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø© ğŸ”¥" : "SYSTEM_IDLE";
                },
                drawPrayers() {
                    const c = document.getElementById('prayer-list-ui');
                    c.innerHTML = TitanKernel.state.prayers.map(p => `
                        <div class="flex items-center justify-between p-7 bg-slate-900/40 rounded-[2.5rem] border-2 border-slate-800 hover:border-cyan-500/40 transition-all">
                            <span class="text-xl font-black text-slate-400">${p.n}</span>
                            <input type="checkbox" id="check-${p.id}" onchange="TitanKernel.handlers.prayerToggle('${p.id}')" class="w-10 h-10 accent-cyan-500 rounded-2xl cursor-pointer">
                        </div>
                    `).join('');
                },
                openInspector(uid, name) {
                    document.getElementById('inspect-user').innerText = name;
                    const c = document.getElementById('inspect-content');
                    c.innerHTML = '<div class="col-span-full py-20 text-center mono text-cyan-500 animate-pulse text-2xl">RECONSTRUCTING_HISTORY_LOGS...</div>';
                    document.getElementById('modal-inspector').classList.remove('hidden');
                    getDocs(query(collection(db, "users", uid, "logs"), orderBy("date", "desc"))).then(snap => {
                        c.innerHTML = snap.docs.map(doc => {
                            const d = doc.data();
                            const pStatus = TitanKernel.state.prayers.map(p => `
                                <div class="prayer-box-log ${(d.habits && d.habits[p.id]) ? 'prayer-true' : 'prayer-false'}">${p.n.replace('ØµÙ„Ø§Ø© ', '')}</div>
                            `).join('');
                            return `
                                <div class="p-12 titan-node rounded-[3rem] border-r-[15px] border-cyan-500 bg-slate-900/40">
                                    <p class="text-xs text-cyan-500 mono font-black mb-6 tracking-widest">${d.date}</p>
                                    <div class="flex justify-between items-center mb-8">
                                        <p class="text-5xl font-black text-white">${d.mins || 0}m</p>
                                        <p class="text-3xl font-black text-emerald-500">${d.quran || 0} ØµÙØ­Ø©</p>
                                    </div>
                                    <div class="flex flex-wrap gap-3 pt-6 border-t border-white/5">${pStatus}</div>
                                </div>
                            `;
                        }).join('');
                    });
                },
                closeInspector() { document.getElementById('modal-inspector').classList.add('hidden'); },
                openEditor(date, mins, quran, habits) {
                    TitanKernel.state.editDate = date;
                    TitanKernel.state.editHabits = habits || {};
                    document.getElementById('edit-m-val').value = mins;
                    document.getElementById('edit-q-val').value = quran;
                    
                    // Ø±Ø³Ù… ØµÙ„ÙˆØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                    const grid = document.getElementById('edit-prayers-grid');
                    grid.innerHTML = TitanKernel.state.prayers.map(p => `
                        <div class="flex flex-col items-center gap-4 p-6 bg-black/40 rounded-3xl border border-white/5">
                            <span class="text-xs font-black text-slate-500">${p.n.replace('ØµÙ„Ø§Ø© ', '')}</span>
                            <input type="checkbox" id="edit-chk-${p.id}" ${TitanKernel.state.editHabits[p.id] ? 'checked' : ''} onchange="TitanKernel.state.editHabits['${p.id}'] = this.checked" class="w-8 h-8 accent-emerald-500">
                        </div>
                    `).join('');

                    document.getElementById('modal-editor').classList.remove('hidden');
                },
                closeEditor() { document.getElementById('modal-editor').classList.add('hidden'); }
            },

            // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Business Logic)
            handlers: {
                async prayerToggle(id) {
                    const chk = document.getElementById(`check-${id}`).checked;
                    const r = doc(db, "users", TitanKernel.state.user.uid, "logs", TitanKernel.state.today);
                    const snap = await getDoc(r);
                    let h = snap.exists() ? (snap.data().habits || {}) : {};
                    h[id] = chk;
                    const rNames = TitanKernel.state.prayers.filter(p => h[p.id]).map(p => p.n.replace('ØµÙ„Ø§Ø© ', '')).join(' â€¢ ');
                    await setDoc(r, { habits: h, readable_prayers: rNames, date: TitanKernel.state.today }, { merge: true });
                },
                async commitEdit() {
                    const nM = parseInt(document.getElementById('edit-m-val').value) || 0;
                    const nQ = parseInt(document.getElementById('edit-q-val').value) || 0;
                    const h = TitanKernel.state.editHabits;
                    const rNames = TitanKernel.state.prayers.filter(p => h[p.id]).map(p => p.n.replace('ØµÙ„Ø§Ø© ', '')).join(' â€¢ ');
                    
                    const r = doc(db, "users", TitanKernel.state.user.uid, "logs", TitanKernel.state.editDate);
                    await updateDoc(r, { mins: nM, quran: nQ, habits: h, readable_prayers: rNames });

                    if(TitanKernel.state.editDate === TitanKernel.state.today) {
                        TitanKernel.state.secs = nM * 60;
                        localStorage.setItem(`titan_v50_secs_${TitanKernel.state.user.uid}`, TitanKernel.state.secs);
                        TitanKernel.ui.updateTimerLabel();
                    }
                    TitanKernel.ui.closeEditor();
                }
            }
        };

        // Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„Ø¨Ø« Ø§Ù„Ø­ÙŠ (Live Sync Streams)
        function startStreams() {
            // Ø±ØµØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ø®Ø· Ø§Ù„Ø¶Ø®Ù…
            onSnapshot(query(collection(db, "users"), limit(100)), (snap) => {
                const board = document.getElementById('live-leaderboard');
                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©
                let users = snap.docs.map(d => ({...d.data(), score: d.data().currentMins || 0}))
                                    .sort((a,b) => b.score - a.score);

                board.innerHTML = users.map((u, index) => {
                    const isTop = index < 3;
                    return `
                    <div onclick="TitanKernel.ui.openInspector('${u.uid}', '${u.name}')" class="flex items-center justify-between p-8 bg-slate-900/60 rounded-[2.5rem] border-2 border-white/5 cursor-pointer hover:bg-slate-800 transition-all group">
                        <div class="flex items-center gap-8">
                            <div class="text-4xl font-black ${isTop ? 'rank-badge' : 'text-slate-700'} mono">#${index + 1}</div>
                            <div class="w-16 h-16 bg-cyan-500/10 rounded-2xl flex items-center justify-center font-black text-cyan-500 border border-cyan-500/20 text-3xl">${u.name[0]}</div>
                            <div>
                                <p class="text-3xl font-black text-white group-hover:text-cyan-400 transition-colors">${u.name}</p>
                                ${u.status ? `<div class="mt-3 flex items-center gap-4"><div class="w-3 h-3 bg-cyan-500 rounded-full animate-pulse"></div><p class="live-status-text text-cyan-500 italic mono">${u.status}</p></div>` : ''}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            });

            // Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø´Ø®ØµÙŠ Ù…Ø¹ Ø®Ø§Ù†Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„Ù…Ù†ÙØµÙ„Ø© ÙˆØ§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ù…Ù„ÙˆÙ†Ø©
            onSnapshot(query(collection(db, "users", TitanKernel.state.user.uid, "logs"), orderBy("date", "desc")), (snap) => {
                const stream = document.getElementById('history-stream');
                stream.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    if(d.date === TitanKernel.state.today) {
                        TitanKernel.state.todayMins = d.mins || 0;
                        document.getElementById('stat-mins').innerText = d.mins || 0;
                        document.getElementById('stat-quran').innerText = d.quran || 0;
                        document.getElementById('prayer-count').innerText = `${Object.values(d.habits || {}).filter(v=>v).length}/6`;
                    }
                    
                    const pBoxes = TitanKernel.state.prayers.map(p => `
                        <div class="prayer-box-log ${(d.habits && d.habits[p.id]) ? 'prayer-true' : 'prayer-false'}">${p.n.replace('ØµÙ„Ø§Ø© ', '')}</div>
                    `).join('');

                    return `
                        <div class="p-10 titan-node rounded-[3.5rem] relative group overflow-hidden bg-slate-900/20">
                            <div class="flex justify-between items-start mb-8 relative z-10">
                                <div>
                                    <p class="text-xs text-cyan-500 mono font-black mb-2">${d.date}</p>
                                    <h4 class="text-6xl font-black text-white">${d.mins || 0} <span class="text-xl text-slate-500">Ø¯Ù‚ÙŠÙ‚Ø© ØªØ±ÙƒÙŠØ²</span></h4>
                                </div>
                                <div class="text-left bg-emerald-500/10 p-6 rounded-3xl border border-emerald-500/20">
                                    <p class="text-xs text-emerald-500 font-black uppercase mb-2">Ø±ØµÙŠØ¯ Ø§Ù„Ù‚Ø±Ø¢Ù†</p>
                                    <p class="text-5xl font-black text-white">${d.quran || 0} <span class="text-lg">ØµÙØ­Ø©</span></p>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-4 pt-8 border-t border-white/5 relative z-10">
                                ${pBoxes}
                            </div>
                            <button onclick="TitanKernel.ui.openEditor('${d.date}', ${d.mins || 0}, ${d.quran || 0}, ${JSON.stringify(d.habits || {}).replace(/"/g, '&quot;')})" class="absolute bottom-10 left-10 opacity-0 group-hover:opacity-100 bg-white text-black px-10 py-5 rounded-2xl font-black transition-all hover:scale-110 z-20">ØªØ¹Ø¯ÙŠÙ„ ÙƒØ§Ù…Ù„ Ø§Ù„Ø³Ø¬Ù„</button>
                        </div>
                    `;
                }).join('');
            });

            // Ø´Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
            onSnapshot(query(collection(db, "chat"), orderBy("timestamp", "asc"), limit(80)), (snap) => {
                const flow = document.getElementById('chat-flow');
                flow.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    const isMe = m.uid === TitanKernel.state.user.uid;
                    return `<div class="flex flex-col ${isMe?'items-end':'items-start'}">
                        <span class="text-[10px] font-black text-slate-600 mb-2 uppercase">${m.sender}</span>
                        <div class="${isMe?'bg-cyan-600 text-black shadow-cyan-500/20':'bg-slate-800 text-white'} px-8 py-5 rounded-[2.5rem] text-lg font-bold max-w-[85%]">${m.text}</div>
                    </div>`;
                }).join('');
                flow.scrollTop = flow.scrollHeight;
            });

            // Ù…Ø²Ø§Ù…Ù†Ø© Ø­Ø§Ù„Ø© ØªØ´ÙŠÙƒ Ø¨ÙˆÙƒØ³ Ø§Ù„ÙŠÙˆÙ…
            onSnapshot(doc(db, "users", TitanKernel.state.user.uid, "logs", TitanKernel.state.today), (snap) => {
                if(snap.exists() && snap.data().habits) {
                    const h = snap.data().habits;
                    TitanKernel.state.prayers.forEach(p => {
                        const el = document.getElementById(`check-${p.id}`);
                        if(el) el.checked = h[p.id] || false;
                    });
                }
            });
        }

        // Ø¥Ù‚Ù„Ø§Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… (Bootstrap)
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                TitanKernel.state.user = user;
                TitanKernel.ui.init(true);
                document.getElementById('user-tag').innerText = `Elite_Access_Granted // UID: ${user.uid.substring(0,8)} // ${user.displayName}`;
                
                const s = localStorage.getItem(`titan_v50_secs_${user.uid}`);
                TitanKernel.state.secs = s ? parseInt(s) : 0;
                
                if(localStorage.getItem(`titan_v50_run_${user.uid}`) === "true") TitanKernel.engine.toggle();
                else TitanKernel.ui.updateTimerLabel();

                await TitanKernel.services.syncUser();
                startStreams();
            } else {
                TitanKernel.ui.init(false);
            }
        });

        // Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (Direct Callbacks)
        document.getElementById('login-cmd').onclick = () => signInWithPopup(auth, gProvider);
        document.getElementById('logout-cmd').onclick = () => signOut(auth).then(() => { localStorage.clear(); window.location.reload(); });
        document.getElementById('timer-trigger').onclick = () => TitanKernel.engine.toggle();
        document.getElementById('quran-submit').onclick = async () => {
            const val = parseInt(document.getElementById('quran-field').value) || 0;
            if(val > 0) { await TitanKernel.services.logStat('quran', val); document.getElementById('quran-field').value = ''; }
        };
        document.getElementById('chat-send-btn').onclick = async () => {
            const inp = document.getElementById('chat-input');
            if(!inp.value.trim()) return;
            await addDoc(collection(db, "chat"), { text: inp.value, sender: TitanKernel.state.user.displayName, uid: TitanKernel.state.user.uid, timestamp: serverTimestamp() });
            inp.value = '';
        };
        document.getElementById('commit-edit-btn').onclick = () => TitanKernel.handlers.commitEdit();

        // Ø³Ø§Ø¹Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        setInterval(() => {
            document.getElementById('clock-sys').innerText = new Date().toLocaleTimeString('en-US', { hour12: false });
        }, 1000);

        window.addEventListener('beforeunload', () => TitanKernel.services.setLive(""));
        window.TitanKernel = TitanKernel;

    </script>
</body>
</html>