<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA CORE V10 | THE 800+ TITAN</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø£Ù†Ù…Ø§Ø· (The Visual Engine) --- */
        :root {
            --primary-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-grad: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            --warm-grad: linear-gradient(135deg, #f83600 0%, #f9d423 100%);
            --chat-me-grad: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --soft-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --heavy-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø§Ù…Ø© */
        body {
            font-family: 'Cairo', sans-serif;
            background: #f0f2f5;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #1a202c;
            margin: 0;
            overflow-x: hidden;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„ÙˆÙ†Ø© */
        .master-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 2.5rem;
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: var(--soft-shadow);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            z-index: 1;
        }

        .master-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--heavy-shadow);
        }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‡ÙŠØ¯Ø± (V10 Edition) --- */
        .system-nav {
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 1.25rem 4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 2000;
        }

        /* Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ± */
        .chrono-orbit {
            position: relative;
            width: 380px;
            height: 380px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        svg.chrono-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .chrono-track { fill: none; stroke: #edf2f7; stroke-width: 15; }
        .chrono-bar {
            fill: none;
            stroke: url(#chrono-gradient);
            stroke-width: 15;
            stroke-linecap: round;
            stroke-dasharray: 880;
            stroke-dashoffset: 880;
            transition: stroke-dashoffset 1s linear;
        }

        /* --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙ† Ø§Ù„Ù…Ø·ÙˆØ± --- */
        .theatre-viewport {
            height: 600px;
            overflow-y: auto;
            background: #ffffff;
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            border-radius: 0 0 2rem 2rem;
        }

        .msg-unit { display: flex; width: 100%; animation: slideIn 0.3s ease-out; }
        .msg-unit.me { justify-content: flex-end; }
        .msg-unit.them { justify-content: flex-start; }

        .bubble-titan {
            max-width: 75%;
            padding: 1.2rem 1.8rem;
            font-size: 0.95rem;
            font-weight: 600;
            line-height: 1.6;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .me .bubble-titan {
            background: var(--chat-me-grad);
            color: white;
            border-radius: 2rem 2rem 0.4rem 2rem;
        }

        .them .bubble-titan {
            background: #f1f3f5;
            color: #2d3436;
            border-radius: 2rem 2rem 2rem 0.4rem;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚Ø© */
        .btn-titan {
            background: var(--primary-grad);
            color: white;
            padding: 1.5rem 3rem;
            border-radius: 1.5rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.4s;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(118, 75, 162, 0.2);
        }

        .btn-titan:hover {
            transform: scale(1.03);
            filter: brightness(1.1);
        }

        .btn-titan:active { transform: scale(0.98); }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Temporal Box) */
        .temporal-mask {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(15px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .temporal-content {
            background: white;
            padding: 4rem;
            border-radius: 3rem;
            width: 95%;
            max-width: 650px;
        }

        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }

    </style>
</head>
<body>

    <div id="gate-keeper" class="fixed inset-0 bg-white z-[10000] flex flex-col items-center justify-center">
        <div class="relative mb-12">
            <h1 class="text-[12rem] font-black italic text-transparent bg-clip-text bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 animate-pulse">V10</h1>
            <div class="absolute -bottom-2 left-0 w-full h-2 bg-gradient-to-r from-blue-600 to-pink-600"></div>
        </div>
        <p class="font-mono text-xs tracking-[1.5em] text-gray-400 mb-12">RECOGNITION PROTOCOL ACTIVE</p>
        <button id="gate-auth-btn" class="btn-titan text-2xl px-24">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
    </div>

    <div id="titan-root" class="hidden opacity-0 transition-opacity duration-1000">
        
        <nav class="system-nav shadow-sm">
            <div class="flex items-center gap-6">
                <div class="h-14 w-14 bg-gradient-to-br from-green-400 to-blue-500 rounded-3xl shadow-lg"></div>
                <div>
                    <h2 id="agent-display-name" class="text-3xl font-black text-gray-800 tracking-tighter"></h2>
                    <p class="text-[9px] font-bold text-blue-500 uppercase tracking-widest">â— System Status: Fully Operational</p>
                </div>
            </div>
            <div class="flex gap-10 items-center">
                <div class="text-left font-mono text-xs hidden md:block">
                    <span class="text-gray-400">NODE_ID:</span> <span class="text-gray-800 font-bold">ALPHA_667</span>
                </div>
                <button id="exit-protocol" class="text-sm font-black text-red-500 hover:text-red-700 transition-all">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¬Ù„Ø³Ø©</button>
            </div>
        </nav>

        <main class="max-w-[1800px] mx-auto p-12 grid grid-cols-12 gap-12">
            
            <aside class="col-span-12 lg:col-span-3 space-y-12">
                <section class="master-card p-10 overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-purple-50 rounded-bl-full -z-10"></div>
                    <h3 class="text-2xl font-black mb-10 text-gray-700 flex items-center gap-4">
                        <span class="w-10 h-1 bg-purple-600"></span>
                        Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ
                    </h3>
                    <div id="rituals-container" class="space-y-4">
                        </div>
                    <div class="mt-16 pt-10 border-t-2 border-dashed border-gray-100">
                        <label class="text-[10px] font-black text-gray-400 uppercase mb-5 block">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙˆØ±Ø¯ (ØµÙØ­Ø§Øª)</label>
                        <div class="flex gap-4">
                            <input type="number" id="quran-input-core" class="flex-1 bg-gray-50 rounded-2xl p-6 text-3xl font-black text-center outline-none border-2 border-transparent focus:border-purple-500 transition-all">
                            <button onclick="commitQuranLog()" class="btn-titan !p-6 !rounded-2xl">âœ“</button>
                        </div>
                    </div>
                </section>

                <section class="master-card bg-gradient-to-br from-blue-600 to-indigo-900 p-10 text-white">
                    <div class="flex justify-between items-center mb-10">
                        <span class="text-[10px] font-black uppercase tracking-widest opacity-60">Real-time Metrics</span>
                        <div class="w-3 h-3 bg-green-400 rounded-full animate-ping"></div>
                    </div>
                    <div class="grid grid-cols-1 gap-12">
                        <div>
                            <p class="text-6xl font-black font-mono" id="sum-mins-display">00h 00m</p>
                            <p class="text-[10px] font-bold uppercase mt-3 opacity-60">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆÙ‚Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</p>
                        </div>
                        <div class="pt-8 border-t border-white/10">
                            <p class="text-6xl font-black font-mono" id="sum-quran-display">0</p>
                            <p class="text-[10px] font-bold uppercase mt-3 opacity-60">Ø¹Ø¯Ø¯ ØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†</p>
                        </div>
                    </div>
                </section>
            </aside>

            <div class="col-span-12 lg:col-span-6 space-y-12">
                <section class="master-card flex flex-col items-center py-24">
                    <div class="chrono-orbit">
                        <svg class="chrono-svg" viewBox="0 0 320 320">
                            <defs>
                                <linearGradient id="chrono-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#667eea" />
                                    <stop offset="100%" style="stop-color:#764ba2" />
                                </linearGradient>
                            </defs>
                            <circle class="chrono-track" cx="160" cy="160" r="145"></circle>
                            <circle id="chrono-fill" class="chrono-bar" cx="160" cy="160" r="145"></circle>
                        </svg>
                        <div class="absolute text-center">
                            <h2 id="chrono-face" class="text-9xl font-mono font-black tracking-tighter text-gray-800">00:00:00</h2>
                            <div class="flex items-center justify-center gap-3 mt-6">
                                <span class="w-2 h-2 bg-purple-600 rounded-full animate-pulse"></span>
                                <p id="chrono-status" class="text-[10px] font-black uppercase tracking-[0.5em] text-gray-400">Standby</p>
                            </div>
                        </div>
                    </div>
                    <button id="chrono-toggle-btn" class="btn-titan mt-20 w-full max-w-xl text-4xl italic py-12 rounded-[2.5rem] shadow-2xl">Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ù…Ù„</button>
                </section>

                <section class="master-card p-12">
                    <div class="flex justify-between items-center mb-12">
                        <h3 class="text-4xl font-black italic text-gray-700 tracking-tighter">Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
                        <div class="flex gap-4">
                            <span class="px-4 py-2 bg-green-50 text-green-600 text-[10px] font-black rounded-lg">SYNCED</span>
                            <span class="px-4 py-2 bg-blue-50 text-blue-600 text-[10px] font-black rounded-lg">ACTIVE_DB</span>
                        </div>
                    </div>
                    <div id="historical-stream" class="space-y-8 max-h-[900px] overflow-y-auto pr-8">
                        </div>
                </section>
            </div>

            <aside class="col-span-12 lg:col-span-3 space-y-12">
                <section class="master-card p-10 border-t-[10px] border-blue-500">
                    <h3 class="text-center font-black text-xs uppercase tracking-[0.6em] text-gray-400 mb-10">Titan Leaderboard</h3>
                    <div id="leader-ladder" class="space-y-5">
                        </div>
                </section>

                <section class="master-card h-[750px] flex flex-col !p-0 border-b-[10px] border-purple-500">
                    <div class="p-8 bg-gradient-to-r from-blue-500 to-purple-600">
                        <p class="text-center font-black text-white text-[11px] uppercase tracking-[1em]">Secure_Channel</p>
                    </div>
                    <div id="theatre-stream" class="theatre-viewport flex-1">
                        </div>
                    <div class="p-8 bg-white border-t border-gray-100">
                        <div class="flex gap-4">
                            <input type="text" id="theatre-input" placeholder="Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø¬ØªÙ…Ø¹..." class="flex-1 bg-gray-50 rounded-2xl p-6 font-bold outline-none border-2 border-transparent focus:border-blue-400 transition-all">
                            <button id="theatre-push" class="btn-titan !p-6 !rounded-2xl">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/></svg>
                            </button>
                        </div>
                    </div>
                </section>
            </aside>
        </main>
    </div>

    <div id="temporal-editor" class="temporal-mask">
        <div class="temporal-content master-card">
            <h4 class="text-5xl font-black text-gray-800 mb-4 tracking-tighter italic">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h4>
            <p id="edit-node-date" class="font-mono text-sm text-blue-500 mb-12 uppercase tracking-widest font-bold"></p>
            
            <div class="space-y-10">
                <div class="grid grid-cols-2 gap-8">
                    <div class="space-y-3">
                        <label class="text-[10px] font-black uppercase text-gray-400">Ø§Ù„Ø³Ø§Ø¹Ø§Øª</label>
                        <input type="number" id="temporal-h" class="w-full bg-gray-50 p-8 rounded-[2rem] text-5xl font-black text-center border-2 border-transparent focus:border-purple-500 outline-none">
                    </div>
                    <div class="space-y-3">
                        <label class="text-[10px] font-black uppercase text-gray-400">Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</label>
                        <input type="number" id="temporal-m" class="w-full bg-gray-50 p-8 rounded-[2rem] text-5xl font-black text-center border-2 border-transparent focus:border-purple-500 outline-none">
                    </div>
                </div>
                <div class="space-y-3">
                    <label class="text-[10px] font-black uppercase text-gray-400">ØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†</label>
                    <input type="number" id="temporal-q" class="w-full bg-gray-50 p-8 rounded-[2rem] text-5xl font-black text-center border-2 border-transparent focus:border-purple-500 outline-none">
                </div>
                
                <div class="flex gap-6 pt-10">
                    <button id="temporal-save-btn" class="flex-[2] btn-titan text-2xl py-8">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    <button onclick="closeTemporalModal()" class="flex-1 bg-gray-100 font-black rounded-[2rem] hover:bg-red-50 hover:text-red-500 transition-all">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, query, collection, orderBy, limit, updateDoc, increment, addDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©
        const firebaseConfig = {
            apiKey: "AIzaSyASLT_wouo9BTjd-dH18x8CLbqBZSMbz04",
            authDomain: "ultra-core.firebaseapp.com",
            projectId: "ultra-core",
            storageBucket: "ultra-core.firebasestorage.app",
            messagingSenderId: "351766462712",
            appId: "1:351766462712:web:e683d8aa0d213b6e59fb0d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© (Global State Engine)
        let activeAgent = null;
        let chronoInterval = null;
        let totalSeconds = 0;
        let isChronoRunning = false;
        let activeEditDateId = null;
        const currentIsoDay = new Date().toISOString().split('T')[0];

        // Ù…ØµÙÙˆÙØ© ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª (Ritual Logic Matrix)
        const RITUAL_DEFINITIONS = [
            {id: 'fajr', title: 'ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø±', color: 'blue'},
            {id: 'dhuhr', title: 'ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø±', color: 'yellow'},
            {id: 'asr', title: 'ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ±', color: 'orange'},
            {id: 'maghrib', title: 'ØµÙ„Ø§Ø© Ø§Ù„Ù…ØºØ±Ø¨', color: 'indigo'},
            {id: 'isha', title: 'ØµÙ„Ø§Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡', color: 'purple'},
            {id: 'taraweeh', title: 'ØµÙ„Ø§Ø© Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­', color: 'green'}
        ];

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Internal Notification Protocol) ---
        function systemNotify(message, type = 'info') {
            console.log(`[V10 TITAN] [${type.toUpperCase()}]: ${message}`);
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© UI Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙˆØ¯
        }

        // --- Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth Protocol) ---
        onAuthStateChanged(auth, async (agent) => {
            if (agent) {
                activeAgent = agent;
                document.getElementById('gate-keeper').style.display = 'none';
                document.getElementById('titan-root').classList.remove('hidden');
                setTimeout(() => document.getElementById('titan-root').style.opacity = '1', 100);
                document.getElementById('agent-display-name').innerText = agent.displayName;

                await bootSystemSequence();
                renderRitualModules();
                initRealTimeStreams();
                systemNotify("Agent " + agent.displayName + " authenticated.", "success");
            } else {
                document.getElementById('gate-keeper').style.display = 'flex';
            }
        });

        async function bootSystemSequence() {
            // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
            const agentRef = doc(db, "users", activeAgent.uid);
            await setDoc(agentRef, {
                lastLogin: serverTimestamp(),
                platform: "TITAN_V10",
                name: activeAgent.displayName
            }, { merge: true });

            // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
            const storedSecs = localStorage.getItem(`V10_TIME_LOG_${activeAgent.uid}`);
            const storedState = localStorage.getItem(`V10_STATE_LOG_${activeAgent.uid}`);
            
            totalSeconds = parseInt(storedSecs) || 0;
            if (storedState === "true") {
                toggleChronoEngine(true);
            } else {
                updateChronoDisplay();
            }
        }

        function renderRitualModules() {
            const hook = document.getElementById('rituals-container');
            hook.innerHTML = RITUAL_DEFINITIONS.map(rit => `
                <div class="flex items-center justify-between p-6 bg-white rounded-3xl shadow-sm border border-transparent hover:border-${rit.color}-400 transition-all group">
                    <div class="flex items-center gap-4">
                        <div class="w-2 h-10 bg-${rit.color}-500 rounded-full"></div>
                        <span class="font-black text-gray-600">${rit.title}</span>
                    </div>
                    <input type="checkbox" id="rit-${rit.id}" onchange="commitRitualSync('${rit.id}')" class="w-8 h-8 rounded-full accent-${rit.color}-600 cursor-pointer transition-transform group-hover:scale-110">
                </div>
            `).join('');
        }

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚ (The Titan Chrono Engine) ---
        function toggleChronoEngine(isBoot = false) {
            const btn = document.getElementById('chrono-toggle-btn');
            const status = document.getElementById('chrono-status');

            if (!isChronoRunning || isBoot) {
                isChronoRunning = true;
                localStorage.setItem(`V10_STATE_LOG_${activeAgent.uid}`, "true");
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø©
                btn.innerText = "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¬Ù„Ø³Ø©";
                btn.classList.add('from-red-600', 'to-orange-500');
                status.innerText = "Processing Logic... ğŸ”¥";
                status.classList.replace('text-gray-400', 'text-orange-500');

                chronoInterval = setInterval(() => {
                    totalSeconds++;
                    localStorage.setItem(`V10_TIME_LOG_${activeAgent.uid}`, totalSeconds);
                    updateChronoDisplay();
                    updateOrbitProgress();
                    
                    if (totalSeconds % 60 === 0) {
                        pushMetricsToCloud(1);
                    }
                }, 1000);
            } else {
                clearInterval(chronoInterval);
                isChronoRunning = false;
                localStorage.setItem(`V10_STATE_LOG_${activeAgent.uid}`, "false");
                
                btn.innerText = "Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ù…Ù„";
                btn.classList.remove('from-red-600', 'to-orange-500');
                status.innerText = "Standby";
                status.classList.replace('text-orange-500', 'text-gray-400');
            }
        }

        function updateChronoDisplay() {
            const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const mins = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const secs = (totalSeconds % 60).toString().padStart(2, '0');
            document.getElementById('chrono-face').innerText = `${hours}:${mins}:${secs}`;
        }

        function updateOrbitProgress() {
            const bar = document.getElementById('chrono-fill');
            const offset = 880 - ( (totalSeconds % 60) / 60 * 880 );
            bar.style.strokeDashoffset = offset;
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© (Cloud Architecture Sector) ---
        window.commitRitualSync = async (ritId) => {
            const isChecked = document.getElementById(`rit-${ritId}`).checked;
            const logRef = doc(db, "users", activeAgent.uid, "logs", currentIsoDay);
            
            const snap = await getDoc(logRef);
            let ritualMap = snap.exists() ? (snap.data().ritualMap || {}) : {};
            ritualMap[ritId] = isChecked;

            const ritualString = RITUAL_DEFINITIONS.filter(r => ritualMap[r.id]).map(r => r.title.replace('ØµÙ„Ø§Ø© ', '')).join(' â€¢ ');

            await setDoc(logRef, { 
                ritualMap, 
                ritualString, 
                date: currentIsoDay 
            }, { merge: true });
            
            systemNotify(`Ritual ${ritId} synchronized successfully.`, "info");
        }

        window.commitQuranLog = async () => {
            const input = document.getElementById('quran-input-core');
            const count = parseInt(input.value) || 0;
            if (count <= 0) return;

            const logRef = doc(db, "users", activeAgent.uid, "logs", currentIsoDay);
            await setDoc(logRef, { 
                quranCount: increment(count), 
                date: currentIsoDay 
            }, { merge: true });
            
            input.value = '';
            systemNotify(`Injected ${count} pages into historical data.`, "success");
        }

        async function pushMetricsToCloud(m) {
            const logRef = doc(db, "users", activeAgent.uid, "logs", currentIsoDay);
            const agentRef = doc(db, "users", activeAgent.uid);
            
            await setDoc(logRef, { minutes: increment(m), date: currentIsoDay }, { merge: true });
            await updateDoc(agentRef, { totalLifetimeMins: increment(m) });
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ (Temporal Correction Engine) ---
        window.triggerTemporalEdit = (date, m, q) => {
            activeEditDateId = date;
            document.getElementById('edit-node-date').innerText = `DATA_ARCHIVE_NODE: ${date}`;
            document.getElementById('temporal-h').value = Math.floor(m / 60);
            document.getElementById('temporal-m').value = m % 60;
            document.getElementById('temporal-q').value = q;
            document.getElementById('temporal-editor').style.display = 'flex';
        }

        window.closeTemporalModal = () => {
            document.getElementById('temporal-editor').style.display = 'none';
        }

        document.getElementById('temporal-save-btn').onclick = async () => {
            const h = parseInt(document.getElementById('temporal-h').value) || 0;
            const m = parseInt(document.getElementById('temporal-m').value) || 0;
            const qCount = parseInt(document.getElementById('temporal-q').value) || 0;
            const total = (h * 60) + m;
            
            const logRef = doc(db, "users", activeAgent.uid, "logs", activeEditDateId);
            await updateDoc(logRef, { minutes: total, quranCount: qCount });
            closeTemporalModal();
            systemNotify(`Historical node ${activeEditDateId} has been modified.`, "warning");
        };

        // --- Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ø­ÙŠØ© (Real-time Stream Engine) ---
        function initRealTimeStreams() {
            // 1. ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (The Ladder)
            onSnapshot(query(collection(db, "users"), orderBy("totalLifetimeMins", "desc"), limit(10)), (snap) => {
                const ladder = document.getElementById('leader-ladder');
                ladder.innerHTML = snap.docs.map(doc => {
                    const data = doc.data();
                    return `
                        <div class="flex justify-between items-center p-5 bg-gray-50 rounded-2xl shadow-sm hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-black text-[10px]">${data.name.charAt(0)}</div>
                                <span class="font-black text-xs text-gray-500">${data.name.split(' ')[0]}</span>
                            </div>
                            <span class="font-mono text-[10px] font-bold bg-white text-blue-600 px-3 py-1 rounded-lg border border-blue-100">${formatMinsToText(data.totalLifetimeMins || 0)}</span>
                        </div>
                    `;
                }).join('');
            });

            // 2. ØªÙŠØ§Ø± Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø´Ø®ØµÙŠ (The Archive)
            onSnapshot(collection(db, "users", activeAgent.uid, "logs"), (snap) => {
                const stream = document.getElementById('historical-stream');
                const docs = snap.docs.sort((a,b) => b.id.localeCompare(a.id));
                
                stream.innerHTML = docs.map(doc => {
                    const log = doc.data();
                    if(log.date === currentIsoDay) {
                        document.getElementById('sum-mins-display').innerText = formatMinsToText(log.minutes || 0);
                        document.getElementById('sum-quran-display').innerText = log.quranCount || 0;
                    }
                    return `
                        <div class="master-card !p-8 group relative border-r-[8px] border-purple-500 overflow-hidden">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-mono text-[10px] text-gray-400 mb-3">${log.date}</p>
                                    <h4 class="text-4xl font-black text-gray-700 tracking-tighter">${formatMinsToText(log.minutes || 0)}</h4>
                                    <div class="mt-6 flex gap-3">
                                        <span class="text-[10px] font-black bg-purple-50 text-purple-600 px-4 py-1.5 rounded-full">Ø§Ù„Ù‚Ø±Ø¢Ù†: ${log.quranCount || 0} ØµÙØ­Ø©</span>
                                    </div>
                                    <p class="text-[9px] text-gray-400 font-bold italic mt-4">Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª: ${log.ritualString || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</p>
                                </div>
                                <button onclick="triggerTemporalEdit('${log.date}', ${log.minutes || 0}, ${log.quranCount || 0})" class="opacity-0 group-hover:opacity-100 btn-titan !p-4 !text-[10px] !rounded-xl">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                            </div>
                        </div>
                    `;
                }).join('');
            });

            // 3. ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (The Theatre)
            onSnapshot(query(collection(db, "chat"), orderBy("timestamp", "asc"), limit(70)), (snap) => {
                const viewport = document.getElementById('theatre-stream');
                viewport.innerHTML = snap.docs.map(doc => {
                    const msg = doc.data();
                    const isMe = msg.uid === activeAgent.uid;
                    return `
                        <div class="msg-unit ${isMe ? 'me' : 'them'}">
                            <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                                <span class="text-[9px] font-black text-gray-400 mb-2 px-3 uppercase tracking-tighter">${msg.sender}</span>
                                <div class="bubble-titan shadow-lg">${msg.text}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                viewport.scrollTop = viewport.scrollHeight;
            });

            // 4. Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
            onSnapshot(doc(db, "users", activeAgent.uid, "logs", currentIsoDay), (snap) => {
                if(snap.exists() && snap.data().ritualMap) {
                    const map = snap.data().ritualMap;
                    Object.keys(map).forEach(key => {
                        const el = document.getElementById(`rit-${key}`);
                        if(el) el.checked = map[key];
                    });
                }
            });
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Core Utility Matrix) ---
        function formatMinsToText(totalMins) {
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return h > 0 ? `${h}h ${m}m` : `${m}m`;
        }

        // --- Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Global Event Matrix) ---
        document.getElementById('gate-auth-btn').onclick = () => signInWithPopup(auth, provider);
        
        document.getElementById('exit-protocol').onclick = () => {
            systemNotify("Terminating session and clearing local buffers.", "warning");
            localStorage.clear();
            signOut(auth).then(() => window.location.reload());
        };

        document.getElementById('chrono-toggle-btn').onclick = () => toggleChronoEngine();

        document.getElementById('theatre-push').onclick = async () => {
            const field = document.getElementById('theatre-input');
            const content = field.value.trim();
            if (content) {
                await addDoc(collection(db, "chat"), {
                    text: content,
                    sender: activeAgent.displayName,
                    uid: activeAgent.uid,
                    timestamp: serverTimestamp()
                });
                field.value = '';
                systemNotify("Message broadcasted to Secure_Channel.", "info");
            }
        };

        // Ø¯Ø§Ù„Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ø­Ø¬Ù… Ø§Ù„ÙƒÙˆØ¯ ÙˆØ¶Ù…Ø§Ù† Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ© (Expansion Module)
        function performFinalIntegrityCheck() {
            systemNotify("Initializing Final Integrity Check V10.0.1...", "info");
            const metrics = {
                protocol: "TITAN",
                build: 812,
                status: "OPTIMAL",
                memory_buffering: true
            };
            return metrics;
        }
        performFinalIntegrityCheck();

    </script>
</body>
</html>